---
title: "Trailing Edge vs. Persistent Forest"
author: "Joe Celebrezze"
date: "2023-11-24"
output: html_document
---

# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(segmented)
library(here)
here = here::here

source(here("scripts", "source_code.R"))

# Blue Mtns. Raster
blue.mtns.ras <- raster(here('data', 'blue_mtns_misc', 'bluemtnsras.tif'))
# Postfire Regen. Data (Davis et al)
postfire.regen <- raster(here('data', 'regen_prob', 'postfire_regen_prob.tif'))

wide.df <- read.csv(here('data', 'processed_data', 'wide.df.csv')) %>% 
  select(-X)
colnames(wide.df)[14:37] <- c(0:23)
long.df <- read.csv(here('data', 'processed_data', 'long.df.csv')) %>% 
  select(-X)
field.data.both <- read.csv(here('data', 'processed_data', 'field.data.both.csv')) %>% 
  select(-X)

# from clusters_and_eda
field.cluster.df <- read.csv(here('data', 'processed_data', 'field.cluster.df.csv'))
long.field.cluster.df <- read.csv(here('data', 'processed_data', 'long.field.cluster.df.csv'))
wide.cluster.df <- read.csv(here('data', 'processed_data', 'wide.cluster.df.csv'))

long.df.avg <- long.df %>% 
  group_by(relative_year) %>% 
  summarise(avg_nbr = mean(nbr), avg_delta_nbr = mean(yearly_delta_nbr))
```

# Data Wrangling
```{r}
main.df <- merge(wide.cluster.df, field.data.both, by = 'Plot') %>% 
  select(-Long.y, -Lat.y, -Fire) %>% 
  rename(Long = Long.x, Lat = Lat.x) %>% 
  mutate(aspect = as.numeric(aspect),
         cluster = as.factor(cluster),
         log.seedling.density = log(seedling.density),
         log.regen.density = log(regen.density)) %>% 
  mutate(log.seedling.density = ifelse(log.seedling.density < 0, 0, log.seedling.density),
         log.regen.density = ifelse(log.regen.density < 0, 0, log.regen.density)) %>%  # making any -Inf values for log.seedling.density and log.regen.density = 0
  distinct() # omitting duplicate values
```


# Trailing Edge vs. Forest
## Stats Tests
### Trailing Edge
```{r}
trailing.edge.df <- main.df %>% 
  filter(TE_future == 'Y')
```

Looking at two clusters, t-test

% Grass
```{r}
# Normal distribution?
grass.lm <- lm(data = trailing.edge.df, grass.pct ~ cluster)
plot(grass.lm)
# Equal variances?
var.test(data = trailing.edge.df, grass.pct ~ cluster) # no
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(grass.pct)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(grass.pct)
t.test(c1, c2, var.equal = F) # n.s.
```

% herb
```{r}
# Normal distribution?
herb.lm <- lm(data = trailing.edge.df, herb.pct ~ cluster)
plot(herb.lm)
# Equal variances?
var.test(data = trailing.edge.df, herb.pct ~ cluster) # no
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(herb.pct)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(herb.pct)
t.test(c1, c2, var.equal = F) # n.s.
```
**significant differences**

% shrub
```{r}
# Normal distribution?
shrub.lm <- lm(data = trailing.edge.df, shrub.pct ~ cluster)
plot(shrub.lm)
# Equal variances?
var.test(data = trailing.edge.df, shrub.pct ~ cluster) # no
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(shrub.pct)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(shrub.pct)
t.test(c1, c2, var.equal = F) # significant
```
**Significant difference**

% seedling
```{r}
# Normal distribution?
seedling.lm <- lm(data = trailing.edge.df, seedling.pct ~ cluster)
plot(seedling.lm) # NOT A NORMAL DISTRIBUTION, but hopefully central limit theorem applies (n > 30 for each group)
# Equal variances?
var.test(data = trailing.edge.df, seedling.pct ~ cluster) # yes
# T-test (Welch's)
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(seedling.pct)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(seedling.pct)
t.test(c1, c2, var.equal = T) # n.s.
```

% green
```{r}
# Normal distribution?
green.lm <- lm(data = trailing.edge.df, green.pct ~ cluster)
plot(green.lm)
# Equal variances?
var.test(data = trailing.edge.df, green.pct ~ cluster) # no
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(green.pct)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(green.pct)
t.test(c1, c2, var.equal = F) # n.s.
```

% npv
```{r}
# Normal distribution?
npv.lm <- lm(data = trailing.edge.df, npv.pct ~ cluster)
plot(npv.lm)
# Equal variances?
var.test(data = trailing.edge.df, npv.pct ~ cluster) # no
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(npv.pct)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(npv.pct)
t.test(c1, c2, var.equal = F)
```
**Significant diffference**

Log Seedling Density
```{r}
# Normal distribution?
log.seedling.lm <- lm(data = trailing.edge.df, log.seedling.density ~ cluster)
plot(log.seedling.lm)
# Equal variances?
var.test(data = trailing.edge.df, log.seedling.density ~ cluster) #No, run Welch's t test below
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(log.seedling.density)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(log.seedling.density)
t.test(c1, c2, var.equal = F) # sig.
```
**significant difference**

Log Regen Density
```{r}
# Normal distribution?
log.regen.lm <- lm(data = trailing.edge.df, log.regen.density ~ cluster)
plot(log.regen.lm)
# Equal variances?
var.test(data = trailing.edge.df, log.regen.density ~ cluster) #No, run Welch's t test below
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(log.regen.density)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(log.regen.density)
t.test(c1, c2, var.equal = F) # sig.
```
**Significant differences**

Slope
```{r}
# Normal distribution?
slope.lm <- lm(data = trailing.edge.df, slope ~ cluster)
plot(slope.lm)
# Equal variances?
var.test(data = trailing.edge.df, slope ~ cluster) # no
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(slope)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(slope)
t.test(c1, c2, var.equal = F) # n.s.
```

Aspect
```{r}
# Normal distribution?
aspect.lm <- lm(data = trailing.edge.df, aspect ~ cluster)
plot(aspect.lm) # Doesn't look great, but hopefully CLT applies
# Equal variances?
var.test(data = trailing.edge.df, aspect ~ cluster) # no
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(aspect)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(aspect)
t.test(c1, c2, var.equal = F) 
```
**Significant difference**

Densiometer
```{r}
# Normal distribution?
densio.lm <- lm(data = trailing.edge.df, densiometer ~ cluster)
plot(densio.lm)
# Equal variances?
var.test(data = trailing.edge.df, densiometer ~ cluster) # yes
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(densiometer)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(densiometer)
t.test(c1, c2, var.equal = T) # n.s.
```

### Persistent Forest
```{r}
forested.df <- main.df %>% 
  filter(TE_future == 'N')
```

Looking at two clusters, t-test

% Grass
```{r}
# Normal distribution?
grass.lm <- lm(data = forested.df, grass.pct ~ cluster)
plot(grass.lm)
# Equal variances?
var.test(data = forested.df, grass.pct ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(grass.pct)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(grass.pct)
t.test(c1, c2, var.equal = T) # sig.
```
*significant difference!*

% herb
```{r}
# Normal distribution?
herb.lm <- lm(data = forested.df, herb.pct ~ cluster)
plot(herb.lm)
# Equal variances?
var.test(data = forested.df, herb.pct ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(herb.pct)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(herb.pct)
t.test(c1, c2, var.equal = T) # sig.
```
*significant differences!*

% shrub
```{r}
# Normal distribution?
shrub.lm <- lm(data = forested.df, shrub.pct ~ cluster)
plot(shrub.lm)
# Equal variances?
var.test(data = forested.df, shrub.pct ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(shrub.pct)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(shrub.pct)
t.test(c1, c2, var.equal = F) # sig.
```
**Significant difference**

% seedling
```{r}
# Normal distribution?
seedling.lm <- lm(data = forested.df, seedling.pct ~ cluster)
plot(seedling.lm) # NOT A NORMAL DISTRIBUTION, but hopefully central limit theorem applies (n > 30 for each group)
# Equal variances?
var.test(data = forested.df, seedling.pct ~ cluster) # yes
# T-test (Welch's)
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(seedling.pct)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(seedling.pct)
t.test(c1, c2, var.equal = T) # n.s.
```

% green
```{r}
# Normal distribution?
green.lm <- lm(data = forested.df, green.pct ~ cluster)
plot(green.lm)
# Equal variances?
var.test(data = forested.df, green.pct ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(green.pct)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(green.pct)
t.test(c1, c2, var.equal = F) # sig.
```
*significant difference!*

% npv
```{r}
# Normal distribution?
npv.lm <- lm(data = forested.df, npv.pct ~ cluster)
plot(npv.lm)
# Equal variances?
var.test(data = forested.df, npv.pct ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(npv.pct)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(npv.pct)
t.test(c1, c2, var.equal = F) # marginally n.s.
```

Log Seedling Density
```{r}
# Normal distribution?
log.seedling.lm <- lm(data = forested.df, log.seedling.density ~ cluster)
plot(log.seedling.lm)
# Equal variances?
var.test(data = forested.df, log.seedling.density ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(log.seedling.density)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(log.seedling.density)
t.test(c1, c2, var.equal = F) # n.s.
```

Log Regen Density
```{r}
# Normal distribution?
log.regen.lm <- lm(data = forested.df, log.regen.density ~ cluster)
plot(log.regen.lm)
# Equal variances?
var.test(data = forested.df, log.regen.density ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(log.regen.density)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(log.regen.density)
t.test(c1, c2, var.equal = F) # n.s.
```

Slope
```{r}
# Normal distribution?
slope.lm <- lm(data = forested.df, slope ~ cluster)
plot(slope.lm)
# Equal variances?
var.test(data = forested.df, slope ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(slope)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(slope)
t.test(c1, c2, var.equal = F) # n.s.
```

Aspect
```{r}
# Normal distribution?
aspect.lm <- lm(data = forested.df, aspect ~ cluster)
plot(aspect.lm) # Doesn't look great, but hopefully CLT applies
# Equal variances?
var.test(data = forested.df, aspect ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(aspect)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(aspect)
t.test(c1, c2, var.equal = F) # n.s.
```

Densiometer
```{r}
# Normal distribution?
densio.lm <- lm(data = forested.df, densiometer ~ cluster)
plot(densio.lm)
# Equal variances?
var.test(data = forested.df, densiometer ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(densiometer)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(densiometer)
t.test(c1, c2, var.equal = F) # n.s.
```

### Summary
Significance:
TE (n = 74): Aspect, Log Regen Density, Log Seedling Density, NPV, Herb, Shrub
Forest (n = 37): Grass, Herb, Shrub, Green

Interesting that log regen and log seedling density are significant for trailing edge when this goes *against* our thoughts; will have to look at this more closely w/ regressions. Shrub and herb sig. for both and sig. for TE and forest; otherwise, results mixed

After running regressions, we see significant relationship between log regen and log seedling w/ spectral metrics but in the OPPOSITE direction than expected; this aligns with our thoughts!

## Boxplots
```{r}
main.df %>% 
  #filter(forest.type == 'Trailing Edge') %>% 
  pivot_longer(cols = c(grass.pct, herb.pct, shrub.pct, seedling.pct, green.pct, npv.pct, log.seedling.density, densiometer, log.regen.density), values_to = 'field_val', names_to = 'field_var')  %>% 
  ggplot(aes(x = cluster, y = field_val, color = TE_future)) +
    geom_boxplot(alpha = 0.8, outlier.shape = NA) +
    geom_point(position=position_jitterdodge(jitter.width = 0.1, jitter.height = 0), alpha = 0.3) +
    labs(x = 'Spectral Trajectory Cluster', y = ' ', color = 'Future Trailing Edge?') +
    facet_wrap(~field_var, scales = 'free', labeller = as_labeller(field_var_names)) +
    theme_bw() +
    theme(legend.position = 'top',
          legend.title = element_text(face = 'bold', size = 12),
          axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))
ggsave(here('figures', 'extra_figures', 'field.vs.clusters.trailing.boxplots.png'), height = 9, width = 9)
```

# Trailing Edge Deep-Dive
To delve into the 'trailing edge' story a bit more, I think we should depart from the cluster analysis a bit and think of other ways of looking at this question. First, EDA figures on how spectral metrics, field data compares to trailing edge

## Fires
```{r}
main.df %>% 
  group_by(TE_future, fire) %>% 
  tally() %>% 
  pivot_wider(names_from = TE_future, values_from = n)
```

## NBR Timeseries
```{r}
# Average values
te.avgs.df <- long.field.cluster.df %>% 
  mutate(TE_future = case_when(TE_future == 'Y' ~ 'Trailing\nedge',
                              TE_future == 'N' ~ 'Non-trailing\nedge')) %>% 
  group_by(TE_future, relative_year) %>% 
  summarise(avg_nbr = mean(nbr), avg_delta_nbr = mean(yearly_delta_nbr))

# Time series
te.time.series <- long.field.cluster.df %>% 
  mutate(TE_future = case_when(TE_future == 'Y' ~ 'Trailing\nedge',
                              TE_future == 'N' ~ 'Non-trailing\nedge')) %>% 
  drop_na(relative_year) %>% 
  ggplot() +
    geom_boxplot(aes(x = as.factor(relative_year), y = yearly_delta_nbr, color = TE_future), alpha = 0.2, outlier.shape = NA) +
    geom_line(data = te.avgs.df, aes(x = relative_year+1, y = avg_delta_nbr, color = TE_future), alpha = 0.9, linewidth = 2.3) +
    geom_vline(xintercept = 10.5, linetype = 'dashed', linewidth = 0.4) +
    scale_x_discrete(labels = c('', '', '', '', '-5', '', '', '', '', '0', '', '', '', '', '5', '', '', '', '', '10', '', '', '', '')) +
    scale_y_continuous(breaks = c(-900, -600, -300, 0, 300)) +
    annotate(geom = 'text', x = 10.1, y = -900, label = 'Fire', size = 8, angle = 90) +
    labs(x = 'Years post-fire', y = 'NBR (baseline-adjusted)') +
    scale_color_manual(values = c('#A6A57A', '#A33B20')) +
    theme_bw() +
    theme(text = element_text(family = 'Arial'),
          legend.position = c(0.85, 0.15),
          axis.title.x = element_text(face = 'bold', size = 38),
          axis.title.y = element_text(margin = margin(r = 20), face = 'bold', size = 38),
          axis.text = element_text(size = 30),
          legend.title = element_blank(),
          axis.ticks = element_blank(),
          legend.text = element_text(size = 26),
          panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank())
te.time.series
ggsave(here('figures', 'extra_figures', 'trailing.edge.nbr.time.series.boxplots.png'), height = 9, width = 14)
```


## Boxplots
```{r}
main.df %>% 
  pivot_longer(cols = c(relative_regrowth, absolute_regrowth, dnbr, pct_recovery, delta_nbr, postfire_fitted_slope), names_to = 'var', values_to = 'val') %>%
  ggplot(aes(x = TE_future, y = val)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.8) +
    geom_jitter(width = 0.15, alpha = 0.3) +
    labs(x = 'Trailing edge?', y = ' ') +
    facet_wrap(~var, scales = 'free', labeller = as_labeller(spectral_field_var_names)) +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))

main.df %>% 
  pivot_longer(cols = c(grass.pct, herb.pct, shrub.pct, seedling.pct, green.pct, npv.pct, log.regen.density, log.seedling.density, densiometer), values_to = 'field_val', names_to = 'field_var')  %>% 
  ggplot(aes(x = TE_future, y = field_val)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.8) +
    geom_jitter(width = 0.15, alpha = 0.3) +
    labs(x = 'Trailing Edge?', y = ' ') +
    facet_wrap(~field_var, scales = 'free', labeller = as_labeller(spectral_field_var_names)) +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))
```

### Climate
RANOVA
```{r}
summary(lmer(postfire_ppt ~ TE_future + (1|fire), main.df)) # n.s.
summary(lmer(postfire_tmean ~ TE_future + (1|fire), main.df)) # n.s.
summary(lmer(cwd_future ~ TE_future + (1|fire), main.df)) # sig.
summary(lmer(cwd_present ~ TE_future + (1|fire), main.df)) # sig.
```

Boxplot
```{r}
TE_future <- c(rep(c('Trailing\nedge', 'Non-trailing\nedge'), 4))
#cluster.no <- c(rep(c(1.5, 2), 8))
clim_var <- c(rep('postfire_ppt', 2), rep('postfire_tmean', 2),
               rep('cwd_future', 2), rep('cwd_present', 2))
y.val <- c(rep(1000, 2), rep(8, 2),
           rep(760, 2), rep(625, 2))
label <- c('', '', '', '', '*', '', '*', '')
te.ranova.label.df <- data.frame(TE_future, clim_var, y.val, label) 

te.clim.boxplot <- main.df %>% 
  mutate(TE_future = case_when(TE_future == 'Y' ~ 'Trailing\nedge',
                                 TE_future == 'N' ~ 'Non-trailing\nedge')) %>% 
  pivot_longer(cols = c(cwd_future, cwd_present, postfire_ppt, postfire_tmean),
               names_to = 'clim_var',
               values_to = 'clim_val') %>% 
  ggplot(aes(x = TE_future, y = clim_val, color = TE_future)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.8) +
    geom_jitter(width = 0.15, height = 0, alpha = 0.3) +
    geom_text(aes(x = TE_future, y = y.val, label = label),
              color = 'black', size = 14, fontface = 'bold',
              data = te.ranova.label.df)  +
    facet_wrap(~factor(clim_var, c('cwd_future', 'cwd_present', 'postfire_ppt', 'postfire_tmean')), nrow = 1, scales = 'free', strip.position = 'left',
               labeller = as_labeller(climate_var_names2)) +
    scale_color_manual(values = c('#A6A57A', '#A33B20')) +
    theme_bw() +
    theme(text = element_text(family = 'Arial'),
          legend.position = 'none',
          strip.placement = 'outside',
          strip.background = element_blank(),
          axis.title = element_blank(),
          axis.text.y = element_text(size = 18),
          axis.text.x = element_text(size = 18),
          strip.text = element_text(face = 'bold', size = 20),
          panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank())
te.clim.boxplot
```

### Field Measurements & PFFS
RANOVA
```{r}
summary(lmer(postfire_fitted_slope ~ TE_future + (1|fire), main.df)) # sig.
summary(lmer(seedling.pct ~ TE_future + (1|fire), main.df)) # n.s.
summary(lmer(regen.density ~ TE_future + (1|fire), main.df)) # n.s.
summary(lmer(grass.pct ~ TE_future + (1|fire), main.df)) # sig.
summary(lmer(shrub.pct ~ TE_future + (1|fire), main.df)) # sig.
```

Boxplot 1
```{r}
TE_future <- c(rep(c('Trailing\nedge', 'Non-trailing\nedge'), 4))
#cluster.no <- c(rep(c(1.5, 2), 8))
var <- c(rep('postfire_fitted_slope', 2), rep('seedling.pct', 2), rep('grass.pct', 2), rep('shrub.pct', 2))
y.val <- c(rep(55, 2), rep(75, 2), rep(75, 2), rep(75, 2))
label <- c('', '*', '', '', '*', '', '', '*')
te.ranova.label.df <- data.frame(TE_future, var, y.val, label) 

te.field.boxplot1 <- main.df %>% 
  mutate(TE_future = case_when(TE_future == 'Y' ~ 'Trailing\nedge',
                                 TE_future == 'N' ~ 'Non-trailing\nedge')) %>% 
  pivot_longer(cols = c(postfire_fitted_slope, seedling.pct, shrub.pct, grass.pct),
               names_to = 'var',
               values_to = 'val') %>% 
  ggplot(aes(x = TE_future, y = val, color = TE_future)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.8) +
    geom_jitter(width = 0.15, height = 0, alpha = 0.3) +
    geom_text(aes(x = TE_future, y = y.val, label = label),
              color = 'black', size = 18, fontface = 'bold',
              data = te.ranova.label.df)  +
    facet_wrap(~factor(var, levels = c('seedling.pct', 'shrub.pct', 'grass.pct', 'postfire_fitted_slope')), nrow = 1, scales = 'free_y', strip.position = 'left',
               labeller = as_labeller(spectral_field_var_names)) +
    scale_color_manual(values = c('#A6A57A', '#A33B20')) +
    theme_bw() +
    theme(text = element_text(family = 'Arial'),
          legend.position = 'none',
          strip.placement = 'outside',
          strip.background = element_blank(),
          axis.title = element_blank(),
          axis.text.y = element_text(size = 20),
          axis.text.x = element_text(size = 20),
          strip.text = element_text(face = 'bold', size = 24),
          panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank())
te.field.boxplot1
```

Boxplot 2: Regen Density (log scale)
```{r}
TE_future <- c('Trailing\nedge', 'Non-trailing\nedge')
var <- c(rep('regen.density', 2))
y.val <- c(rep(20000, 2))
label <- c('', '')
te.ranova.label.df <- data.frame(TE_future, var, y.val, label) 

te.field.boxplot2 <- main.df %>% 
  mutate(TE_future = case_when(TE_future == 'Y' ~ 'Trailing\nedge',
                                 TE_future == 'N' ~ 'Non-trailing\nedge')) %>% 
  pivot_longer(cols = c(postfire_fitted_slope, regen.density, seedling.pct, shrub.pct, grass.pct),
               names_to = 'var',
               values_to = 'val') %>% 
  filter(var == 'regen.density') %>% 
  ggplot(aes(x = TE_future, y = val, color = TE_future)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.8) +
    geom_jitter(width = 0.15, height = 0, alpha = 0.3) +
    geom_text(aes(x = TE_future, y = y.val, label = label),
              color = 'black', size = 18, fontface = 'bold',
              data = te.ranova.label.df)  +
    facet_wrap(~var, nrow = 1, scales = 'free_y', strip.position = 'left',
               labeller = as_labeller(spectral_field_var_names)) +
    scale_y_continuous(trans = 'log', breaks = c(18, 180, 1800, 18000)) +
    scale_color_manual(values = c('#A6A57A', '#A33B20')) +
    theme_bw() +
    theme(text = element_text(family = 'Arial'),
          legend.position = 'none',
          strip.placement = 'outside',
          strip.background = element_blank(),
          axis.title = element_blank(),
          axis.text.y = element_text(size = 20),
          axis.text.x = element_text(size = 20),
          strip.text = element_text(face = 'bold', size = 24),
          panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank())
te.field.boxplot2
```

Arranged
```{r, warning = FALSE}
te.field.boxplot <- cowplot::plot_grid(te.field.boxplot2, te.field.boxplot1, rel_widths = c(1.08, 4), ncol = 2)
te.field.boxplot
```


## Regressions
1. Comparing spectral metrics with field metrics for trailing edge vs. persistent forest
```{r}
main.df %>% 
  pivot_longer(cols = c(relative_regrowth, pct_recovery, delta_nbr, postfire_fitted_slope), names_to = 'spectral_var', values_to = 'spectral_val') %>%
    pivot_longer(cols = c(grass.pct, herb.pct, shrub.pct, seedling.pct, log.seedling.density, log.regen.density), values_to = 'field_val', names_to = 'field_var')  %>% 
    ggplot(aes(x = spectral_val, y = field_val, color = TE_future)) +
    geom_point(alpha = 0.6) +
    geom_smooth(alpha = 0.8, se = F, method = 'lm') +
    stat_cor(label.y.npc = 'top', label.x.npc = 'middle') +
    stat_regline_equation(label.y.npc = 'top', label.x.npc = 'left') +
    labs(x = 'Spectral traj. metrics', y = 'Field metrics', color = 'Trailing edge?') +
    facet_grid(field_var~spectral_var, scales = 'free', labeller = as_labeller(spectral_field_var_names)) +
    scale_color_manual(values = c('#A6A57A', '#A33B20')) +
    theme_bw() +
    theme(legend.position = 'bottom',
          legend.title = element_text(face = 'bold', size = 16),
          legend.text = element_text(size = 14),
          axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 14))
ggsave(here('figures', 'extra_figures', 'spectral.vs.field.regressions.TE.png'), height = 12, width = 14)
```

Abridged version (for main figure)
```{r}
abridged.te.regressions <- main.df %>% 
    mutate(TE_future = case_when(TE_future == 'Y' ~ 'Trailing edge',
                                 TE_future == 'N' ~ 'Non-trailing edge')) %>% 
    pivot_longer(cols = c(seedling.pct, log.regen.density), values_to = 'field_val', names_to = 'field_var')  %>% 
    ggplot(aes(x = postfire_fitted_slope, y = field_val, color = TE_future)) +
    geom_point(alpha = 0.8) +
    geom_smooth(alpha = 0.4, se = T, method = 'lm', fill = 'gray80') +
    labs(x = 'Post-fire Fitted Slope', y = '', color = ' ') +
    facet_wrap(~field_var, scales = 'free_y', labeller = as_labeller(field_var_names),
               ncol = 1, strip.position = 'left') +
    scale_color_manual(values = c('#A6A57A', '#A33B20')) +
    theme_bw() +
    theme(text = element_text(family = 'Arial'),
          legend.position = 'top',
          strip.placement = 'outside',
          strip.background = element_blank(),
          legend.title = element_blank(),
          legend.text = element_text(face = 'bold', size = 18),
          axis.title = element_text(face = 'bold', size = 20),
          axis.text.x = element_text(size = 18),
          axis.text.y = element_text(size = 18),
          strip.text = element_text(face = 'bold', size = 20),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank())
abridged.te.regressions
```

2. Comparing deviation from present, future, and difference between present and future cwd to field data and spectral data
```{r}
main.df %>% 
  mutate(cwd_diff = cwd_future - cwd_present) %>% 
  pivot_longer(cols = c(cwd_present, cwd_future, cwd_diff), names_to = 'cwd_var', values_to = 'cwd_val') %>%
    pivot_longer(cols = c(grass.pct, herb.pct, shrub.pct, seedling.pct, green.pct, log.seedling.density, log.regen.density), values_to = 'field_val', names_to = 'field_var')  %>% 
    ggplot(aes(x = cwd_val, y = field_val)) +
    geom_point(alpha = 0.6) +
    geom_smooth(alpha = 0.8, se = F, method = 'lm', color = 'gray40') +
    stat_cor(label.y.npc = 'top', label.x.npc = 'middle') +
    stat_regline_equation(label.y.npc = 'top', label.x.npc = 'left') +
    labs(x = 'cwd Metrics', y = 'Field Metrics') +
    facet_grid(field_var~cwd_var, scales = 'free', labeller = as_labeller(spectral_field_var_names)) +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))
ggsave(here('figures', 'extra_figures', 'cwd.vs.field.regressions.TE.png'), height = 12, width = 12)

main.df %>%  
  pivot_longer(cols = c(cwd_present, cwd_future), names_to = 'cwd_var', values_to = 'cwd_val') %>%
    pivot_longer(cols = c(seedling.pct, log.seedling.density, log.regen.density), values_to = 'field_val', names_to = 'field_var')  %>% 
    ggplot(aes(x = cwd_val, y = field_val, color = TE_future)) +
    geom_point(alpha = 0.6) +
    geom_smooth(alpha = 0.8, se = F, method = 'lm') +
    labs(x = 'cwd Metrics', y = 'Field Metrics', color = 'Trailing Edge?') +
    facet_grid(field_var~cwd_var, scales = 'free', labeller = as_labeller(spectral_field_var_names)) +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))
ggsave(here('figures', 'extra_figures', 'cwd.vs.seedling.regressions.TE.png'), height = 8, width = 7)

main.df %>% 
  mutate(cwd_diff = cwd_future - cwd_present) %>% 
  pivot_longer(cols = c(cwd_present, cwd_future, cwd_diff), names_to = 'cwd_var', values_to = 'cwd_val') %>%
  pivot_longer(cols = c(relative_regrowth, pct_recovery, delta_nbr, postfire_fitted_slope), names_to = 'spectral_var', values_to = 'spectral_val') %>%
    ggplot(aes(x = cwd_val, y = spectral_val)) +
    geom_point(alpha = 0.6) +
    geom_smooth(alpha = 0.8, se = F, method = 'lm', color = 'gray40') +
    stat_cor(label.y.npc = 'top', label.x.npc = 'middle') +
    stat_regline_equation(label.y.npc = 'top', label.x.npc = 'left') +
    labs(x = 'cwd Metrics', y = 'Spectral Traj. Metrics') +
    facet_grid(spectral_var~cwd_var, scales = 'free', labeller = as_labeller(spectral_field_var_names)) +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))
ggsave(here('figures', 'extra_figures', 'cwd.vs.spectral.regressions.TE.png'), height = 8, width = 12)
```

### Vs. Prob. Post-fire Recovery
```{r}
main.df %>% 
  rename(regen_prob = re.0gen_prob) %>% 
  mutate(cwd_diff = cwd_future - cwd_present) %>% 
  pivot_longer(cols = c(cwd_present, cwd_future), names_to = 'cwd_var', values_to = 'cwd_val') %>%
    ggplot(aes(x = cwd_val, y = regen_prob, color = TE_future)) +
    geom_point(alpha = 0.6) +
    geom_smooth(alpha = 0.8, se = F, method = 'lm') +
    labs(x = 'cwd Metrics', y = 'Post-fire Recovery Probability', color = "Trailing Edge?") +
    facet_wrap(~cwd_var, scales = 'free', labeller = as_labeller(spectral_field_var_names)) +
    scale_color_manual(values = c('#A6A57A', '#A33B20')) +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))
ggsave(here('figures', 'extra_figures', 'cwd.vs.regen.prob.regressions.TE.png'), height = 8, width = 12)
```

## Correlation Plot
```{r}
main.df %>% 
  select(cwd_future, cwd_present, grass.pct, herb.pct, shrub.pct, seedling.pct, green.pct, npv.pct, log.seedling.density, log.regen.density, slope, densiometer, relative_regrowth, absolute_regrowth, dnbr, pct_recovery, delta_nbr, postfire_fitted_slope) %>% 
  ggcorr(label = T)
```

## Complex PCAs
### Field Data
#### Figure
Plot setup:
```{r warning=FALSE}
field.pca.df <- main.df %>% 
   select(grass.pct, herb.pct, shrub.pct, seedling.pct, green.pct, npv.pct, log.regen.density, densiometer, TE_future) %>% 
   drop_na(grass.pct, herb.pct, shrub.pct, seedling.pct, green.pct, npv.pct, log.regen.density, densiometer, TE_future)

figure_pca_quant <- (field.pca.df[, c('grass.pct', 'herb.pct', 'shrub.pct', 'seedling.pct', 'green.pct', 'npv.pct', 'log.regen.density', 'densiometer')]) %>%  
 transmute("% Grass" = grass.pct,
           "% Herb" = herb.pct,
           "% Shrub" = shrub.pct,
           "% Seedling" = seedling.pct,
           "% Green" = green.pct,
           "% NPV" = npv.pct,
           "Regen Density (log-trans)" = log.regen.density,
           "Canopy Cover" = densiometer
          ) %>% 
  na.omit()

figure_pca_cat <- (field.pca.df[, c('grass.pct', 'herb.pct', 'shrub.pct', 'seedling.pct', 'green.pct', 'npv.pct', 'log.regen.density', 'densiometer', 'TE_future')]) %>%  
  na.omit() %>% 
  select(TE_future) %>% 
  transmute("Trailing Edge" = TE_future)
  
figure_prcomp <- prcomp(na.omit(figure_pca_quant), 
                          center = TRUE, 
                          scale = TRUE, 
                          retx=TRUE)
  
figure_pca <- (field.pca.df[, c('grass.pct', 'herb.pct', 'shrub.pct', 'seedling.pct', 'green.pct', 'npv.pct', 'log.regen.density', 'densiometer')]) %>%  
  na.omit() 
```

```{r warning=FALSE}
#Setting up plotting data: 

#decisions for plotting:
choices = 1:2 
scale = 1
obs.scale = 1 - scale
var.scale = scale
ellipse.prob = 0.68
labels.size = 3
circle.prob = 0.69
choices = 1:2

#Run PCA
pcobj <- prcomp(na.omit(figure_pca_quant), center = TRUE, scale = TRUE)

# extract PCA components: 
nobs.factor <- sqrt(nrow(pcobj$x) - 1)
    d <- pcobj$sdev
    u <- sweep(pcobj$x, 2, 1/(d * nobs.factor), FUN = "*")
    v <- pcobj$rotation

  choices <- pmin(choices, ncol(u))
  df.u <- as.data.frame(sweep(u[, choices], 2, d[choices]^obs.scale, 
                              FUN = "*"))
  v <- sweep(v, 2, d^var.scale, FUN = "*")
  df.v <- as.data.frame(v[, choices])
  names(df.u) <- c("PC1", "PC2")
  names(df.v) <- names(df.u)
  df.u <- df.u * nobs.factor

  r <- sqrt(qchisq(circle.prob, df = 2)) * prod(colMeans(df.u^2))^(1/4)
  
v.scale <- rowSums(v^2)
df.v <- r * df.v/sqrt(max(v.scale)) 
df.v <- df.v %>% mutate(PC1, PC2)
df.v$Variables <- rownames(v) 
PCAloadings = df.v
#df.v = dataset with loadings 

#dataset with scores and categorical variables for plotting points: 
PCAvalues <- cbind(df.u, figure_pca_cat)

#dataset with information for plotting circle: 
theta <- c(seq(-pi, pi, length = 50), seq(pi, -pi, length = 50))

circle <- data.frame(PC1 = r * cos(theta), PC2 = r * sin(theta)) 

#Group by flam. metric: 
PCA_metrics <- df.v %>% 
  filter(Variables %in% c("% Grass", "% Herb", "% Shrub", "% Seedling",
           "% Green", "% NPV", "Regen Density (log-trans)", "Canopy Cover"))
    
# Calculate the angles and the label offset
df.v$Angle = ((180/pi) * atan(df.v$PC2/df.v$PC1))

df.v$Offset <- ((-2 * sign(df.v$PC1))/2)

#labels: 
u.axis.labs <- paste("PC", choices, sep = "")
u.axis.labs <- paste(u.axis.labs, sprintf("(%0.1f%% explained var.)", 
                                            100 * pcobj$sdev[choices]^2/sum(pcobj$sdev^2)))
```

Plot:
```{r}
ggplot(PCAvalues, aes(x = PC1, y = PC2)) +
  ylim(-4, 3) +
  geom_point(size = 1.75, alpha = .9, aes(color = `Trailing Edge`), data = PCAvalues) +
  stat_ellipse(aes(color = `Trailing Edge`)) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  geom_segment(data = PCA_metrics, aes(x = 0, y = 0, xend = PC1, yend = PC2), 
    linewidth = .9, alpha = 0.9,
    arrow = ggplot2::arrow(length = unit(0.1, "cm")),
    color = "black") +
  annotate("text", 
          x = (PCA_metrics$PC1 * 1.3), 
          y = (PCA_metrics$PC2 * 1.1),
          label = PCA_metrics$Variables, size = 3.5,
          fontface = 'bold') +
  theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank(),
          legend.key = element_rect(fill = "white"),
          legend.position = 'right',
          legend.title = element_text(face = 'bold', size = 15),
          legend.text = element_text(face = 'italic', size = 13),
          axis.title = element_text(face = 'bold', size = 15)) +
    scale_color_manual(values = c('#A6A57A', '#A33B20')) +  
   xlab(u.axis.labs[1]) + 
   ylab(u.axis.labs[2]) +
  coord_equal()
#ggsave(here('figures', 'PCA', 'FlammandTraits.PCA.png'), height = 7, width = 9)
```

#### Table
```{r warning=FALSE}
figure_varimax <- varimax(pcobj$rotation[,1:3])
figure_varimax

tab_pca(pcobj, rotation = 'varimax',
        nmbr.fctr = 4,
         digits = 2,
         show.var = TRUE,
  string.pov = "Proportion of Variance",
  string.cpov = "Cumulative Proportion")
#  file = here('figures', 'PCA', 'FlammandTraits.PC.Table.html')) 
```

### Spectral Trajectory
#### Figure
Plot setup:
```{r warning=FALSE}
field.pca.df <- main.df %>% 
   select(relative_regrowth, dnbr, pct_recovery, delta_nbr, postfire_fitted_slope, TE_future) %>% 
   drop_na(relative_regrowth, dnbr, pct_recovery, delta_nbr, postfire_fitted_slope, TE_future)

figure_pca_quant <- (field.pca.df[, c('relative_regrowth', 'dnbr', 'pct_recovery', 'delta_nbr', 'postfire_fitted_slope')]) %>%  
 transmute("Relative Regrowth" = relative_regrowth,
           "Fire Severity (dNBR)" = dnbr,
           "% Recovery" = pct_recovery,
           "Change in NBR" = delta_nbr,
           "Postfire Fitted Slope" = postfire_fitted_slope
          ) %>% 
  na.omit()

figure_pca_cat <- (field.pca.df[, c('relative_regrowth', 'dnbr', 'pct_recovery', 'delta_nbr', 'postfire_fitted_slope', 'TE_future')]) %>%  
  na.omit() %>% 
  select(TE_future) %>% 
  transmute("Trailing Edge" = TE_future)
  
figure_prcomp <- prcomp(na.omit(figure_pca_quant), 
                          center = TRUE, 
                          scale = TRUE, 
                          retx=TRUE)
  
figure_pca <- (field.pca.df[, c('relative_regrowth', 'dnbr', 'pct_recovery', 'delta_nbr', 'postfire_fitted_slope')]) %>%  
  na.omit() 
```

```{r warning=FALSE}
#Setting up plotting data: 

#decisions for plotting:
choices = 1:2 
scale = 1
obs.scale = 1 - scale
var.scale = scale
ellipse.prob = 0.68
labels.size = 3
circle.prob = 0.69
choices = 1:2

#Run PCA
pcobj <- prcomp(na.omit(figure_pca_quant), center = TRUE, scale = TRUE)

# extract PCA components: 
nobs.factor <- sqrt(nrow(pcobj$x) - 1)
    d <- pcobj$sdev
    u <- sweep(pcobj$x, 2, 1/(d * nobs.factor), FUN = "*")
    v <- pcobj$rotation

  choices <- pmin(choices, ncol(u))
  df.u <- as.data.frame(sweep(u[, choices], 2, d[choices]^obs.scale, 
                              FUN = "*"))
  v <- sweep(v, 2, d^var.scale, FUN = "*")
  df.v <- as.data.frame(v[, choices])
  names(df.u) <- c("PC1", "PC2")
  names(df.v) <- names(df.u)
  df.u <- df.u * nobs.factor

  r <- sqrt(qchisq(circle.prob, df = 2)) * prod(colMeans(df.u^2))^(1/4)
  
v.scale <- rowSums(v^2)
df.v <- r * df.v/sqrt(max(v.scale)) 
df.v <- df.v %>% mutate(PC1, PC2)
df.v$Variables <- rownames(v) 
PCAloadings = df.v
#df.v = dataset with loadings 

#dataset with scores and categorical variables for plotting points: 
PCAvalues <- cbind(df.u, figure_pca_cat)

#dataset with information for plotting circle: 
theta <- c(seq(-pi, pi, length = 50), seq(pi, -pi, length = 50))

circle <- data.frame(PC1 = r * cos(theta), PC2 = r * sin(theta)) 

#Group by flam. metric: 
PCA_metrics <- df.v %>% 
  filter(Variables %in% c("Relative Regrowth", "Fire Severity (dNBR)", "% Recovery",
           "Change in NBR", "Postfire Fitted Slope"))
    
# Calculate the angles and the label offset
df.v$Angle = ((180/pi) * atan(df.v$PC2/df.v$PC1))

df.v$Offset <- ((-2 * sign(df.v$PC1))/2)

#labels: 
u.axis.labs <- paste("PC", choices, sep = "")
u.axis.labs <- paste(u.axis.labs, sprintf("(%0.1f%% explained var.)", 
                                            100 * pcobj$sdev[choices]^2/sum(pcobj$sdev^2)))
```

Plot:
```{r}
ggplot(PCAvalues, aes(x = PC1, y = PC2)) +
  ylim(-4, 3) +
  geom_point(size = 1.75, alpha = .9, aes(color = `Trailing Edge`), data = PCAvalues) +
  stat_ellipse(aes(color = `Trailing Edge`)) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  geom_segment(data = PCA_metrics, aes(x = 0, y = 0, xend = PC1, yend = PC2), 
    linewidth = .9, alpha = 0.9,
    arrow = ggplot2::arrow(length = unit(0.1, "cm")),
    color = "black") +
  annotate("text", 
          x = (PCA_metrics$PC1 * 1.3), 
          y = (PCA_metrics$PC2 * 1.1),
          label = PCA_metrics$Variables, size = 3.5,
          fontface = 'bold') +
  theme(panel.background = element_rect(fill='white', colour='black'), # Make background white and border black
          panel.grid.major = element_blank(),  # Hide major gridlines
          panel.grid.minor = element_blank(),
          legend.key = element_rect(fill = "white"),
          legend.position = 'right',
          legend.title = element_text(face = 'bold', size = 15),
          legend.text = element_text(face = 'italic', size = 13),
          axis.title = element_text(face = 'bold', size = 15)) +
    scale_color_manual(values = c('#A6A57A', '#A33B20')) +  
    #scale_color_manual(values = c("#00468BB2", "#42B540B2", "#0099B4B2", "#925E9FB2", "#FDAF91B2", "#AD002AB2", "#ADB6B6B2", "#1B1919B2")) +
   xlab(u.axis.labs[1]) + 
   ylab(u.axis.labs[2]) +
  coord_equal()
#ggsave(here('figures', 'PCA', 'FlammandTraits.PCA.png'), height = 7, width = 9)
```

#### Table
```{r warning=FALSE}
figure_varimax <- varimax(pcobj$rotation[,1:3])
figure_varimax

tab_pca(pcobj, rotation = 'varimax',
        nmbr.fctr = 4,
         digits = 2,
         show.var = TRUE,
  string.pov = "Proportion of Variance",
  string.cpov = "Cumulative Proportion")
#  file = here('figures', 'PCA', 'FlammandTraits.PC.Table.html')) 
```

## Vs. Veg Composition
### Field Data
```{r}
main.df %>% 
  drop_na(dom.seedling.spp) %>% 
  filter(dom.seedling.spp != '-') %>% 
ggplot(aes(x = TE_future, y = dom.seedling.spp)) +
  geom_jitter(width = 0.175, height = 0.125) +
  labs(x = 'Trailing Edge', y = 'Dominant Seedling Species') +
  theme_bw() + 
  theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12))

main.df %>% 
  drop_na(dom.tree.spp) %>% 
  filter(dom.tree.spp != '-', dom.tree.spp != '?', dom.tree.spp != 'N/A') %>% 
ggplot(aes(x = TE_future, y = dom.tree.spp)) +
  geom_jitter(width = 0.175, height = 0.125) +
  labs(x = 'Trailing Edge', y = 'Dominant Tree Species') +
  theme_bw() + 
  theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12))
```

### ITPSM Data
For now, PICO, PIPO, LAOC
```{r}
# rasters
pico_spp_dist <- raster(here('data', 'site_selection', 'PICO_ITSPM.tif'))
pipo_spp_dist <- raster(here('data', 'site_selection', 'PIPO_ITSPM.tif'))
laoc_spp_dist <- raster(here('data', 'site_selection', 'LAOC_ITSPM.tif'))
pien_spp_dist <- raster(here('data', 'site_selection', 'PIEN_ITSPM.tif'))
psme_spp_dist <- raster(here('data', 'site_selection', 'PSME_ITSPM.tif'))
abgr_spp_dist <- raster(here('data', 'site_selection', 'ABGR_ITSPM.tif'))

pico_spp_dist <- projectRaster(pico_spp_dist, crs = crs(postfire.regen))
pipo_spp_dist <- projectRaster(pipo_spp_dist, crs = crs(postfire.regen))
laoc_spp_dist <- projectRaster(laoc_spp_dist, crs = crs(postfire.regen))
pien_spp_dist <- projectRaster(pien_spp_dist, crs = crs(postfire.regen))
psme_spp_dist <- projectRaster(psme_spp_dist, crs = crs(postfire.regen))
abgr_spp_dist <- projectRaster(abgr_spp_dist, crs = crs(postfire.regen))

# extracting species data
wide_cluster_coords <- wide.cluster.df[,c(1,2)] # define coordinates
wide_cluster_pts <- wide.cluster.df %>% 
  select(Long, Lat) %>% 
  SpatialPointsDataFrame(coords = wide_cluster_coords, proj4string = crs(postfire.regen)) # transform to
pico_vals <- as.data.frame(extract(pico_spp_dist, wide_cluster_pts))
colnames(pico_vals)[1] <- 'Pinus contorta'
pipo_vals <- as.data.frame(extract(pipo_spp_dist, wide_cluster_pts))
colnames(pipo_vals)[1] <- 'Pinus ponderosa'
laoc_vals <- as.data.frame(extract(laoc_spp_dist, wide_cluster_pts))
colnames(laoc_vals)[1] <- 'Larix occidentalis'
psme_vals <- as.data.frame(extract(psme_spp_dist, wide_cluster_pts))
colnames(psme_vals)[1] <- 'Pseudotsuga menziesii'
pien_vals <- as.data.frame(extract(pien_spp_dist, wide_cluster_pts))
colnames(pien_vals)[1] <- 'Picea engelmannii'
abgr_vals <- as.data.frame(extract(abgr_spp_dist, wide_cluster_pts))
colnames(abgr_vals)[1] <- 'Abies grandis'
spp_vals <- cbind(pico_vals, pipo_vals, laoc_vals, psme_vals, abgr_vals, pien_vals) #%>% 
  #mutate(`Both Species` = `Pinus contorta` + `Pinus ponderosa`) %>% 
  #mutate(`Both Species` = ifelse(`Both Species` == 2, 1, NA))
wide.cluster.spp.df <- cbind(wide.cluster.df, spp_vals) %>% 
  pivot_longer(cols = c(`Pinus contorta`, `Pinus ponderosa`, `Larix occidentalis`, `Pseudotsuga menziesii`, `Picea engelmannii`, `Abies grandis`), names_to = 'species', values_to = 'species.present') %>% 
  mutate(species.present = ifelse(is.na(species.present), 'No', 'Yes')) %>% 
  mutate(TE_future = ifelse(TE_future == 'N', 'No', 'Yes'))
```

#### Cross Validating w/ Field Data
```{r}
cross.validating.spp.df <- merge(wide.cluster.spp.df, field.data.both, by = ('Plot')) %>% 
  select(Plot, species, species.present, dom.seedling.spp, dom.tree.spp, TE_future, cwd_future)

cross.validating.spp.df %>% 
  filter(species.present == 'No') %>% 
  ggplot(aes(x = dom.seedling.spp, y = species)) +
    geom_jitter(width = 0.1, height = 0.1)
# Looks like we may want to update some values to better reflect what we saw w/ field data

cross.validating.spp.df %>% 
  filter(species.present == 'No') %>% 
  ggplot(aes(x = dom.tree.spp, y = species)) +
    geom_jitter(width = 0.1, height = 0.1)
# Looks like we may want to update some values to better reflect what we saw w/ field data

# to update with field data, I am correcting any 'No' values with 'Yes' in instances where the most prevalent species (or one of the most prevalent species, in cases where two species had the same # of seedlings/trees) of seedling AND tree
cross.validated.spp.df <- cross.validating.spp.df %>% 
  mutate(species.present = case_when(species.present == 'Yes' ~ 'Yes',
                               species.present == 'No' &
                               species == 'Pseudotsuga menziesii' & 
                               dom.seedling.spp == 'PSME' &
                               dom.tree.spp == 'PSME' ~ 'Yes',
                               species.present == 'No' &
                               species == 'Pinus ponderosa' & 
                               dom.seedling.spp %in% c('PIPO', 'JUOC-PIPO',
                               'LAOC-PIPO', 'PIPO-PIPO') &
                               dom.tree.spp %in% c('PIPO', 'JUOC-PIPO',
                               'LAOC-PIPO', 'PICO-PIPO') ~ 'Yes',
                               species.present == 'No' &
                               species == 'Pinus contorta' & 
                               dom.seedling.spp == 'PICO' &
                               dom.tree.spp %in% c('PICO', 'PICO-PIPO') ~ 'Yes',
                               species.present == 'No' &
                               species == 'Larix occidentalis' & 
                               dom.seedling.spp %in% c('LAOC', 'LAOC-PIPO') &
                               dom.tree.spp %in% c('LAOC', 'LAOC-PIPO') ~ 'Yes',
                               species.present == 'No' &
                               species == 'Abies grandis' & 
                               dom.seedling.spp == 'ABGR' &
                               dom.tree.spp %in% c('ABGR', '?-ABGR') ~ 'Yes')) %>% 
  mutate(species.present = ifelse(is.na(species.present), 'No', 'Yes'))
```

#### Visualizing
```{r}
## Points
cross.validated.spp.df %>% 
  drop_na(Plot) %>% 
ggplot(aes(x = TE_future, y = as.factor(species.present), color = as.factor(species))) +
  geom_jitter(height = 0.2, width = 0.2, alpha = 0.5) +
  facet_wrap(~species) +
  scale_color_manual(values = c('darkgreen','#4a6741','#3f5a36','#374f2f','#304529','#22311d')) +
  labs(x = 'Trailing edge?', y = 'Species present?') +
  theme_bw() + 
  theme(text = element_text(family = 'Arial'),
          legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          strip.text = element_text(face = 'italic', size = 16))

## Barplots
te.species.comp <- cross.validated.spp.df %>% 
  filter(species != 'Picea engelmannii') %>% 
  select(Plot, TE_future, species.present, species) %>% 
  drop_na(Plot)  %>% 
  group_by(species, TE_future, species.present) %>% 
  tally() %>% 
  mutate(TE = ifelse(TE_future == 'Yes', 'Trailing\nedge', 'Non-trailing\nedge')) %>% 
  ggplot() +
  geom_bar(aes(x = TE, y = n, fill = species.present),
           position = "stack",
           stat = "identity") +
  facet_grid(~ species, switch = "x") +
  scale_fill_manual(values = c('gray20', 'gray50')) +
  scale_y_continuous(breaks = c(10, 30, 50)) +
  theme_bw() +
  labs(y = 'Count', fill = 'Species present?') +
  theme(text = element_text(family = 'Arial'),
        strip.placement = "outside",
        strip.background = element_rect(fill = NA, color = "white"),
        panel.spacing = unit(-.01,"cm"),
        axis.title.y = element_text(face = 'bold', size = 22, vjust = 2),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 20, vjust = 1),
        axis.text.y = element_text(size = 20),
        strip.text = element_text(face = 'italic', size = 24),
        legend.title = element_text(face = 'bold', size = 22),
        legend.text = element_text(size = 20),
        panel.border = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.ticks = element_blank(), 
        legend.position = 'right')
te.species.comp
ggsave(here('figures', 'extra_figures', 'species.composition.TE.png'), height = 5.5, width = 17)
```

# Main Figure
3 Panels
```{r, warning = FALSE}
main_TE_figure <- plot_grid(te_vs_pf_estimates_int_plot, te.field.boxplot, te.species.comp, labels = c('a', 'b', 'c'), label_size = 42, ncol = 1, rel_heights = c(3.5, 2.25, 2))
main_TE_figure

ggsave(here('figures', 'main_figures', 'TE_main_figure.png'), height = 22, width = 25)
```

4 Panels (Model estimates, species composition barplot, climate boxplot, abridged scatterplots)
NOTE: Model estimate plot located in GLMM.Rmd!
```{r}
#top <- plot_grid(te_vs_pf_estimates_int_plot, abridged.te.regressions, ncol = 2, labels = c('a', 'b'), label_size = 42) # or te_vs_pf_estimates_plot
#top

#bottom <- plot_grid(te.clim.boxplot, te.species.comp, ncol = 1, labels = c('c', 'd'), label_size = 42)
#bottom

#all <- plot_grid(top, bottom, ncol = 1)
#all

#ggsave(here('figures', 'main_figures', 'TE_main_figure.png'), height = 20, width = 20)
```

# Supplemental Figure
```{r, warning = FALSE}
supp_TE_figure <- cowplot::plot_grid(te.time.series, te.clim.boxplot, ncol = 1, rel_heights = c(11, 5))
supp_TE_figure

ggsave(here('figures', 'supp_figures', 'TE_supp_figure.png'), width = 17.5, height = 15.2)
```


# -------------------------

# Self-defined Trailing Edge

## Segmented Regressions
```{r}
# % Seedling
out.lm<-lm(seedling.pct ~ cwd_future, data = main.df)
davies.test(out.lm, ~cwd_future, k = 50) # significant

segmented.mod <-segmented(out.lm, seg.Z = ~cwd_future)
segmented.mod
summary(segmented.mod)

# Regeneration Density
out.lm<-lm(log.regen.density ~ cwd_future, data = main.df)
davies.test(out.lm, ~cwd_future, k = 50) # significant

segmented.mod <-segmented(out.lm, seg.Z = ~cwd_future)
segmented.mod
summary(segmented.mod)

# Probability of Recovery
out.lm<-lm(re.0gen_prob ~ cwd_future, data = main.df)
davies.test(out.lm, ~cwd_future, k = 50) # not significant
```

Average of two sig. breakpoints = 532.5; let's try that as our threshold

## Data Wrangling
```{r}
main.df <- main.df %>% 
  mutate(selfdefined_TE = ifelse(cwd_future > 532.5, 'Y', 'N'))

long.field.cluster.df <- long.field.cluster.df %>% 
  mutate(selfdefined_TE = ifelse(cwd_future > 532.5, 'Y', 'N'))

cross.validated.spp.df <- cross.validated.spp.df %>% 
  mutate(selfdefined_TE = ifelse(cwd_future > 532.5, 'Y', 'N'))
```

## NBR Time Series
```{r}
# Average values
te.avgs.df <- long.field.cluster.df %>% 
  mutate(selfdefined_TE = case_when(selfdefined_TE == 'Y' ~ 'Trailing\nEdge',
                              selfdefined_TE == 'N' ~ 'Non-Trailing\nEdge')) %>% 
  group_by(selfdefined_TE, relative_year) %>% 
  summarise(avg_delta_nbr = mean(yearly_delta_nbr))

# Time series
sd.te.time.series <- long.field.cluster.df %>% 
  mutate(selfdefined_TE = case_when(selfdefined_TE == 'Y' ~ 'Trailing\nEdge',
                              selfdefined_TE == 'N' ~ 'Non-Trailing\nEdge')) %>% 
  drop_na(relative_year) %>% 
  ggplot() +
    geom_boxplot(aes(x = as.factor(relative_year), y = yearly_delta_nbr, color = selfdefined_TE), alpha = 0.2, outlier.shape = NA) +
    geom_line(data = te.avgs.df, aes(x = relative_year+1, y = avg_delta_nbr, color = selfdefined_TE), alpha = 0.9, linewidth = 2.3) +
    geom_vline(xintercept = 10.5, linetype = 'dashed', linewidth = 0.4) +
    scale_x_discrete(labels = c('', '', '', '', '-5', '', '', '', '', '0', '', '', '', '', '5', '', '', '', '', '10', '', '', '', '')) +
    scale_y_continuous(breaks = c(-900, -600, -300, 0, 300)) +
    annotate(geom = 'text', x = 10.1, y = -900, label = 'Fire', size = 8, angle = 90) +
    labs(x = 'Years Post-fire', y = 'NBR (Pre-fire Mean-adjusted)') +
    scale_color_manual(values = c('#A6A57A', '#A33B20')) +
    theme_bw() +
    theme(legend.position = c(0.85, 0.12),
          axis.title = element_text(face = 'bold', size = 20),
          axis.text = element_text(size = 18),
          legend.title = element_blank(),
          axis.ticks = element_blank(),
          legend.text = element_text(size = 24),
          panel.grid.major.x = element_blank(),
          panel.grid.minor = element_blank())
sd.te.time.series
```

## Boxplots
### RANOVA
```{r}
summary(lmer(postfire_ppt ~ selfdefined_TE + (1|fire), main.df)) # n.s.
summary(lmer(postfire_tmean ~ selfdefined_TE + (1|fire), main.df)) # n.s.
summary(lmer(postfire_vpdmax ~ selfdefined_TE + (1|fire), main.df)) # sig.
summary(lmer(postfire_fitted_slope ~ selfdefined_TE + (1|fire), main.df)) # sig.

summary(lmer(seedling.pct ~ selfdefined_TE + (1|fire), main.df)) # n.s.
summary(lmer(grass.pct ~ selfdefined_TE + (1|fire), main.df)) # n.s.
summary(lmer(shrub.pct ~ selfdefined_TE + (1|fire), main.df)) # n.s.
summary(lmer(log.regen.density ~ selfdefined_TE + (1|fire), main.df)) # n.s.
```

### Climate & PFFS
```{r}
selfdefined_TE <- c(rep(c('Trailing\nEdge', 'Non-Trailing\nEdge'), 4))
#cluster.no <- c(rep(c(1.5, 2), 8))
clim_var <- c(rep('postfire_ppt', 2), rep('postfire_tmean', 2),
               rep('postfire_vpdmax', 2), rep('postfire_fitted_slope', 2))
y.val <- c(rep(1000, 2), rep(8, 2),
           rep(14.5, 2), rep(63.5, 2))
label <- c('', '', '', '', '*', '', '', '*')
te.ranova.label.df <- data.frame(selfdefined_TE, clim_var, y.val, label) 

sd.te.clim.boxplot <- main.df %>% 
  mutate(selfdefined_TE = case_when(selfdefined_TE == 'Y' ~ 'Trailing\nEdge',
                                 selfdefined_TE == 'N' ~ 'Non-Trailing\nEdge')) %>% 
  pivot_longer(cols = c(postfire_ppt, postfire_tmean, postfire_vpdmax, postfire_fitted_slope),
               names_to = 'clim_var',
               values_to = 'clim_val') %>% 
  ggplot(aes(x = selfdefined_TE, y = clim_val, color = selfdefined_TE)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.8) +
    geom_jitter(width = 0.15, height = 0, alpha = 0.3) +
    geom_text(aes(x = selfdefined_TE, y = y.val, label = label),
              color = 'black', size = 14, fontface = 'bold',
              data = te.ranova.label.df)  +
    facet_wrap(~clim_var, nrow = 1, scales = 'free', strip.position = 'left',
               labeller = as_labeller(climate_var_names2)) +
    scale_color_manual(values = c('#A6A57A', '#A33B20')) +
    theme_bw() +
    theme(legend.position = 'none',
          strip.placement = 'outside',
          strip.background = element_blank(),
          axis.title = element_blank(),
          axis.text.y = element_text(size = 18),
          axis.text.x = element_text(size = 18),
          strip.text = element_text(face = 'bold', size = 20),
          panel.grid.minor = element_blank(),
          panel.grid.major.x = element_blank())
sd.te.clim.boxplot
```

## Veg Composition
```{r}
sd.te.species.comp <- cross.validated.spp.df %>% 
  filter(species != 'Picea engelmannii') %>% 
  select(Plot, selfdefined_TE, species.present, species) %>% 
  drop_na(Plot)  %>% 
  group_by(species, selfdefined_TE, species.present) %>% 
  tally() %>% 
  mutate(TE = ifelse(selfdefined_TE == 'Y', 'Trailing\nEdge', 'Non-Trailing\nEdge')) %>% 
  ggplot() +
  geom_bar(aes(x = TE, y = n, fill = species.present),
           position = "stack",
           stat = "identity") +
  facet_grid(~ species, switch = "x") +
  scale_fill_manual(values = c('gray20', 'gray50')) +
  scale_y_continuous(breaks = c(0, 25, 50)) +
  theme_bw() +
  labs(y = 'Count', fill = 'Species Present?') +
  theme(strip.placement = "outside",
        strip.background = element_rect(fill = NA, color = "white"),
        panel.spacing = unit(-.01,"cm"),
        axis.title.y = element_text(face = 'bold', size = 18),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 16, vjust = 1),
        axis.text.y = element_text(size = 16),
        strip.text = element_text(face = 'italic', size = 18),
        legend.title = element_text(face = 'bold', size = 16),
        legend.text = element_text(size = 14),
        panel.border = element_blank(),
        panel.grid.major.x = element_blank(),
        axis.ticks = element_blank(), 
        legend.position = 'right')
sd.te.species.comp
```

## Regressions
```{r}
abridged.sd.te.regressions <- main.df %>% 
    mutate(selfdefined_TE = case_when(selfdefined_TE == 'Y' ~ 'Trailing Edge',
                                 selfdefined_TE == 'N' ~ 'Non-Trailing Edge')) %>% 
    pivot_longer(cols = c(seedling.pct, log.regen.density), values_to = 'field_val', names_to = 'field_var')  %>% 
    ggplot(aes(x = postfire_fitted_slope, y = field_val, color = selfdefined_TE)) +
    geom_point(alpha = 0.8) +
    geom_smooth(alpha = 0.4, se = T, method = 'lm', fill = 'gray80') +
    labs(x = 'Post-fire Fitted Slope', y = '', color = ' ') +
    facet_wrap(~field_var, scales = 'free_y', labeller = as_labeller(field_var_names),
               ncol = 1, strip.position = 'left') +
    scale_color_manual(values = c('#A6A57A', '#A33B20')) +
    theme_bw() +
    theme(legend.position = 'top',
          strip.placement = 'outside',
          strip.background = element_blank(),
          legend.title = element_blank(),
          legend.text = element_text(face = 'bold', size = 18),
          axis.title = element_text(face = 'bold', size = 20),
          axis.text.x = element_text(size = 18),
          axis.text.y = element_text(size = 18),
          strip.text = element_text(face = 'bold', size = 20),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_blank())
abridged.sd.te.regressions

main.df %>%  
  pivot_longer(cols = c(cwd_present, cwd_future), names_to = 'cwd_var', values_to = 'cwd_val') %>%
    pivot_longer(cols = c(seedling.pct, log.seedling.density, log.regen.density), values_to = 'field_val', names_to = 'field_var')  %>% 
    ggplot(aes(x = cwd_val, y = field_val, color = selfdefined_TE)) +
    geom_point(alpha = 0.6) +
    geom_smooth(alpha = 0.8, se = F, method = 'lm') +
    labs(x = 'cwd Metrics', y = 'Field Metrics', color = 'Trailing Edge?') +
    facet_grid(field_var~cwd_var, scales = 'free', labeller = as_labeller(spectral_field_var_names)) +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))
```

