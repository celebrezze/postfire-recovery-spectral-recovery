---
title: "Field Data Visualizations"
author: "Joe Celebrezze"
date: "2023-05-26"
output: html_document
---
# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
here = here::here

source(here("scripts", "source_code.R"))
source(here("scripts", "mem.selection.function.R"))
library(ggpp)
library(ggfortify)
#library(ggpmisc)
library(leaflet)
library(corrplot)
library(factoextra)
library(cluster)
library(ggpubr)
library(sp)
library(terra)
library(ggridges)
library(av) # to save NBR animation
library(lme4) # for mixed effects models
library(lmerTest)
library(sjPlot) # for tab_model
library(kableExtra)
library(gtools)
library(performance)
extract = raster::extract
group_by = dplyr::group_by
```

2023 Field Data
```{r}
understory <- read.csv(here('data', 'field_data', 'field.data.understory.csv'))
colnames(understory)[1] <- 'Plot'
seedlings <- read.csv(here('data', 'field_data', 'field.data.seedlings.csv'))
colnames(seedlings)[1] <- 'Plot'
overview <- read.csv(here('data', 'field_data', 'field.data.overview.csv'))[,2:13]
colnames(overview)[1] <- 'Plot'
densiometer <- read.csv(here('data', 'field_data', 'field.data.densiometer.csv'))
trees <- read.csv(here('data', 'field_data', 'field.data.trees.csv'))[,1:9]

understory %>% 
  mutate(count = 1) %>% 
  group_by(cluster) %>% 
  summarise(n = (sum(count)/4))
```

2022 Field Data (Madeline's)
```{r}
field.data.2022 <- read.csv(here('data', 'field_data', 'Plot_FieldData_AllFires.csv'))[,2:20]
colnames(field.data.2022)[1] <- 'Plot'
```

https://emailwsu-my.sharepoint.com/:p:/r/personal/joseph_celebrezze_wsu_edu/Documents/NWCASC/NWCASC%20Field%20Data%20Update.pptx?d=w12aa0b656baa4249845b2fd494b86231&csf=1&web=1&e=YJJEIu

# Early Figures
## Understory Cover
### Data Wrangling
```{r}
understory.summary <- understory %>% 
  group_by(Plot) %>% 
  summarise(grass.pct = mean(grass.pct), herb.pct = mean(herb.pct), shrub.pct = mean(shrub.pct), seedling.pct = mean(seedling.pct), green.pct = mean(green.pct), npv.pct = mean(npv.pct), soil.pct = mean(soil.pct), cluster = cluster) %>% 
  drop_na(cluster) %>% 
  distinct()

understory.summary.long <- understory.summary %>% 
  pivot_longer(cols = !c(Plot, cluster), names_to = 'var', values_to = 'value')
```

### Boxplots
```{r}
understory.summary.long %>% 
  filter(cluster != 'X') %>% 
  ggplot(aes(x = as.factor(cluster), y = value, color = as.factor(cluster))) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = 0.1, height = 0.01, alpha = 0.4, aes(color = as.factor(cluster))) +
    facet_wrap(~var, scales = 'free_y') +
    labs(x = "Spectral Trajectory Cluster", y = " ") +
    theme_bw() +
    theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))
```

## Seedlings
### Data Wrangling
```{r}
seedlings.clean.spp <- seedlings %>% 
  mutate(DBH = as.numeric(DBH), Ht = as.numeric(Ht), Plot.Size = as.numeric(Plot.Size), count = 1) %>% 
  group_by(Plot) %>% 
  add_tally(wt = count) %>% 
  summarise(species = Spec, plot.size = Plot.Size, height = mean(Ht), dbh = mean(DBH), seed.tree = Seed.Tree, cluster = cluster, no.seedlings = ifelse(is.na(DBH), 0, n)) %>% 
  distinct() %>% 
  mutate(seedlings.per.msq = no.seedlings/plot.size,
         seed.tree = ifelse(seed.tree == '>300', '300', seed.tree),
         seed.tree = as.numeric(seed.tree))

seedlings.clean <- seedlings %>% 
  mutate(DBH = as.numeric(DBH), Ht = as.numeric(Ht), Plot.Size = as.numeric(Plot.Size), count = 1) %>% 
  group_by(Plot) %>% 
  add_tally(wt = count) %>% 
  summarise(plot.size = Plot.Size, height = mean(Ht), dbh = mean(DBH), cluster = cluster, no.seedlings = ifelse(is.na(DBH), 0, n)) %>% 
  distinct() %>% 
  mutate(seedlings.per.msq = no.seedlings/plot.size)

```

### Figures
```{r}
seedlings.clean %>% 
  filter(cluster != 'X') %>% 
  ggplot(aes(x = as.factor(cluster), y = log(seedlings.per.msq), color = as.factor(cluster))) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = 0.1, height = 0.01, alpha = 0.4, aes(color = as.factor(cluster))) +
    labs(x = "Spectral Trajectory Cluster", y = expression(bold(Log(Seedlings/m^2)))) +
    theme_bw() +
    theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))
```

## Trailing Edge vs. Forest
```{r}
seedlings.clean <- seedlings.clean %>% 
  mutate(forest.type = case_when(str_detect(Plot, 'FL') ~ 'Forest',
                                 str_detect(Plot, 'EA') ~ 'Forest',
                                 str_detect(Plot, 'CA') ~ 'Trailing Edge',
                                 str_detect(Plot, 'EG') ~ 'Trailing Edge'))

understory.summary.long <- understory.summary.long %>% 
  mutate(forest.type = case_when(str_detect(Plot, 'FL') ~ 'Forest',
                                 str_detect(Plot, 'EA') ~ 'Forest',
                                 str_detect(Plot, 'CA') ~ 'Trailing Edge',
                                 str_detect(Plot, 'EG') ~ 'Trailing Edge',
                                 str_detect(Plot, 'WH') ~ 'Trailing Edge'))

seedlings.clean %>% 
  filter(cluster != 'X') %>% 
  ggplot(aes(x = as.factor(cluster), y = log(seedlings.per.msq), color = as.factor(forest.type))) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = 0.1, height = 0.01, alpha = 0.4, aes(color = as.factor(forest.type))) +
    labs(x = "Spectral Trajectory Cluster", y = expression(bold(Log(Seedlings/m^2))), color = 'Forest vs. Trailing Edge') +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))

understory.summary.long %>% 
  filter(cluster != 'X') %>% 
  ggplot(aes(x = as.factor(cluster), y = value, color = as.factor(forest.type))) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = 0.1, height = 0.01, alpha = 0.4, aes(color = as.factor(forest.type))) +
    facet_wrap(~var, scales = 'free_y') +
    labs(x = "Spectral Trajectory Cluster", y = " ", color = 'Forest vs. Trailing Edge') +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))
```

## Densiometer
### Data Wrangling
Note: we will need to decide on how to combine this with Madeline's densiometer data; I'm assuming she did something similar to below, but I'm unsure. Also, we need to figure out whether or not we want to include dead trees in the densiometer reading. I made note whenever it was a dead tree rather than a seedling, sapling, young tree or shrub (also note I'm omitting the shrub densiometer readings from the below analysis for now)
```{r}
densiometer.clean <- densiometer %>% 
  mutate(NESW = (N + E + S + W)/.96) %>%  # % canopy cover (24 squares for each measurement, 96 total)
  group_by(Plot) %>% 
  summarise(densiometer = mean(NESW))
```

## Trees
### Data Wrangling
I really don't know what to do with the trees data, but I think one potential use for them is as another regeneration metric (with the postfire regen. alive young trees indicating regen); I did this below, but still need to think of how to use the rest of the data
```{r}
trees.clean <- trees %>% 
  mutate(count = 1) %>% 
  group_by(Plot) %>% 
  add_tally(wt = ifelse(Status == 'A', count, 0)) %>% 
  rename(no.young.trees = n) %>% 
  distinct() %>% 
  group_by(Plot) %>% 
  summarise(no.young.trees = sum(no.young.trees))
```

## Combined w/ 2022 Data
```{r}
seedlings.merge <- seedlings.clean %>% 
  group_by(Plot) %>% 
  summarise(seedlings.per.msq = max(seedlings.per.msq))

field.data.2023 <- merge(overview, understory.summary, by = 'Plot')
field.data.2023 <- merge(seedlings.merge, field.data.2023, by = 'Plot')
field.data.2023 <- merge(densiometer.clean, field.data.2023, by = 'Plot')
```

```{r}
field.data.2022.clean <- field.data.2022 %>% 
  filter(MTBS_sev > 3) %>% 
  select(Plot, Fire, Long, Lat, grass_cover, herb_cover, shrub_cover, seedling_cover, green_cover_total, npv_cover_total, seedling_density, densiometer, aspect, slope) %>% 
  rename(grass.pct = grass_cover, herb.pct = herb_cover, shrub.pct = shrub_cover, seedling.pct = seedling_cover, seedling.density = seedling_density, green.pct = green_cover_total, npv.pct = npv_cover_total) %>% 
  mutate(year = 2022)

field.data.2023.clean <- field.data.2023 %>% 
  mutate(Fire = case_when(str_detect(Plot, 'FL') ~ 'Flagtail',
                                 str_detect(Plot, 'EA') ~ 'Easy',
                                 str_detect(Plot, 'CA') ~ 'Calamity',
                                 str_detect(Plot, 'EG') ~ 'Egley',
                                 str_detect(Plot, 'WH') ~ 'Wheeler')) %>% 
  mutate(seedling.density = 10000*seedlings.per.msq) %>% # converting it to seedlings/hectare
  rename(aspect = Azimuth, slope = Slope) %>% 
  select(Plot, Fire, Long, Lat, grass.pct, herb.pct, shrub.pct, seedling.pct, green.pct, npv.pct, aspect, slope, seedling.density, densiometer) %>% 
  mutate(year = 2023)

field.data.both <- rbind(field.data.2022.clean, field.data.2023.clean)

field.data.both %>%
  mutate(log.seedling.density = log(seedling.density)) %>% 
  pivot_longer(cols = !c(Plot, Fire, Lat, Long, aspect, year), names_to = 'var', values_to = 'val') %>% 
  ggplot(aes(x = val, fill = var)) +
  geom_density() +
  facet_wrap(~var, scales = 'free') +
  theme_bw() +
  labs(x = ' ', y = 'Density') +
  theme(legend.position = "none",
        axis.title = element_text(face = 'bold', size = 14),
        axis.text.x = element_text(size = 12, angle = 20),
        axis.text.y = element_text(size = 12),
        legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(size = 12))


field.data.both %>%
  mutate(log.seedling.density = log(seedling.density)) %>% 
  pivot_longer(cols = !c(Plot, Fire, Lat, Long, aspect, year, seedling.density), names_to = 'var', values_to = 'val') %>% 
  ggplot(aes(x = as.factor(year), y = val, color = as.factor(year))) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = 0.1, height = 0.01, alpha = 0.4, aes(color = as.factor(year))) +
    facet_wrap(~var, scales = 'free') +
    labs(x = "Sampling Year", y = " ") +
    theme_bw() +
    theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))
```

## Differences between fires (2023)
```{r}
field.data.both %>% 
  #filter(seedling.density < 200) %>% 
  group_by(Fire) %>% 
  tally()

seedlings.clean <- seedlings.clean %>% 
  mutate(fire = case_when(str_detect(Plot, 'FL') ~ 'Flagtail',
                                 str_detect(Plot, 'EA') ~ 'Easy',
                                 str_detect(Plot, 'CA') ~ 'Calamity',
                                 str_detect(Plot, 'EG') ~ 'Egley',
                                 str_detect(Plot, 'WH') ~ 'Wheeler'))

understory.summary.long <- understory.summary.long %>% 
  mutate(fire = case_when(str_detect(Plot, 'FL') ~ 'Flagtail',
                                 str_detect(Plot, 'EA') ~ 'Easy',
                                 str_detect(Plot, 'CA') ~ 'Calamity',
                                 str_detect(Plot, 'EG') ~ 'Egley',
                                 str_detect(Plot, 'WH') ~ 'Wheeler'))

seedlings.clean %>% 
  filter(cluster != 'X') %>% 
  ggplot(aes(x = as.factor(cluster), y = log(seedlings.per.msq), color = as.factor(cluster))) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = 0.1, height = 0.01, alpha = 0.4, aes(color = as.factor(cluster))) +
    facet_wrap(~fire, scales = 'free_y') +
    labs(x = "Spectral Trajectory Cluster", y = expression(bold(Log(Seedlings/m^2)))) +
    theme_bw() +
    theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))

understory.summary.long %>% 
  filter(cluster != 'X') %>% 
  filter(var %in% c('grass.pct', 'herb.pct', 'shrub.pct', 'seedling.pct')) %>% 
  ggplot(aes(x = as.factor(cluster), y = value, color = as.factor(cluster))) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = 0.1, height = 0.01, alpha = 0.4, aes(color = as.factor(cluster))) +
    facet_grid(fire~var, scales = 'free_y') +
    labs(x = "Spectral Trajectory Cluster", y = " ", color = 'Fire') +
    theme_bw() +
    theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))
```

# --------------------

# Cluster Analysis
## Rasters
```{r}
# Blue Mtns. Raster
blue.mtns.ras <- raster(here('data', 'blue_mtns_misc', 'bluemtnsras.tif'))
# Postfire Regen. Data (Davis et al)
postfire.regen <- raster(here('data', 'regen_prob', 'postfire_regen_prob.tif'))
# Canopy Cover Data
canopy.cover <- raster(here('data', 'site_selection', 'LANDFIRE_2001_Canopy_Cover', 'us_105cc.tif'))
# Vegetation Height Data
veg.height <- raster(here('data', 'site_selection', 'LANDFIRE_2001_Veg_Height', 'us_105evh.tif'))
# Fuel Veg Height Data
fuel.veg.height <- raster(here('data', 'site_selection', 'LANDFIRE_2022_Fuel_Veg_Height', 'LC22_FVH_230.tif'))
# Fuel Cover Data
fuel.cover <- raster(here('data', 'site_selection', 'LANDFIRE_2022_Fuel_Cover', 'LC22_FVC_230.tif'))
# NBR Data
## 2023 Field Data
nbr_Egley <- raster::stack(here('data',   'site_selection', 'Egley_nbr.tif'))
nbr_Easy <- raster::stack(here('data',   'site_selection', 'Easy_nbr.tif'))
nbr_Calamity <- raster::stack(here('data',   'site_selection', 'Calamity_nbr.tif'))
nbr_Flagtail <- raster::stack(here('data',   'site_selection', 'Flagtail_nbr.tif'))
nbr_Wheeler <- raster::stack(here('data',   'site_selection', 'Wheeler_nbr.tif'))
## 2022 Field Data
nbr_BC <- raster::stack(here('data',   'site_selection', 'BC_nbr.tif'))
nbr_HR <- raster::stack(here('data',   'site_selection', 'HR_nbr.tif'))
nbr_School <- raster::stack(here('data',   'site_selection', 'School_nbr.tif'))
#nbr_Tower <- raster::stack(here('data',   'site_selection', 'Tower_nbr.tif'))

# CHILI Data
chili_Egley <- raster(here('data',   'site_selection', 'CHILI_Egley.tif'))
chili_Easy <- raster(here('data',   'site_selection', 'CHILI_Easy.tif'))
chili_Calamity <- raster(here('data',   'site_selection', 'CHILI_Calamity.tif'))
chili_Flagtail <- raster(here('data',   'site_selection', 'CHILI_Flagtail.tif'))
chili_Wheeler <- raster(here('data',   'site_selection', 'CHILI_WheelerPoint.tif'))
chili_BC <- raster(here('data',   'site_selection', 'CHILI_BridgeCreek.tif'))
chili_HR <- raster(here('data',   'site_selection', 'CHILI_HashRock.tif'))
chili_School <- raster(here('data',   'site_selection', 'CHILI_School.tif'))
#chili_Tower <- raster(here('data',   'site_selection', 'CHILI_Tower.tif'))
```

# *Field Sites
### 2022
Note: crs proj string: '+proj=longlat +datum=WGS84 +no_defs', but w/ updated packages, use of proj string seems like it's deprecated (?)
```{r}
BC_df <- field.data.2022.clean %>%
  filter(Fire == 'Bridge Creek')
xy <- BC_df[,c(3,4)] # define coordinates
BC_pts <- BC_df %>% 
  select(Long, Lat, Plot) %>% 
  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_BC)) # transform data to spatial points

HR_df <- field.data.2022.clean %>%
  filter(Fire == 'Hash Rock')
xy <- HR_df[,c(3,4)] # define coordinates
HR_pts <- HR_df %>% 
  select(Long, Lat, Plot) %>% 
  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_HR)) # transform data to spatial points

School_df <- field.data.2022.clean %>%
  filter(Fire == 'School')
xy <- School_df[,c(3,4)] # define coordinates
School_pts <- School_df %>% 
  select(Long, Lat, Plot) %>% 
  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_School)) # transform data to spatial points

#Tower_df <- field.data.2022.clean %>%
#  filter(Fire == 'Tower')
#xy <- Tower_df[,c(3,4)] # define coordinates
#Tower_pts <- Tower_df %>% 
#  select(Long, Lat, Plot) %>% 
#  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_Tower)) # transform data to spatial points
```

### 2023
```{r}
# Getting rid of NA value
field.data.2023.Sp <- field.data.2023.clean %>% 
  drop_na(Long)

# Egley Fire
Egley_df <- field.data.2023.Sp %>% 
  filter(Fire == 'Egley')
xy <- Egley_df[,c(3,4)] # define coordinates
Egley_pts <- Egley_df %>% 
  select(Long, Lat, Plot) %>% 
  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_Egley)) # transform data to spatial points

# Calamity Fire
Calamity_df <- field.data.2023.Sp %>% 
  filter(Fire == 'Calamity')
xy <- Calamity_df[,c(3,4)] # define coordinates
Calamity_pts <- Calamity_df %>% 
  select(Long, Lat, Plot) %>% 
  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_Calamity)) # transform data to spatial points

# Flagtail Fire
Flagtail_df <- field.data.2023.Sp %>% 
  filter(Fire == 'Flagtail')
xy <- Flagtail_df[,c(3,4)] # define coordinates
Flagtail_pts <- Flagtail_df %>% 
  select(Long, Lat, Plot) %>% 
  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_Flagtail)) # transform data to spatial points

# Easy Fire
Easy_df <- field.data.2023.Sp %>% 
  filter(Fire == 'Easy')
xy <- Easy_df[,c(3,4)] # define coordinates
Easy_pts <- Easy_df %>% 
  select(Long, Lat, Plot) %>% 
  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_Easy)) # transform data to spatial points

# Wheeler Point Fire
Wheeler_df <- field.data.2023.Sp %>% 
  filter(Fire == 'Wheeler')
xy <- Wheeler_df[,c(3,4)] # define coordinates
Wheeler_pts <- Wheeler_df %>% 
  select(Long, Lat, Plot) %>% 
  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_Wheeler)) # transform data to spatial points
```

## NBR Data
```{r, warning = FALSE}
#change band names
names(nbr_BC) <- as.character(c(1984:2021))
names(nbr_HR) <- as.character(c(1984:2021))
names(nbr_School) <- as.character(c(1984:2021))
#names(nbr_Tower) <- as.character(c(1984:2021))
names(nbr_Egley) <- as.character(c(1984:2021))
names(nbr_Calamity) <- as.character(c(1984:2021))
names(nbr_Flagtail) <- as.character(c(1984:2021))
names(nbr_Easy) <- as.character(c(1984:2021))
names(nbr_Wheeler) <- as.character(c(1984:2021))

# extract values from the rasters using the generated points
vals_BC <- as.data.frame(extract(nbr_BC, BC_pts)) %>% 
  mutate(fire = 'BC')
vals_HR <- as.data.frame(extract(nbr_HR, HR_pts)) %>% 
  mutate(fire = 'HR')
vals_School <- as.data.frame(extract(nbr_School, School_pts)) %>% 
  mutate(fire = 'School')
#vals_Tower <- as.data.frame(extract(nbr_Tower, Tower_pts)) %>% 
#  mutate(fire = 'Tower')
vals_Egley <- as.data.frame(extract(nbr_Egley, Egley_pts)) %>% 
  mutate(fire = 'Egley')
vals_Calamity <- as.data.frame(extract(nbr_Calamity, Calamity_pts)) %>% 
  mutate(fire = 'Calamity')
vals_Flagtail <- as.data.frame(extract(nbr_Flagtail, Flagtail_pts)) %>% 
  mutate(fire = 'Flagtail')
vals_Easy <- as.data.frame(extract(nbr_Easy, Easy_pts)) %>% 
  mutate(fire = 'Easy')
vals_Wheeler <- as.data.frame(extract(nbr_Wheeler, Wheeler_pts)) %>% 
  mutate(fire = 'Wheeler')

# add x and y coordinates to nbr values dataframes
coords_BC <- as.data.frame(BC_pts)
vals_BC <- cbind(coords_BC, vals_BC)
coords_HR <- as.data.frame(HR_pts)
vals_HR <- cbind(coords_HR, vals_HR)
coords_School <- as.data.frame(School_pts)
vals_School <- cbind(coords_School, vals_School)
#coords_Tower <- as.data.frame(Tower_pts)
#vals_Tower <- cbind(coords_Tower, vals_Tower)
coords_Egley <- as.data.frame(Egley_pts)
vals_Egley <- cbind(coords_Egley, vals_Egley)
coords_Calamity <- as.data.frame(Calamity_pts)
vals_Calamity <- cbind(coords_Calamity, vals_Calamity)
coords_Flagtail <- as.data.frame(Flagtail_pts)
vals_Flagtail <- cbind(coords_Flagtail, vals_Flagtail)
coords_Easy <- as.data.frame(Easy_pts)
vals_Easy <- cbind(coords_Easy, vals_Easy)
coords_Wheeler <- as.data.frame(Wheeler_pts)
vals_Wheeler <- cbind(coords_Wheeler, vals_Wheeler)

# merge the individual fires into one dataframe
vals_2022 <- rbind(vals_BC, vals_HR, vals_School) %>% 
  select(-Long.1, -Lat.1)
vals_2023 <- rbind(vals_Egley, vals_Calamity, vals_Flagtail, vals_Easy, vals_Wheeler) %>% 
  select(-Long.1, -Lat.1)
vals_all_fires <- rbind(vals_2022, vals_2023)
```

### Egley NBR
```{r}
av_capture_graphics(raster::animate(nbr_Egley, n = 1), output = file.path(here('figures', 'Egley_nbr.gif')), framerate = 0.75, vfilter = "null", audio = NULL, verbose = TRUE)
```

# *Adding in Random Sample
Because the 84 datapoints used in the fieldwork may be too limited to run a solid k-means cluster analysis, my thought was to combine the 84 datapoints with a random selection of datapoints from high severity burn in each of the fires and run a k-means cluster analysis on this enhanced dataset before comparing the field data to the clusters

## MTBS Data
```{r}
# 2022 Fires
school.fire <- raster(here('data',   'site_selection', 'school_severity.tif'))
#tower.fire <- raster(here('data',   'site_selection', 'tower_severity.tif'))
BC.fire <- raster(here('data',   'site_selection', 'bridge_creek_severity.tif'))
HR.fire <- raster(here('data',   'site_selection', 'hash_rock_severity.tif'))
# 2023 Fires
egley.fire <- raster(here('data',   'site_selection', 'egley_severity.tif'))
easy.fire <- raster(here('data',   'site_selection', 'easy_severity.tif'))
calamity.fire <- raster(here('data',   'site_selection', 'calamity_severity.tif'))
flagtail.fire <- raster(here('data',   'site_selection', 'flagtail_severity.tif'))
wheeler.fire <- raster(here('data',   'site_selection', 'wheeler_severity.tif'))
```

## Random Selection of High Severity Burn Points
For this random selection, I based the # of points on the acres of high severity burn available as shown:
School: 5468 acres high severity
Tower: 17828 acres high severity (note: removed because we only have one point in 'high severity' burn)
Bridge Creek: 238 acres high severity
Hash Rock: 2967 acres high severity
Easy: 1143 acres high severity
Flagtail: 2843 acres high severity
Egley: 20855 acres high severity
Calamity: 304 acres high severity
Wheeler Point: 3098 acres high severity
Total: 51646 acres high severity

Let's randomly select ~2580 points in addition to our field plots, so each of the # of acres of high severity burn can be divided by 20 when randomly selecting points

Buffering points proof-of-concept
```{r}
source(here("scripts", "sample_random_dist.R"))

egley.fire <- projectRaster(egley.fire, crs = crs(postfire.regen))

# Buffered approach (using function from AJM)
index_xy = which(egley.fire[] == 4)
xy_coord = coordinates(egley.fire)
x_in_arr = xy_coord[index_xy,1]
y_in_arr = xy_coord[index_xy,2]
egley.fire.df.buffered = sample_random_dist(x_in_arr,y_in_arr,num_points=2086,distance=0.003273548,seed=16) # although not exact, 0.003272548 degrees in the long-lat system is approx. equal to 300m in the UTM system

# Old approach (no buffering)
set.seed(16)
egley.fire.df <- as.data.frame(rasterToPoints(egley.fire)) %>% 
  filter(egley_severity == 4) # only high severity
egley.fire.df <- sample_n(egley.fire.df, 2086) # sample 2086 points

# Map
severity.pal <- colorNumeric(c('transparent', "#fdccb8", "#fc8f6f", '#f44d37', '#c5161b', 'darkred'), values(egley.fire),
  na.color = "transparent")

leaflet() %>% 
  setView(lat = 44.7,lng = -119.4, zoom = 7) %>% 
  addProviderTiles(providers$Stamen.TopOSMRelief, group = 'Topographic Map') %>% #Topographic: Stamen.TopOSMRelief, Street: Esri.WorldStreetMap
  addRasterImage(egley.fire, colors = severity.pal, opacity = 0.5, group = 'Fire Severity') %>% 
  addCircleMarkers(data = egley.fire.df, lng = egley.fire.df$x, lat = egley.fire.df$y, radius = 3,
                   stroke = F, fillOpacity = 0.5, color = 'gray50',
                   group = 'Sampled Points: Old Method') %>% 
  addCircleMarkers(data = egley.fire.df.buffered, lng = egley.fire.df.buffered$x.arr,
                   lat = egley.fire.df.buffered$y.arr, radius = 3,
                   stroke = F, fillOpacity = 0.5, color = 'black',
                   group = 'Sampled Points: Buffered') %>% 
  addMeasure() %>% 
  addLayersControl(
    baseGroups = c('Topographic Map'),
    overlayGroups = c( 'Fire Severity', 'Sampled Points: Buffered', 'Sampled Points: Old Method'),
    options = layersControlOptions(collapsed = TRUE) 
  )
```

```{r}
# Egley
index_xy = which(egley.fire[] == 4)
xy_coord = coordinates(egley.fire)
x_in_arr = xy_coord[index_xy,1]
y_in_arr = xy_coord[index_xy,2]
egley.fire.df = sample_random_dist(x_in_arr,y_in_arr,num_points=1043,distance=0.003273548,seed=16)
xy <- egley.fire.df[,c(1,2)] # define coordinates
Egley_pts_R <- egley.fire.df %>% 
  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_Egley)) # transform data to spatial points

# School
index_xy = which(school.fire[] == 4)
xy_coord = coordinates(school.fire)
x_in_arr = xy_coord[index_xy,1]
y_in_arr = xy_coord[index_xy,2]
school.fire.df = sample_random_dist(x_in_arr,y_in_arr,num_points=274,distance=0.003273548,seed=16)
xy <- school.fire.df[,c(1,2)] # define coordinates
School_pts_R <- school.fire.df %>% 
  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_School)) # transform data to spatial points

# Tower
#index_xy = which(tower.fire[] == 4)
#xy_coord = coordinates(tower.fire)
#x_in_arr = xy_coord[index_xy,1]
#y_in_arr = xy_coord[index_xy,2]
#tower.fire.df = sample_random_dist(x_in_arr,y_in_arr,num_points=892,distance=0.003273548,seed=16)
#xy <- tower.fire.df[,c(1,2)] # define coordinates
#Tower_pts_R <- tower.fire.df %>% 
#  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_Tower)) # transform data to spatial points

# Bridge Creek
index_xy = which(BC.fire[] == 4)
xy_coord = coordinates(BC.fire)
x_in_arr = xy_coord[index_xy,1]
y_in_arr = xy_coord[index_xy,2]
BC.fire.df = sample_random_dist(x_in_arr,y_in_arr,num_points=12,distance=0.003273548,seed=16)
xy <- BC.fire.df[,c(1,2)] # define coordinates
BC_pts_R <- BC.fire.df %>% 
  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_BC)) # transform data to spatial points

# Hash Rock
index_xy = which(HR.fire[] == 4)
xy_coord = coordinates(HR.fire)
x_in_arr = xy_coord[index_xy,1]
y_in_arr = xy_coord[index_xy,2]
HR.fire.df = sample_random_dist(x_in_arr,y_in_arr,num_points=149,distance=0.003273548,seed=16)
xy <- HR.fire.df[,c(1,2)] # define coordinates
HR_pts_R <- HR.fire.df %>% 
  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_HR)) # transform data to spatial points

# Easy
index_xy = which(easy.fire[] == 4)
xy_coord = coordinates(easy.fire)
x_in_arr = xy_coord[index_xy,1]
y_in_arr = xy_coord[index_xy,2]
easy.fire.df = sample_random_dist(x_in_arr,y_in_arr,num_points=58,distance=0.003273548,seed=16)
xy <- easy.fire.df[,c(1,2)] # define coordinates
Easy_pts_R <- easy.fire.df %>% 
  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_Easy)) # transform data to spatial points

# Flagtail
index_xy = which(flagtail.fire[] == 4)
xy_coord = coordinates(flagtail.fire)
x_in_arr = xy_coord[index_xy,1]
y_in_arr = xy_coord[index_xy,2]
flagtail.fire.df = sample_random_dist(x_in_arr,y_in_arr,num_points=143,distance=0.003273548,seed=16)
xy <- flagtail.fire.df[,c(1,2)] # define coordinates
Flagtail_pts_R <- flagtail.fire.df %>% 
  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_Flagtail)) # transform data to spatial points

# Calamity
index_xy = which(calamity.fire[] == 4)
xy_coord = coordinates(calamity.fire)
x_in_arr = xy_coord[index_xy,1]
y_in_arr = xy_coord[index_xy,2]
calamity.fire.df = sample_random_dist(x_in_arr,y_in_arr,num_points=16,distance=0.003273548,seed=16)
xy <- calamity.fire.df[,c(1,2)] # define coordinates
Calamity_pts_R <- calamity.fire.df %>% 
  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_Calamity)) # transform data to spatial points

# Wheeler
index_xy = which(wheeler.fire[] == 4)
xy_coord = coordinates(wheeler.fire)
x_in_arr = xy_coord[index_xy,1]
y_in_arr = xy_coord[index_xy,2]
Wheeler.fire.df = sample_random_dist(x_in_arr,y_in_arr,num_points=155,distance=0.003273548,seed=16)
xy <- Wheeler.fire.df[,c(1,2)] # define coordinates
Wheeler_pts_R <- Wheeler.fire.df %>% 
  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_Wheeler)) # transform data to spatial points
```

## NBR Data
```{r, warning = FALSE}
# extract values from the rasters using the generated points
vals_R_BC <- as.data.frame(extract(nbr_BC, BC_pts_R)) %>% 
  mutate(fire = 'BC')
vals_R_HR <- as.data.frame(extract(nbr_HR, HR_pts_R)) %>% 
  mutate(fire = 'HR')
vals_R_School <- as.data.frame(extract(nbr_School, School_pts_R)) %>% 
  mutate(fire = 'School')
#vals_R_Tower <- as.data.frame(extract(nbr_Tower, Tower_pts_R)) %>% 
#  mutate(fire = 'Tower')
vals_R_Egley <- as.data.frame(extract(nbr_Egley, Egley_pts_R)) %>% 
  mutate(fire = 'Egley')
vals_R_Calamity <- as.data.frame(extract(nbr_Calamity, Calamity_pts_R)) %>% 
  mutate(fire = 'Calamity')
vals_R_Flagtail <- as.data.frame(extract(nbr_Flagtail, Flagtail_pts_R)) %>% 
  mutate(fire = 'Flagtail')
vals_R_Easy <- as.data.frame(extract(nbr_Easy, Easy_pts_R)) %>% 
  mutate(fire = 'Easy')
vals_R_Wheeler <- as.data.frame(extract(nbr_Wheeler, Wheeler_pts_R)) %>% 
  mutate(fire = 'Wheeler')

# add x and y coordinates to nbr values dataframes
coords_BC <- as.data.frame(BC_pts_R)
vals_R_BC <- cbind(coords_BC, vals_R_BC)
coords_HR <- as.data.frame(HR_pts_R)
vals_R_HR <- cbind(coords_HR, vals_R_HR)
coords_School <- as.data.frame(School_pts_R)
vals_R_School <- cbind(coords_School, vals_R_School)
#coords_Tower <- as.data.frame(Tower_pts_R)
#vals_R_Tower <- cbind(coords_Tower, vals_R_Tower)
coords_Egley <- as.data.frame(Egley_pts_R)
vals_R_Egley <- cbind(coords_Egley, vals_R_Egley)
coords_Calamity <- as.data.frame(Calamity_pts_R)
vals_R_Calamity <- cbind(coords_Calamity, vals_R_Calamity)
coords_Flagtail <- as.data.frame(Flagtail_pts_R)
vals_R_Flagtail <- cbind(coords_Flagtail, vals_R_Flagtail)
coords_Easy <- as.data.frame(Easy_pts_R)
vals_R_Easy <- cbind(coords_Easy, vals_R_Easy)
coords_Wheeler <- as.data.frame(Wheeler_pts_R)
vals_R_Wheeler <- cbind(coords_Wheeler, vals_R_Wheeler)
woo <- rbind(vals_R_BC, vals_R_HR, vals_R_Calamity, vals_R_Easy, vals_R_Flagtail, vals_R_School, vals_R_Egley, vals_R_Wheeler)
```

## Removal of Non-Forest Pixels
Reprojecting Rasters
```{r}
# Canopy Cover
canopy.cover.egley <- projectRaster(from = canopy.cover, to = egley.fire, method = 'ngb')
canopy.cover.HR <- projectRaster(from = canopy.cover, to = HR.fire, method = 'ngb')
canopy.cover.easy <- projectRaster(from = canopy.cover, to = easy.fire, method = 'ngb')
canopy.cover.calamity <- projectRaster(from = canopy.cover, to = calamity.fire, method = 'ngb')
canopy.cover.flagtail <- projectRaster(from = canopy.cover, to = flagtail.fire, method = 'ngb')
canopy.cover.BC <- projectRaster(from = canopy.cover, to = BC.fire, method = 'ngb')
canopy.cover.school <- projectRaster(from = canopy.cover, to = school.fire, method = 'ngb')
#canopy.cover.tower <- projectRaster(from = canopy.cover, to = tower.fire, method = 'ngb')
canopy.cover.wheeler <- projectRaster(from = canopy.cover, to = wheeler.fire, method = 'ngb')

# Veg Height
veg.height.egley <- projectRaster(from = veg.height, to = egley.fire, method = 'ngb')
veg.height.HR <- projectRaster(from = veg.height, to = HR.fire, method = 'ngb')
veg.height.easy <- projectRaster(from = veg.height, to = easy.fire, method = 'ngb')
veg.height.calamity <- projectRaster(from = veg.height, to = calamity.fire, method = 'ngb')
veg.height.flagtail <- projectRaster(from = veg.height, to = flagtail.fire, method = 'ngb')
veg.height.BC <- projectRaster(from = veg.height, to = BC.fire, method = 'ngb')
veg.height.school <- projectRaster(from = veg.height, to = school.fire, method = 'ngb')
#veg.height.tower <- projectRaster(from = veg.height, to = tower.fire, method = 'ngb')
veg.height.wheeler <- projectRaster(from = veg.height, to = wheeler.fire, method = 'ngb')

# For wheeler point and hash rock fires, the fire was prior to the 2001 LANDFIRE data used above; instead, for these, going to try to use 2022 fuel vegetation height and fuel vegetation cover data which claims to do better at estimating pre-disturbance conditions
fvh.HR <- projectRaster(from = fuel.veg.height, to = HR.fire, method = 'ngb')
fvc.HR <- projectRaster(from = fuel.cover, to = HR.fire, method = 'ngb')
fvh.wheeler <- projectRaster(from = fuel.veg.height, to = wheeler.fire, method = 'ngb')
fvc.wheeler <- projectRaster(from = fuel.cover, to = wheeler.fire, method = 'ngb')
```

Extracting data, then removing non-forest pixels ('forest' is defined as >= 25% and veg. height >= 5m; but for wheeler point and hash rock, canopy cover for fuels (disturbance-corrected) is only in bins of 10% so used >= 20% in this case)
```{r}
cc_egley <- as.data.frame(extract(canopy.cover.egley, Egley_pts_R))
evh_egley <- as.data.frame(extract(veg.height.egley, Egley_pts_R))
vals_R_Egley <- cbind(vals_R_Egley, cc_egley, evh_egley) %>% 
  rename(canopy_cover = `extract(canopy.cover.egley, Egley_pts_R)`) %>% 
  rename(veg_height = `extract(veg.height.egley, Egley_pts_R)`) %>% 
  filter(canopy_cover >= 25) %>% 
  filter(veg_height %in% c(109, 110, 111, 112)) # Note (reiterated from above): veg height is in classes and the classes represent the following - 109 = forest 5-10m, 110 = forest 10-25m, 111 = forest 25-50m, 112 = forest >50m

cc_easy <- as.data.frame(extract(canopy.cover.easy, Easy_pts_R))
evh_easy <- as.data.frame(extract(veg.height.easy, Easy_pts_R))
vals_R_Easy <- cbind(vals_R_Easy, cc_easy, evh_easy) %>% 
  rename(canopy_cover = `extract(canopy.cover.easy, Easy_pts_R)`) %>% 
  rename(veg_height = `extract(veg.height.easy, Easy_pts_R)`) %>% 
  filter(canopy_cover >= 25) %>% 
  filter(veg_height %in% c(109, 110, 111, 112))

cc_calamity <- as.data.frame(extract(canopy.cover.calamity, Calamity_pts_R))
evh_calamity <- as.data.frame(extract(veg.height.calamity, Calamity_pts_R))
vals_R_Calamity <- cbind(vals_R_Calamity, cc_calamity, evh_calamity) %>% 
  rename(canopy_cover = `extract(canopy.cover.calamity, Calamity_pts_R)`) %>% 
  rename(veg_height = `extract(veg.height.calamity, Calamity_pts_R)`) %>% 
  filter(canopy_cover >= 25) %>% 
  filter(veg_height %in% c(109, 110, 111, 112))

cc_flagtail <- as.data.frame(extract(canopy.cover.flagtail, Flagtail_pts_R))
evh_flagtail <- as.data.frame(extract(veg.height.flagtail, Flagtail_pts_R))
vals_R_Flagtail <- cbind(vals_R_Flagtail, cc_flagtail, evh_flagtail) %>% 
  rename(canopy_cover = `extract(canopy.cover.flagtail, Flagtail_pts_R)`) %>% 
  rename(veg_height = `extract(veg.height.flagtail, Flagtail_pts_R)`) %>% 
  filter(canopy_cover >= 25) %>% 
  filter(veg_height %in% c(109, 110, 111, 112))

cc_wheeler <- as.data.frame(extract(canopy.cover.wheeler, Wheeler_pts_R))
evh_wheeler <- as.data.frame(extract(veg.height.wheeler, Wheeler_pts_R))
fvh_wheeler <- as.data.frame(extract(fvh.wheeler, Wheeler_pts_R))
fvc_wheeler <- as.data.frame(extract(fvc.wheeler, Wheeler_pts_R))
vals_R_Wheeler <- cbind(vals_R_Wheeler, cc_wheeler, evh_wheeler, fvh_wheeler, fvc_wheeler) %>% 
  rename(canopy_cover = `extract(canopy.cover.wheeler, Wheeler_pts_R)`) %>% 
  rename(veg_height = `extract(veg.height.wheeler, Wheeler_pts_R)`) %>% 
  rename(fuel_cover = `extract(fvc.wheeler, Wheeler_pts_R)`) %>% 
  rename(fuel_veg_height = `extract(fvh.wheeler, Wheeler_pts_R)`) %>% 
  filter(fuel_veg_height >= 607) %>%  # denoting forest height > 5m
  filter(fuel_cover %in% c(102, 103, 104, 105, 106, 107, 108, 109)) %>%  # canopy cover > 20% (!!)
  select(-fuel_cover, -fuel_veg_height) # so rbind works below
  #filter(canopy_cover >= 25) %>% 
  #filter(veg_height %in% c(109, 110, 111, 112))

#xy <- vals_HR[,c(1,2)] # define coordinates
#HR_pts <- vals_R_HR %>% 
#  SpatialPointsDataFrame(coords = xy, proj4string = crs('+proj=longlat +datum=WGS84 +no_defs')) # transform data to spatial points
cc_HR <- as.data.frame(extract(canopy.cover.HR, HR_pts_R))
evh_HR <- as.data.frame(extract(veg.height.HR, HR_pts_R))
fvh_HR <- as.data.frame(extract(fvh.HR, HR_pts_R))
fvc_HR <- as.data.frame(extract(fvc.HR, HR_pts_R))
vals_R_HR <- cbind(vals_R_HR, cc_HR, evh_HR, fvh_HR, fvc_HR) %>% 
  rename(canopy_cover = `extract(canopy.cover.HR, HR_pts_R)`) %>% 
  rename(veg_height = `extract(veg.height.HR, HR_pts_R)`) %>% 
  rename(fuel_cover = `extract(fvc.HR, HR_pts_R)`) %>% 
  rename(fuel_veg_height = `extract(fvh.HR, HR_pts_R)`) %>% 
  filter(fuel_veg_height >= 607) %>%  # denoting forest height > 5m
  filter(fuel_cover %in% c(102, 103, 104, 105, 106, 107, 108, 109)) %>%  # canopy cover > 20% (!!)
  select(-fuel_cover, -fuel_veg_height) # so rbind works below
  #filter(canopy_cover >= 25) %>% 
  #filter(veg_height %in% c(109, 110, 111, 112))

cc_school <- as.data.frame(extract(canopy.cover.school, School_pts_R))
evh_school <- as.data.frame(extract(veg.height.school, School_pts_R))
vals_R_School <- cbind(vals_R_School, cc_school, evh_school) %>% 
  rename(canopy_cover = `extract(canopy.cover.school, School_pts_R)`) %>% 
  rename(veg_height = `extract(veg.height.school, School_pts_R)`) %>% 
  filter(canopy_cover >= 25) %>% 
  filter(veg_height %in% c(109, 110, 111, 112)) # Note (reiterated from above): veg height is in classes and the classes represent the following - 109 = forest 5-10m, 110 = forest 10-25m, 111 = forest 25-50m, 112 = forest >50m

cc_BC <- as.data.frame(extract(canopy.cover.BC, BC_pts_R))
evh_BC <- as.data.frame(extract(veg.height.BC, BC_pts_R))
vals_R_BC <- cbind(vals_R_BC, cc_BC, evh_BC) %>% 
  rename(canopy_cover = `extract(canopy.cover.BC, BC_pts_R)`) %>% 
  rename(veg_height = `extract(veg.height.BC, BC_pts_R)`) %>% 
  filter(canopy_cover >= 25) %>% 
  filter(veg_height %in% c(109, 110, 111, 112)) # Note (reiterated from above): veg height is in classes and the classes represent the following - 109 = forest 5-10m, 110 = forest 10-25m, 111 = forest 25-50m, 112 = forest >50m

#cc_tower <- as.data.frame(extract(canopy.cover.tower, Tower_pts_R))
#evh_tower <- as.data.frame(extract(veg.height.tower, Tower_pts_R))
#vals_R_Tower <- cbind(vals_R_Tower, cc_tower, evh_tower) %>% 
#  rename(canopy_cover = `extract(canopy.cover.tower, Tower_pts_R)`) %>% 
#  rename(veg_height = `extract(veg.height.tower, Tower_pts_R)`) %>% 
#  filter(canopy_cover >= 25) %>% 
#  filter(veg_height %in% c(109, 110, 111, 112)) # Note (reiterated from above): veg height is in classes and the classes represent the following - 109 = forest 5-10m, 110 = forest 10-25m, 111 = forest 25-50m, 112 = forest >50m
```

## Full Dataset
```{r}
# merge the individual fires into one dataframe
vals_R_all_fires <- rbind(vals_R_BC, vals_R_HR, vals_R_School, vals_R_Egley, vals_R_Calamity, vals_R_Flagtail, vals_R_Easy, vals_R_Wheeler) %>% 
  select(-x.arr.1, -y.arr.1, -canopy_cover, -veg_height) %>% 
  mutate(Plot = NA) %>% 
  rename(Long = x.arr, Lat = y.arr)

# folding in the field data points
vals_enhanced_all_fires <- rbind(vals_all_fires, vals_R_all_fires)
```

Now, we'll follow the exact same protocol as above, but with the significantly larger dataset

## CHILI Data
```{r}
# Reprojecting rasters to match MTBS rasters
chili_Egley <- projectRaster(from = chili_Egley, to = egley.fire, method = 'ngb')
chili_Easy <- projectRaster(from = chili_Easy, to = easy.fire, method = 'ngb')
chili_Calamity <- projectRaster(from = chili_Calamity, to = calamity.fire, method = 'ngb')
chili_Flagtail <- projectRaster(from = chili_Flagtail, to = flagtail.fire, method = 'ngb')
chili_HR <- projectRaster(from = chili_HR, to = HR.fire, method = 'ngb')
chili_School <- projectRaster(from = chili_School, to = school.fire, method = 'ngb')
chili_BC <- projectRaster(from = chili_BC, to = BC.fire, method = 'ngb')
#chili_Tower <- projectRaster(from = chili_Tower, to = tower.fire, method = 'ngb')
chili_Wheeler <- projectRaster(from = chili_Wheeler, to = wheeler.fire, method = 'ngb')

# Converting points from vals_enhanced_all_fires to spatial points dataframe to extract from rasters
xy <- vals_enhanced_all_fires[,c(1,2)] # define coordinates
all_pts <- vals_enhanced_all_fires %>%
  SpatialPointsDataFrame(coords = xy, proj4string = crs(nbr_Egley)) # transform data to spatial points

# Extracting data
# extract values from the rasters using the generated points
vals_chili_BC <- as.data.frame(extract(chili_BC, all_pts)) %>% 
  na.omit()
colnames(vals_chili_BC)[1] <- 'hli'
vals_chili_HR <- as.data.frame(extract(chili_HR, all_pts)) %>% 
  na.omit()
colnames(vals_chili_HR)[1] <- 'hli'
vals_chili_School <- as.data.frame(extract(chili_School, all_pts)) %>% 
  na.omit()
colnames(vals_chili_School)[1] <- 'hli'
#vals_chili_Tower <- as.data.frame(extract(chili_Tower, all_pts)) %>% 
#  na.omit()
#colnames(vals_chili_Tower)[1] <- 'hli'
vals_chili_Egley <- as.data.frame(extract(chili_Egley, all_pts)) %>% 
  na.omit()
colnames(vals_chili_Egley)[1] <- 'hli'
vals_chili_Calamity <- as.data.frame(extract(chili_Calamity, all_pts)) %>% 
  na.omit()
colnames(vals_chili_Calamity)[1] <- 'hli'
vals_chili_Flagtail <- as.data.frame(extract(chili_Flagtail, all_pts)) %>% 
  na.omit()
colnames(vals_chili_Flagtail)[1] <- 'hli'
vals_chili_Easy <- as.data.frame(extract(chili_Easy, all_pts)) %>% 
  na.omit()
colnames(vals_chili_Easy)[1] <- 'hli'
vals_chili_Wheeler <- as.data.frame(extract(chili_Wheeler, all_pts)) %>% 
  na.omit()
colnames(vals_chili_Wheeler)[1] <- 'hli'

# adding to data
BC_data <- vals_enhanced_all_fires %>% 
  filter(fire == 'BC')
vals_chili_BC <- cbind(BC_data, vals_chili_BC)
HR_data <- vals_enhanced_all_fires %>% 
  filter(fire == 'HR')
vals_chili_HR <- cbind(HR_data, vals_chili_HR)
School_data <- vals_enhanced_all_fires %>% 
  filter(fire == 'School')
vals_chili_School <- cbind(School_data, vals_chili_School)
#Tower_data <- vals_enhanced_all_fires %>% 
#  filter(fire == 'Tower')
#vals_chili_Tower <- cbind(Tower_data, vals_chili_Tower)
Egley_data <- vals_enhanced_all_fires %>% 
  filter(fire == 'Egley')
vals_chili_Egley <- cbind(Egley_data, vals_chili_Egley)
Calamity_data <- vals_enhanced_all_fires %>% 
  filter(fire == 'Calamity')
vals_chili_Calamity <- cbind(Calamity_data, vals_chili_Calamity)
Flagtail_data <- vals_enhanced_all_fires %>% 
  filter(fire == 'Flagtail')
vals_chili_Flagtail <- cbind(Flagtail_data, vals_chili_Flagtail)
Easy_data <- vals_enhanced_all_fires %>% 
  filter(fire == 'Easy')
vals_chili_Easy <- cbind(Easy_data, vals_chili_Easy)
Wheeler_data <- vals_enhanced_all_fires %>% 
  filter(fire == 'Wheeler') %>% 
  drop_na(`X2007`)
vals_chili_Wheeler <- cbind(Wheeler_data, vals_chili_Wheeler)

# merge the individual fires into one dataframe
vals_enhanced_all_fires <- rbind(vals_chili_BC, vals_chili_HR, vals_chili_School, vals_chili_Egley, vals_chili_Calamity, vals_chili_Flagtail, vals_chili_Easy, vals_chili_Wheeler)
```

## Combining, Lengthening, Widening Datasets
```{r}
long.nbr.df <- vals_enhanced_all_fires %>% 
  unite('x_y', c(Long, Lat), sep = '_', remove = F) %>% 
  pivot_longer(cols = !c(x_y, Long, Lat, Plot, fire, hli), names_to = 'year', values_to = 'nbr') %>% 
  mutate(year = str_sub(year, 2)) %>% 
  mutate(year = as.numeric(year)) %>% 
  mutate(nbr = as.numeric(nbr)) %>% 
  mutate(relative_year = case_when( # Making column so that year = 10 is the year following the major dip in NBR for every fire (note: changed from previously having year = 10 as year of fire; may change back...)
    fire == 'BC' ~ year - 1992, # BC complex fire occurred in 2001, dip in year after fire
    fire == 'HR' ~ year - 1991, # HR fire: 2000, dip in year after fire
    fire == 'School' ~ year - 1996, # School fire: 2005, dip in year after fire
#    fire == 'Tower' ~ year - 1986, # Tower fire: 1996 (tower fire removed)
    fire == 'Egley' ~ year - 1997, # Egley complex fire occurred in 2007, dip in year of fire
    fire == 'Easy' ~ year - 1993, # Easy fire: 2002, dip in year after fire
    fire == 'Calamity' ~ year - 1997, # Calamity complex fire: 2007, dip in year of fire
    fire == 'Flagtail' ~ year - 1992, # Flagtail fire: 2002, dip in year of fire
    fire == 'Wheeler' ~ year - 1987 # Wheeler Point fire: 1996, dip in year after fire
  )) #%>% 
  #drop_na(nbr) # since there must be some issues w/ NBR datasets (hopefully this isn't issue of coordinate system)

wide.df <- long.nbr.df %>% 
  filter(relative_year >= 0 & relative_year <= 23) %>% 
  select(-year) %>%
  distinct(x_y, Long, Lat, Plot, fire, hli, relative_year, .keep_all = T) %>% # getting rid of any duplicates
  pivot_wider(names_from = relative_year, values_from = nbr)
# Hmmmmmm, the NBR NA's dropped ~775 datapoints! That is not trivial...

wide.df %>% 
  group_by(fire) %>% 
  tally()

wide.df <- wide.df %>% 
  mutate(predisturbance_nbr = (`0` + `1` + `2` + `3` + `4` + `5` + `6` + `7` + `8` + `9`)/10) %>%  # Average nbr for ten years pre-fire
  mutate(postdisturbance_nbr = (`11` + `12` + `13` + `14` + `15` + `16` + `17` + `18` + `19` + `20`)/10) %>%  # Average nbr for ten years post-fire
  mutate(disturbance_nbr = (`10`+`11`)/2) %>% 
  mutate(delta_nbr = postdisturbance_nbr - predisturbance_nbr) # Avg postdisturbance nbr minus avg predisturbance nbr
```

## Fire Severity (difference in NBR)
For fire severity, we calculated difference in NBR and then used 0.66 times the predisturbance NBR average to calculate 'high severity burn'. We need to decide what threshold makes sense for us to use. This also coincides with how we calculated relative year above, as some of the fires had some points that were split between having the major dip in NBR during the year of fire and the year after fire; this major dip is what we're interested in and I suspect is the reason why a lot of the ~100 points removed from the below step were removed
```{r}
wide.df <- wide.df %>% 
  mutate(dnbr = `9`-`10`) %>% 
  filter(dnbr > 0.66*predisturbance_nbr)
```

Lengthening dataset
```{r}
long.df <- wide.df %>% 
  pivot_longer(cols = !c(x_y, Long, Lat, Plot, hli, fire, predisturbance_nbr, postdisturbance_nbr, disturbance_nbr, delta_nbr, dnbr), names_to = 'relative_year', values_to = 'nbr') %>% 
  mutate(relative_year = as.numeric(relative_year)) %>% 
  unite('x_y', c(Long, Lat), sep = '_', remove = F)
```

## Absolute, Relative Regrowth (Fitted)
```{r}
summary(long.df)
# Getting fitted values for nbr, using Loess model with smoothing span of 0.5
models <- long.df %>%  
        tidyr::nest(-x_y) %>%
        mutate(m = purrr::map(data, loess,
                           formula = nbr ~ relative_year, span = .5),  # Perform loess calculation on each sample
              nbr_fitted = purrr::map(m, `[[`, "fitted")) # Retrieve the fitted values from each model

# Apply fitted y's as a new column
long.df <- models %>%
        select(-m) %>%
        tidyr::unnest()

# Getting correctly calculated absolute regrowth and relative regrowth metrics calculated
wide.fitted.df <- long.df %>% 
  select(x_y, Long, Lat, relative_year, nbr_fitted) %>% 
  pivot_wider(names_from = relative_year, values_from = nbr_fitted)
wide.fitted.df <- wide.fitted.df %>% 
  mutate(absolute_regrowth = `15` - `10`) %>%  # From White et al 2017
  mutate(relative_regrowth = absolute_regrowth/(`9`-`10`))  # From White et al 2017
wide.df$absolute_regrowth <- wide.fitted.df$absolute_regrowth
wide.df$relative_regrowth <- wide.fitted.df$relative_regrowth
```

## Time to Recovery
```{r}
wide.df$max.postfire.nbr <- wide.df %>% 
  select(`11`, `12`, `13`, `14`, `15`, `16`, `17`, `18`, `19`, `20`, `21`, `22`, `23`) %>% 
  apply(1, max, na.rm=TRUE)

wide.df <- wide.df %>% 
  mutate(pct_recovery = max.postfire.nbr/predisturbance_nbr) %>% 
  mutate(time_to_0.8recovery = NA) %>% 
  mutate(time_to_0.8recovery = case_when(`11` >= 0.8*predisturbance_nbr ~ 1,
         `12` >= 0.8*predisturbance_nbr & is.na(time_to_0.8recovery) ~ 2,
         `13` >= 0.8*predisturbance_nbr & is.na(time_to_0.8recovery) ~ 3,
         `14` >= 0.8*predisturbance_nbr & is.na(time_to_0.8recovery) ~ 4,
         `15` >= 0.8*predisturbance_nbr & is.na(time_to_0.8recovery) ~ 5,
         `16` >= 0.8*predisturbance_nbr & is.na(time_to_0.8recovery) ~ 6,
         `17` >= 0.8*predisturbance_nbr & is.na(time_to_0.8recovery) ~ 7,
         `18` >= 0.8*predisturbance_nbr & is.na(time_to_0.8recovery) ~ 8,
         `19` >= 0.8*predisturbance_nbr & is.na(time_to_0.8recovery) ~ 9,
         `20` >= 0.8*predisturbance_nbr & is.na(time_to_0.8recovery) ~ 10,
         `21` >= 0.8*predisturbance_nbr & is.na(time_to_0.8recovery) ~ 11,
         `22` >= 0.8*predisturbance_nbr & is.na(time_to_0.8recovery) ~ 12,
         `23` >= 0.8*predisturbance_nbr & is.na(time_to_0.8recovery) ~ 13)) %>% 
  mutate(time_to_0.6recovery = NA) %>% 
  mutate(time_to_0.6recovery = case_when(`11` >= 0.6*predisturbance_nbr ~ 1,
         `12` >= 0.6*predisturbance_nbr & is.na(time_to_0.6recovery) ~ 2,
         `13` >= 0.6*predisturbance_nbr & is.na(time_to_0.6recovery) ~ 3,
         `14` >= 0.6*predisturbance_nbr & is.na(time_to_0.6recovery) ~ 4,
         `15` >= 0.6*predisturbance_nbr & is.na(time_to_0.6recovery) ~ 5,
         `16` >= 0.6*predisturbance_nbr & is.na(time_to_0.6recovery) ~ 6,
         `17` >= 0.6*predisturbance_nbr & is.na(time_to_0.6recovery) ~ 7,
         `18` >= 0.6*predisturbance_nbr & is.na(time_to_0.6recovery) ~ 8,
         `19` >= 0.6*predisturbance_nbr & is.na(time_to_0.6recovery) ~ 9,
         `20` >= 0.6*predisturbance_nbr & is.na(time_to_0.6recovery) ~ 10,
         `21` >= 0.6*predisturbance_nbr & is.na(time_to_0.6recovery) ~ 11,
         `22` >= 0.6*predisturbance_nbr & is.na(time_to_0.6recovery) ~ 12,
         `23` >= 0.6*predisturbance_nbr & is.na(time_to_0.6recovery) ~ 13))
```

## Using Fitted Lines
```{r}
postfire.long.df <- long.df %>% 
  filter(relative_year > 10)
prefire.long.df <- long.df %>% 
  filter(relative_year < 11) %>% 
  mutate(postfire_fitted_slope = NA) %>% 
  mutate(postfire_fitted_rsq = NA) %>% 
  select(postfire_fitted_rsq, postfire_fitted_slope, x_y, relative_year)

fitted_postfire_model <- postfire.long.df %>%
  group_by(x_y) %>%
  do(model = lm(nbr ~ relative_year, data = .))

fitted_postfire_model <- fitted_postfire_model %>% 
  mutate(postfire_fitted_slope = NA) %>% 
  mutate(postfire_fitted_rsq = NA) # Holding columns

for(i in 1:nrow(fitted_postfire_model)){
fitted_postfire_model$postfire_fitted_slope[i] <- fitted_postfire_model[[2]][[i]]$coefficients[2]
fitted_postfire_model$postfire_fitted_rsq[i] <- summary(fitted_postfire_model[[2]][[i]])$r.squared
}

fitted_postfire_model <- fitted_postfire_model %>% 
  select(-model)

postfire.long.df <- merge(fitted_postfire_model, postfire.long.df, by = 'x_y')

# Folding in new variables into long.df 
postfire.long.df <- postfire.long.df %>% 
  select(postfire_fitted_rsq, postfire_fitted_slope, x_y, relative_year)
long.df.fitted.vals <- rbind(prefire.long.df, postfire.long.df)
long.df <- merge(long.df, long.df.fitted.vals, by = c('x_y', 'relative_year'))

# Decluttering environment
rm(long.df.fitted.vals, fitted_postfire_model)
```

## Delta NBR
```{r}
long.df <- long.df %>% 
  mutate(yearly_delta_nbr = nbr - predisturbance_nbr)

long.df.avg <- long.df %>% 
  group_by(relative_year) %>% 
  summarise(avg_nbr = mean(nbr), avg_delta_nbr = mean(yearly_delta_nbr))

# averages by fire
long.df.fires.avg <- long.df %>% 
  group_by(relative_year, fire) %>% 
  summarise(avg_nbr = mean(nbr), avg_delta_nbr = mean(yearly_delta_nbr))

# AREA UNDER CURVE
auc <- function(y){
  n <- length(y)
  0.5*(y[1]+y[n]+2*sum(y[-c(1,n)]))
}
long.df <- long.df %>% 
  group_by(x_y) %>% 
  mutate(auc_delta_nbr = auc(yearly_delta_nbr))
```

## Scaled Recovery Metric, RdNBR
```{r}
long.df <- long.df %>% 
  mutate(scaled_recovery_metric = (nbr - disturbance_nbr)/(predisturbance_nbr - disturbance_nbr)) %>% 
  mutate(RdNBR = (predisturbance_nbr - nbr)/(sqrt(abs(predisturbance_nbr/1000))))
```

# Visualizations
## Principal Component Analysis
```{r}
# Prepping Dataset
traj.metrics.df.long <- long.df %>% 
  filter(relative_year > 10) %>% 
  select(x_y, fire, postdisturbance_nbr, delta_nbr, postfire_fitted_rsq, postfire_fitted_slope, auc_delta_nbr)

traj.metrics.df.wide <- wide.df %>% 
  pivot_longer(cols = !c(x_y, Long, Lat, Plot, fire, predisturbance_nbr, postdisturbance_nbr, disturbance_nbr, delta_nbr, absolute_regrowth, relative_regrowth, max.postfire.nbr, pct_recovery, time_to_0.8recovery, time_to_0.6recovery, dnbr), names_to = 'relative_year', values_to = 'nbr') %>% 
  filter(relative_year > 10) %>% 
  select(x_y, fire, absolute_regrowth, relative_regrowth, pct_recovery)

traj.metrics.df <- merge(traj.metrics.df.long, traj.metrics.df.wide, by = c('x_y', 'fire')) %>% 
  distinct(x_y, fire, .keep_all = T) %>% 
  mutate(postfire_fitted_rsq = ifelse(is.nan(postfire_fitted_rsq), 0, postfire_fitted_rsq)) %>% 
  mutate(relative_regrowth = ifelse(is.nan(relative_regrowth), NA, relative_regrowth)) %>% 
  drop_na(relative_regrowth)

traj.pca <- traj.metrics.df %>% 
  select(-x_y, -fire) %>% 
  prcomp(scale = T)

summary(traj.pca)
traj.pca$rotation[,1:2]

traj.cor <- traj.metrics.df %>% 
  select(-x_y, -fire) %>% 
  cor()

corrplot(traj.cor, method = 'number', diag = F, type = 'lower')

autoplot(traj.pca, data = traj.metrics.df,
              loadings = TRUE, loadings.colour = 'black',
              loadings.label = TRUE, loadings.label.size = 4.5) +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16))
```

traj.metrics.df, the dataframe tailored for the PCA is going to be used in the k-means clustering analysis

## Time Series Plots
```{r}
long.df %>% 
  ggplot(aes(x = relative_year, y = nbr, color = fire)) +
    geom_point(alpha = 0.3) +
    geom_line(alpha = 0.1) +
    #geom_smooth(alpha = 0.5) +
    geom_line(data = long.df.avg, aes(x = relative_year, y = avg_nbr), color = 'black', linewidth = 2) +
    labs(x = 'Relative Year (Fire = 10)', y = 'NBR', color = 'Fire') +
    theme_bw()

long.df %>% 
  ggplot(aes(x = relative_year, y = yearly_delta_nbr, color = fire)) +
    geom_point(alpha = 0.3) +
    geom_line(alpha = 0.1) +
    geom_smooth(alpha = 0.5) +
    geom_line(data = long.df.avg, aes(x = relative_year, y = avg_delta_nbr), color = 'black', linewidth = 2) +
    labs(x = 'Relative Year (Fire = 10)', y = 'Change in NBR (Deviation from Prefire Avg)', color = 'Fire') +
    theme_bw()
```

# K-Means Cluster Analysis
**Using Trajectory Metrics**
For this method, I am going to mirror the method used by Madeline when looking at the field data, but instead of inputting the field data values into the analysis, the trajectory metrics will be inputted and we'll get clusters for different 'modes' of post-fire recovery

Prepping dataset
```{r}
# Only interested in the trajectory metrics
traj.df <- traj.metrics.df %>% 
  select(-x_y, -fire, -auc_delta_nbr, -absolute_regrowth) # removing some metrics that are highly correlated

# Scaling, centering all metrics
traj.scaled.df <- as.data.frame(scale(traj.df))

# Getting rid of outliers
traj.scaled.df <- traj.scaled.df %>% 
  filter(pct_recovery < 20, pct_recovery > -10, relative_regrowth < 10)
traj.df <- traj.df %>% 
  filter(pct_recovery < 30, pct_recovery > -6, relative_regrowth < 16)
```

The below chunks are from Madeline's code
```{r}
## 3 ways to determine optimal cluster 
# 1. optimal cluster at the elbow
factoextra::fviz_nbclust(traj.scaled.df, kmeans, method = "wss") # 2 clusters

# 2. optimal cluster from gap statistic: high point!
gap_stat <- clusGap(traj.scaled.df,
                    FUN = kmeans,
                    nstart = 25,
                    K.max = 10,
                    B = 50)
# plot number of clusters vs. gap statistic
fviz_gap_stat(gap_stat) # Not sure from this one... 6?

# 3. silhouette analysis
fviz_nbclust(traj.scaled.df, kmeans, method = "silhouette") # Looks like 2
```


```{r}
#perform k-means clustering with k = 2 clusters
km <- kmeans(traj.scaled.df, centers = 2) # Note I removed nstart = 33, what does this mean?; note: I also tried k = 5

#view results
km

#plot results of final k-means model
fviz_cluster(km, data = traj.scaled.df)

#find unscaled (real-value) means of each cluster
aggregate(traj.df, by=list(cluster=km$cluster), mean)

#add cluster assigment to dataframes
traj.scaled.df <- cbind(traj.scaled.df, cluster = km$cluster)
traj.df <- cbind(traj.df, cluster = km$cluster)
wide.cluster.df <- merge(traj.df, wide.df, by = c('postdisturbance_nbr', 'delta_nbr', 'relative_regrowth', 'pct_recovery'))
```

### Visualizations
```{r}
# From above
fviz_cluster(km, data = traj.scaled.df)

# Lengthening dataframe, adding RdNBR, scaled recovery metric, and delta NBR (deviation from prefire conditions)
long.cluster.df <- wide.cluster.df %>% 
  pivot_longer(cols = !c(x_y, Long, Lat, Plot, fire, predisturbance_nbr, postdisturbance_nbr, disturbance_nbr, delta_nbr, absolute_regrowth, relative_regrowth, max.postfire.nbr, pct_recovery, time_to_0.8recovery, time_to_0.6recovery, dnbr, cluster), names_to = 'relative_year', values_to = 'nbr') %>% 
  mutate(yearly_delta_nbr = nbr - predisturbance_nbr) %>% 
  mutate(scaled_recovery_metric = (nbr - disturbance_nbr)/(predisturbance_nbr - disturbance_nbr)) %>% 
  mutate(RdNBR = (predisturbance_nbr - nbr)/(sqrt(abs(predisturbance_nbr/1000)))) %>% 
  mutate(cluster = as.factor(cluster)) %>% 
  mutate(relative_year = as.numeric(relative_year))

# Average values
long.cluster.avg.df <- long.cluster.df %>% 
  group_by(cluster, relative_year) %>% 
  summarise(avg_nbr = mean(nbr), avg_delta_nbr = mean(yearly_delta_nbr), avg_srm = mean(scaled_recovery_metric), avg_RdNBR = mean(RdNBR))

# Time series visualizations
long.cluster.df %>% 
  ggplot(aes(x = relative_year, y = nbr, color = cluster)) +
    geom_point(alpha = 0.3) +
    geom_line(alpha = 0.1) +
    geom_line(data = long.cluster.avg.df, aes(x = relative_year, y = avg_nbr, color = cluster), alpha = 0.8, linewidth = 2) +
    labs(x = 'Relative Year (Fire = 10)', y = 'NBR', color = 'Cluster') +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 16),
          axis.text = element_text(size = 12),
          legend.title = element_text(face = 'bold', size = 16),
          legend.text = element_text(size = 14))
ggsave(here('figures', 'nbr.time.series.png'), height = 9, width = 14)

long.cluster.df %>% 
  ggplot(aes(x = relative_year, y = yearly_delta_nbr, color = cluster)) +
    geom_point(alpha = 0.3) +
    geom_line(alpha = 0.1) +
    geom_line(data = long.cluster.avg.df, aes(x = relative_year, y = avg_delta_nbr, color = cluster), alpha = 0.8, linewidth = 2) +
    labs(x = 'Relative Year (Fire = 10)', y = 'Change in NBR (Deviation from Prefire Avg)', color = 'Cluster') +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 16),
          axis.text = element_text(size = 12),
          legend.title = element_text(face = 'bold', size = 16),
          legend.text = element_text(size = 14))
ggsave(here('figures', 'change.in.nbr.time.series.png'), height = 9, width = 14)
```

# Time Since Fire
```{r}
wide.cluster.df %>% 
  mutate(fire_year = case_when(
    fire == 'BC' ~ 2001, # BC complex fire occurred in 2001
    fire == 'HR' ~ 2000, # HR fire: 2000
    fire == 'School' ~ 2005, # School fire: 2005
    #fire == 'Tower' ~ 1996, # Tower fire: 1996
    fire == 'Egley' ~ 2007, # Egley complex fire occurred in 2007
    fire == 'Easy' ~ 2002, # Easy fire: 2002
    fire == 'Calamity' ~ 2007, # Calamity complex fire: 2007
    fire == 'Flagtail' ~ 2002, # Flagtail fire: 2002
    fire == 'Wheeler' ~ 1996 )) %>%  # Wheeler fire: 1996
  pivot_longer(cols = c(postdisturbance_nbr, delta_nbr, relative_regrowth, pct_recovery, postfire_fitted_slope), values_to = 'val', names_to = 'var') %>% 
  ggplot(aes(x = fire_year, y = val)) +
    geom_jitter(width = 0.2, height = 1, alpha = 0.6) +
    geom_smooth(method = 'lm', color = 'black') +
    facet_wrap(~var, scales = 'free') +
    theme_bw()

# I think this is tough to do much w/ when we have a rather limited subset of data to work with
```

# ANOVA: Differences in Fire
```{r}
# Differences in fire
fire.lm <- lm(cluster ~ fire, data = wide.cluster.df)
anova(fire.lm)
fire.aov <- aov(fire.lm)
TukeyHSD(fire.aov)

anova_labels <- data.frame(fire=c(1:8), label=c('a', 'ab', 'abc', 'abc', 'abc', 'abc', 'bc', 'c'))

wide.cluster.df %>% 
 mutate(fire=factor(fire)) %>% 
 mutate(fire=fct_relevel(fire,c("Easy", "Wheeler", "HR", "School", "Calamity", 
                                "BC", "Flagtail", "Egley"))) %>%
 ggplot(aes(x = fire, y = cluster)) +
  geom_jitter(height = 0.3, alpha = 0.6) +
  scale_y_continuous(breaks = c(1, 2)) +
  labs(x = 'Fire', y = 'Spectral Trajectory Cluster') +
  geom_text(aes(x = fire, y = 1.5, label = label), data = anova_labels, fontface = 'italic', size = 5) +
  theme_bw() +
  theme(axis.title = element_text(face = 'bold', size = 16),
        axis.text.x = element_text(size = 14),
        axis.text.y = element_text(size = 12))
ggsave(here('figures', 'fire.vs.cluster.png'), height = 6, width = 10)

wide.cluster.df %>% 
  group_by(fire, cluster) %>% 
  tally() %>% 
  pivot_wider(names_from = cluster, values_from = n) %>% 
  mutate(cluster_ratio = `1`/`2`)
```

# Clusters vs. Climate Data and CHILI

## Climate Data Wrangling
Note: also wrapped in postfire regen here to extract data from there
```{r}
# PRISM 30yr normals, 800m resolution
precip.ras <- raster(here('data', 'climate', 'precip_30yr_normal', 'PRISM_ppt_30yr.asc'))
tmean.ras <- raster(here('data', 'climate', 'tmean_30yr_normal', 'PRISM_tmean_30yr.asc'))
vpdmax.ras <- raster(here('data', 'climate', 'vpdmax_30yr_normal', 'PRISM_vpdmax_30yr.asc'))
# Current CRS: +proj=longlat +datum=NAD83 +no_defs; needs to be changed to +proj=longlat +datum=WGS84 +no_defs
precip.ras <- projectRaster(from = precip.ras, to = blue.mtns.ras, crs = crs(postfire.regen))
tmean.ras <- projectRaster(from = tmean.ras, to = blue.mtns.ras, crs = crs(postfire.regen))
vpdmax.ras <- projectRaster(from = vpdmax.ras, to = blue.mtns.ras, crs = crs(postfire.regen))

# Extract Climate Variables from Rasters to add to wide.cluster.df
wide_cluster_coords <- wide.cluster.df[,c(9,10)] # define coordinates
wide_cluster_pts <- wide.cluster.df %>% 
  select(Long, Lat) %>% 
  SpatialPointsDataFrame(coords = wide_cluster_coords, proj4string = crs(nbr_Egley)) # transform to spatial points dataframe
## Precip ##
precip_vals <- as.data.frame(extract(precip.ras, wide_cluster_pts))
colnames(precip_vals)[1] <- 'precip' # renaming column
## Mean Temp ##
tmean_vals <- as.data.frame(extract(tmean.ras, wide_cluster_pts))
colnames(tmean_vals)[1] <- 'tmean' # renaming column
## Max VPD ##
vpdmax_vals <- as.data.frame(extract(vpdmax.ras, wide_cluster_pts))
colnames(vpdmax_vals)[1] <- 'vpdmax' # renaming column

## Postfire Regen Probability ##
regen_vals <- as.data.frame(extract(postfire.regen, wide_cluster_pts))
colnames(regen_vals)[1] <- 'regen_prob' # renaming column

# Combining with wide.cluster.df
climate_vals <- cbind(wide_cluster_coords, precip_vals, tmean_vals, vpdmax_vals, regen_vals)
wide.cluster.df <- merge(wide.cluster.df, climate_vals, by = c('Long', 'Lat')) %>% 
    distinct(x_y, .keep_all = T) # removing duplicates
```

## Stats Tests
Precip
```{r}
# Normal distribution?
precip.lm <- lm(data = wide.cluster.df, precip ~ cluster)
plot(precip.lm) # CLT applies, but qqplot looks kind funky
# Equal variances?
var.test(data = wide.cluster.df, precip ~ cluster) # No, variances not equal
# T-test
c1 <- wide.cluster.df %>% 
  filter(cluster == 1) %>% 
  select(precip)
c2 <- wide.cluster.df %>% 
  filter(cluster == 2) %>% 
  select(precip)
t.test(c1, c2, var.equal = F) # significant differences
```

Mean Temp.
```{r}
# Normal distribution?
tmean.lm <- lm(data = wide.cluster.df, tmean ~ cluster)
plot(tmean.lm) # CLT applies, but qqplot looks kind funky (basically looks the same as precip)
# Equal variances?
var.test(data = wide.cluster.df, tmean ~ cluster) # No, variances not equal
# T-test
c1 <- wide.cluster.df %>% 
  filter(cluster == 1) %>% 
  select(tmean)
c2 <- wide.cluster.df %>% 
  filter(cluster == 2) %>% 
  select(tmean)
t.test(c1, c2, var.equal = F) # significant differences
```

Max VPD
```{r}
# Normal distribution?
vpdmax.lm <- lm(data = wide.cluster.df, vpdmax ~ cluster)
plot(vpdmax.lm)
# Equal variances?
var.test(data = wide.cluster.df, vpdmax ~ cluster) # No, variances not equal
# T-test
c1 <- wide.cluster.df %>% 
  filter(cluster == 1) %>% 
  select(vpdmax)
c2 <- wide.cluster.df %>% 
  filter(cluster == 2) %>% 
  select(vpdmax)
t.test(c1, c2, var.equal = F) # significant differences
```

CHILI
```{r}
# Normal distribution?
chili.lm <- lm(data = wide.cluster.df, hli ~ cluster)
plot(chili.lm) # more of a uniform distribution; CLT still applies
# Equal variances?
var.test(data = wide.cluster.df, hli ~ cluster) # No, variances not equal
# T-test
c1 <- wide.cluster.df %>% 
  filter(cluster == 1) %>% 
  select(hli)
c2 <- wide.cluster.df %>% 
  filter(cluster == 2) %>% 
  select(hli)
t.test(c1, c2, var.equal = F) # significant differences
```

## Boxplots
```{r}
climate_var_names <- c(precip = 'Mean Annual Precipitation (30yr Normal)',
                     tmean = 'Mean Annual Temperature (30yr Normal)',
                     vpdmax = 'Max. VPD (30yr Normal)',
                     hli = 'Cont. Heat-Insolation Load Index (CHILI)')

wide.cluster.df %>% 
  mutate(cluster = as.factor(cluster)) %>% 
  pivot_longer(cols = c(precip, tmean, vpdmax, hli), names_to = 'climate_var', values_to = 'climate_val') %>% 
  ggplot(aes(x = cluster, y = climate_val, color = cluster)) +
    geom_boxplot(outlier.shape = NA, size = 0.8) +
    geom_jitter(width = 0.25, alpha = 0.05) +
    labs(x = 'Spectral Trajectory Cluster') +
    facet_wrap(~climate_var, scales = 'free', labeller = as_labeller(climate_var_names), ncol = 4) +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title.y = element_blank(),
          axis.title.x = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))
ggsave(here('figures', 'climate.vs.cluster.boxplots.png'), height = 7, width = 15)
```

# Clusters vs. Field Data
Getting Combined Dataset Ready
```{r}
field.data.both <- field.data.both %>% 
  drop_na(Long)
main.df <- merge(wide.cluster.df, field.data.both, by = 'Plot') %>% 
  select(-Long.y, -Lat.y, -Fire) %>% 
  rename(Long = Long.x, Lat = Lat.x) %>% 
  mutate(aspect = as.numeric(aspect),
         cluster = as.factor(cluster),
         log.seedling.density = log(seedling.density)) %>% 
  mutate(log.seedling.density = ifelse(log.seedling.density < 0, 0, log.seedling.density)) # making any -Inf values for log.seedling.density = 0
```

## Stats Tests
Looking at two clusters, t-test

% Grass
```{r}
# Normal distribution?
grass.lm <- lm(data = main.df, grass.pct ~ cluster)
plot(grass.lm)
# Equal variances?
var.test(data = main.df, grass.pct ~ cluster)
# T-test
c1 <- main.df %>% 
  filter(cluster == 1) %>% 
  select(grass.pct)
c2 <- main.df %>% 
  filter(cluster == 2) %>% 
  select(grass.pct)
t.test(c1, c2, var.equal = T)
```
*Significant differences*

% herb
```{r}
# Normal distribution?
herb.lm <- lm(data = main.df, herb.pct ~ cluster)
plot(herb.lm)
# Equal variances?
var.test(data = main.df, herb.pct ~ cluster)
# T-test
c1 <- main.df %>% 
  filter(cluster == 1) %>% 
  select(herb.pct)
c2 <- main.df %>% 
  filter(cluster == 2) %>% 
  select(herb.pct)
t.test(c1, c2, var.equal = T)
```

% shrub
```{r}
# Normal distribution?
shrub.lm <- lm(data = main.df, shrub.pct ~ cluster)
plot(shrub.lm)
# Equal variances?
var.test(data = main.df, shrub.pct ~ cluster)
# T-test
c1 <- main.df %>% 
  filter(cluster == 1) %>% 
  select(shrub.pct)
c2 <- main.df %>% 
  filter(cluster == 2) %>% 
  select(shrub.pct)
t.test(c1, c2, var.equal = T)
```
**Significant difference**

% seedling
```{r}
# Normal distribution?
seedling.lm <- lm(data = main.df, seedling.pct ~ cluster)
plot(seedling.lm) # NOT A NORMAL DISTRIBUTION, but hopefully central limit theorem applies (n > 30 for each group)
# Equal variances?
var.test(data = main.df, seedling.pct ~ cluster) # NO! Indicate in t.test below
# T-test (Welch's)
c1 <- main.df %>% 
  filter(cluster == 1) %>% 
  select(seedling.pct)
c2 <- main.df %>% 
  filter(cluster == 2) %>% 
  select(seedling.pct)
t.test(c1, c2, var.equal = F)
```

% green
```{r}
# Normal distribution?
green.lm <- lm(data = main.df, green.pct ~ cluster)
plot(green.lm)
# Equal variances?
var.test(data = main.df, green.pct ~ cluster)
# T-test
c1 <- main.df %>% 
  filter(cluster == 1) %>% 
  select(green.pct)
c2 <- main.df %>% 
  filter(cluster == 2) %>% 
  select(green.pct)
t.test(c1, c2, var.equal = T)
```
*significant differences*


% npv
```{r}
# Normal distribution?
npv.lm <- lm(data = main.df, npv.pct ~ cluster)
plot(npv.lm)
# Equal variances?
var.test(data = main.df, npv.pct ~ cluster)
# T-test
c1 <- main.df %>% 
  filter(cluster == 1) %>% 
  select(npv.pct)
c2 <- main.df %>% 
  filter(cluster == 2) %>% 
  select(npv.pct)
t.test(c1, c2, var.equal = T)
```

Log Seedling Density
```{r}
# Normal distribution?
log.seedling.lm <- lm(data = main.df, log.seedling.density ~ cluster)
plot(log.seedling.lm)
# Equal variances?
var.test(data = main.df, log.seedling.density ~ cluster)
# T-test
c1 <- main.df %>% 
  filter(cluster == 1) %>% 
  select(log.seedling.density)
c2 <- main.df %>% 
  filter(cluster == 2) %>% 
  select(log.seedling.density)
t.test(c1, c2, var.equal = T)
```

Slope
```{r}
# Normal distribution?
slope.lm <- lm(data = main.df, slope ~ cluster)
plot(slope.lm)
# Equal variances?
var.test(data = main.df, slope ~ cluster)
# T-test
c1 <- main.df %>% 
  filter(cluster == 1) %>% 
  select(slope)
c2 <- main.df %>% 
  filter(cluster == 2) %>% 
  select(slope)
t.test(c1, c2, var.equal = T)
```
*significant differences*

Aspect
```{r}
# Normal distribution?
aspect.lm <- lm(data = main.df, aspect ~ cluster)
plot(aspect.lm) # Doesn't look great, but hopefully CLT applies
# Equal variances?
var.test(data = main.df, aspect ~ cluster)
# T-test
c1 <- main.df %>% 
  filter(cluster == 1) %>% 
  select(aspect)
c2 <- main.df %>% 
  filter(cluster == 2) %>% 
  select(aspect)
t.test(c1, c2, var.equal = T)
```

Densiometer
```{r}
# Normal distribution?
densio.lm <- lm(data = main.df, densiometer ~ cluster)
plot(densio.lm)
# Equal variances?
var.test(data = main.df, densiometer ~ cluster)
# T-test
c1 <- main.df %>% 
  filter(cluster == 1) %>% 
  select(densiometer)
c2 <- main.df %>% 
  filter(cluster == 2) %>% 
  select(densiometer)
t.test(c1, c2, var.equal = T)
```

## Boxplots
Looking at spectral trajectory cluster vs. field data
```{r}
field_var_names <- c(grass.pct = '% Grass',
                     herb.pct = '% Herb',
                     shrub.pct = '% Shrub',
                     seedling.pct = '% Seedling',
                     green.pct = '% Green',
                     npv.pct = '% NPV',
                     seedling.density = 'Seedling Density',
                     log.seedling.density = 'Log Seedling Density',
                     aspect = 'Aspect',
                     slope = 'Slope',
                     densiometer = 'Densiometer')

main.df %>% 
  pivot_longer(cols = c(grass.pct, herb.pct, shrub.pct, seedling.pct, green.pct, npv.pct, log.seedling.density, slope, densiometer), values_to = 'field_val', names_to = 'field_var')  %>% 
  ggplot(aes(x = cluster, y = field_val, color = cluster)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.8) +
    geom_jitter(width = 0.15, alpha = 0.3) +
    labs(x = 'Spectral Trajectory Cluster') +
    facet_wrap(~field_var, scales = 'free', labeller = as_labeller(field_var_names)) +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title.y = element_blank(),
          axis.title.x = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))
ggsave(here('figures', 'field.vs.clusters.boxplots.png'), height = 8, width = 9)
```

% grass, % shrub, % green, and slope show a significant difference between clusters; however, I think the patterns we observed in the field could be somewhat hidden, as there were distinct differences observed in the 'trailing edge' vs. the 'forested' sites

## Trailing Edge vs. Forest
```{r}
main.df <- main.df %>% 
  mutate(forest.type = ifelse(fire == 'Egley' | fire == 'Calamity' | fire == 'Wheeler', 'Trailing Edge', 'Forest'))

main.df %>% 
  group_by(forest.type, cluster) %>% 
  tally() # Very even
```

### Stats Tests
#### Trailing Edge
```{r}
trailing.edge.df <- main.df %>% 
  filter(forest.type == 'Trailing Edge')
```

Looking at two clusters, t-test

% Grass
```{r}
# Normal distribution?
grass.lm <- lm(data = trailing.edge.df, grass.pct ~ cluster)
plot(grass.lm)
# Equal variances?
var.test(data = trailing.edge.df, grass.pct ~ cluster) # No, use Welch's t-test
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(grass.pct)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(grass.pct)
t.test(c1, c2, var.equal = F)
```

% herb
```{r}
# Normal distribution?
herb.lm <- lm(data = trailing.edge.df, herb.pct ~ cluster)
plot(herb.lm)
# Equal variances?
var.test(data = trailing.edge.df, herb.pct ~ cluster)
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(herb.pct)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(herb.pct)
t.test(c1, c2, var.equal = T)
```

% shrub
```{r}
# Normal distribution?
shrub.lm <- lm(data = trailing.edge.df, shrub.pct ~ cluster)
plot(shrub.lm)
# Equal variances?
var.test(data = trailing.edge.df, shrub.pct ~ cluster)
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(shrub.pct)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(shrub.pct)
t.test(c1, c2, var.equal = T)
```
**Significant difference**

% seedling
```{r}
# Normal distribution?
seedling.lm <- lm(data = trailing.edge.df, seedling.pct ~ cluster)
plot(seedling.lm) # NOT A NORMAL DISTRIBUTION, but hopefully central limit theorem applies (n > 30 for each group)
# Equal variances?
var.test(data = trailing.edge.df, seedling.pct ~ cluster) # NO! Indicate in t.test below
# T-test (Welch's)
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(seedling.pct)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(seedling.pct)
t.test(c1, c2, var.equal = F)
```

% green
```{r}
# Normal distribution?
green.lm <- lm(data = trailing.edge.df, green.pct ~ cluster)
plot(green.lm)
# Equal variances?
var.test(data = trailing.edge.df, green.pct ~ cluster)
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(green.pct)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(green.pct)
t.test(c1, c2, var.equal = T)
```
*significant differences*

% npv
```{r}
# Normal distribution?
npv.lm <- lm(data = trailing.edge.df, npv.pct ~ cluster)
plot(npv.lm)
# Equal variances?
var.test(data = trailing.edge.df, npv.pct ~ cluster)
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(npv.pct)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(npv.pct)
t.test(c1, c2, var.equal = T)
```

Log Seedling Density
```{r}
# Normal distribution?
log.seedling.lm <- lm(data = trailing.edge.df, log.seedling.density ~ cluster)
plot(log.seedling.lm)
# Equal variances?
var.test(data = trailing.edge.df, log.seedling.density ~ cluster) #No, run Welch's t test below
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(log.seedling.density)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(log.seedling.density)
t.test(c1, c2, var.equal = F)
```

Slope
```{r}
# Normal distribution?
slope.lm <- lm(data = trailing.edge.df, slope ~ cluster)
plot(slope.lm)
# Equal variances?
var.test(data = trailing.edge.df, slope ~ cluster)
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(slope)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(slope)
t.test(c1, c2, var.equal = T)
```

Aspect
```{r}
# Normal distribution?
aspect.lm <- lm(data = trailing.edge.df, aspect ~ cluster)
plot(aspect.lm) # Doesn't look great, but hopefully CLT applies
# Equal variances?
var.test(data = trailing.edge.df, aspect ~ cluster)
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(aspect)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(aspect)
t.test(c1, c2, var.equal = T)
```

Densiometer
```{r}
# Normal distribution?
densio.lm <- lm(data = trailing.edge.df, densiometer ~ cluster)
plot(densio.lm)
# Equal variances?
var.test(data = trailing.edge.df, densiometer ~ cluster) # No, use Welch's t-test
# T-test
c1 <- trailing.edge.df %>% 
  filter(cluster == 1) %>% 
  select(densiometer)
c2 <- trailing.edge.df %>% 
  filter(cluster == 2) %>% 
  select(densiometer)
t.test(c1, c2, var.equal = F)
```

#### Forest
```{r}
forested.df <- main.df %>% 
  filter(forest.type == 'Forest')
```

Looking at two clusters, t-test

% Grass
```{r}
# Normal distribution?
grass.lm <- lm(data = forested.df, grass.pct ~ cluster)
plot(grass.lm)
# Equal variances?
var.test(data = forested.df, grass.pct ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(grass.pct)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(grass.pct)
t.test(c1, c2, var.equal = T)
```

% herb
```{r}
# Normal distribution?
herb.lm <- lm(data = forested.df, herb.pct ~ cluster)
plot(herb.lm)
# Equal variances?
var.test(data = forested.df, herb.pct ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(herb.pct)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(herb.pct)
t.test(c1, c2, var.equal = F)
```

% shrub
```{r}
# Normal distribution?
shrub.lm <- lm(data = forested.df, shrub.pct ~ cluster)
plot(shrub.lm)
# Equal variances?
var.test(data = forested.df, shrub.pct ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(shrub.pct)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(shrub.pct)
t.test(c1, c2, var.equal = T)
```
**Significant difference**

% seedling
```{r}
# Normal distribution?
seedling.lm <- lm(data = forested.df, seedling.pct ~ cluster)
plot(seedling.lm) # NOT A NORMAL DISTRIBUTION, but hopefully central limit theorem applies (n > 30 for each group)
# Equal variances?
var.test(data = forested.df, seedling.pct ~ cluster) # No, run Welch's t-test below
# T-test (Welch's)
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(seedling.pct)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(seedling.pct)
t.test(c1, c2, var.equal = F)
```

% green
```{r}
# Normal distribution?
green.lm <- lm(data = forested.df, green.pct ~ cluster)
plot(green.lm)
# Equal variances?
var.test(data = forested.df, green.pct ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(green.pct)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(green.pct)
t.test(c1, c2, var.equal = T)
```

% npv
```{r}
# Normal distribution?
npv.lm <- lm(data = forested.df, npv.pct ~ cluster)
plot(npv.lm)
# Equal variances?
var.test(data = forested.df, npv.pct ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(npv.pct)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(npv.pct)
t.test(c1, c2, var.equal = T)
```

Log Seedling Density
```{r}
# Normal distribution?
log.seedling.lm <- lm(data = forested.df, log.seedling.density ~ cluster)
plot(log.seedling.lm)
# Equal variances?
var.test(data = forested.df, log.seedling.density ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(log.seedling.density)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(log.seedling.density)
t.test(c1, c2, var.equal = T)
```

Slope
```{r}
# Normal distribution?
slope.lm <- lm(data = forested.df, slope ~ cluster)
plot(slope.lm)
# Equal variances?
var.test(data = forested.df, slope ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(slope)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(slope)
t.test(c1, c2, var.equal = T)
```

Aspect
```{r}
# Normal distribution?
aspect.lm <- lm(data = forested.df, aspect ~ cluster)
plot(aspect.lm) # Doesn't look great, but hopefully CLT applies
# Equal variances?
var.test(data = forested.df, aspect ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(aspect)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(aspect)
t.test(c1, c2, var.equal = T)
```

Densiometer
```{r}
# Normal distribution?
densio.lm <- lm(data = forested.df, densiometer ~ cluster)
plot(densio.lm)
# Equal variances?
var.test(data = forested.df, densiometer ~ cluster)
# T-test
c1 <- forested.df %>% 
  filter(cluster == 1) %>% 
  select(densiometer)
c2 <- forested.df %>% 
  filter(cluster == 2) %>% 
  select(densiometer)
t.test(c1, c2, var.equal = T)
```

#### Summary
For the trailing edge, we see clearer differences in the field data between spectral trajectory clusters w/ significant differences in the following variables: % shrub, % seedling, and seedling density

While, for the forest, we see only significant differences for % shrub

From observations in the field, this aligns with what we expected as quicker recovery showing up as 'recovered' in the spectral trajectories typically aligned with shrub-dominated sites in the 'trailing edge' sites, as snowbrush ceanothus (evergreen shrub) quickly proliferates post-fire. In these 'trailing edge' sites, PIPO was dominant and some PSME, JUCO and LAOC (much lesser degree) were seen. PIPO, grows rather slow, so the expectation that the NBR data would show 'recovery' of PIPO woodlands or forests in less than 20 years (above we used 23 years postfire) is inherently flawed. In contrast, in the forested sites, PICO and (to a lesser degree) LAOC were dominant over PIPO (although PIPO was present in many cases too), so the relationship between spectral data and field data is messier for these sites. Because PICO has rapid, serotinous responses postfire, it makes sense that by 23 years, the NBR may show recovery. The fact that % shrub is still significant reflects the sites that had snowbrush ceanothus dominant in the 'forested' sites which -- along with the PICO response sites -- were likely lumped into cluster 1. Somehow separating the dataset by dominant species could allow us to look further into these dynamics.

Note: these are the same conclusions made in the original k-means cluster analysis; however some of the sig. different variables are different in this go-through

### Boxplots
```{r}
main.df %>% 
  #filter(forest.type == 'Trailing Edge') %>% 
  pivot_longer(cols = c(grass.pct, herb.pct, shrub.pct, seedling.pct, green.pct, npv.pct, log.seedling.density, densiometer, slope), values_to = 'field_val', names_to = 'field_var')  %>% 
  ggplot(aes(x = cluster, y = field_val, color = forest.type)) +
    geom_boxplot(alpha = 0.8, outlier.shape = NA) +
    geom_point(position=position_jitterdodge(jitter.width = 0.1, jitter.height = 0), alpha = 0.3) +
    labs(x = 'Spectral Trajectory Cluster', y = ' ', color = 'Trailing Edge vs. Forest') +
    facet_wrap(~field_var, scales = 'free', labeller = as_labeller(field_var_names)) +
    theme_bw() +
    theme(legend.position = 'top',
          legend.title = element_text(face = 'bold', size = 12),
          axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))
ggsave(here('figures', 'field.vs.clusters.trailing.boxplots.png'), height = 9, width = 9)
```

## Species Differences (2023)
```{r}
dominant.species <- seedlings %>% 
  group_by(Plot) %>% 
  summarise(dominant.species = names(which.max(table(Spec))))

main.df.spp <- merge(dominant.species, main.df, by = 'Plot')

main.df.spp %>% 
  group_by(forest.type, dominant.species) %>% 
  tally()

# Focusing on PIPO
main.df.spp %>% 
  filter(dominant.species == 'PIPO') %>% 
  pivot_longer(cols = c(grass.pct, herb.pct, shrub.pct, seedling.pct, green.pct, npv.pct, log.seedling.density, densiometer, slope), values_to = 'field_val', names_to = 'field_var')  %>% 
  ggplot(aes(x = cluster, y = field_val, color = cluster)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.8) +
    geom_jitter(width = 0.15, alpha = 0.3) +
    labs(x = 'Spectral Trajectory Cluster', y = ' ') +
    facet_wrap(~field_var, scales = 'free', labeller = as_labeller(field_var_names)) +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))
ggsave(here('figures', 'field.vs.clusters.PIPO.boxplots.png'), height = 8, width = 9)

# Focusing on PICO and LAOC
main.df.spp %>% 
  filter(dominant.species %in% c('PICO', 'LAOC')) %>% 
  pivot_longer(cols = c(grass.pct, herb.pct, shrub.pct, seedling.pct, green.pct, npv.pct, log.seedling.density, densiometer, slope), values_to = 'field_val', names_to = 'field_var')  %>% 
  ggplot(aes(x = cluster, y = field_val, color = cluster)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.8) +
    geom_jitter(width = 0.15, alpha = 0.3) +
    labs(x = 'Spectral Trajectory Cluster', y = ' ') +
    facet_wrap(~field_var, scales = 'free', labeller = as_labeller(field_var_names)) +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))
ggsave(here('figures', 'field.vs.clusters.PICOandLAOC.boxplots.png'), height = 8, width = 9)
```

## Climate (cont.)
Because climate is significantly driving the spectral trajectories, it is worth looking into this further, but only with our field data

### T-Tests, Boxplot
Repeating stats tests and boxplots from above but only with field sites

Precip
```{r}
# Normal distribution?
precip.lm <- lm(data = main.df, precip ~ cluster)
plot(precip.lm) # it's ... okay
# Equal variances?
var.test(data = main.df, precip ~ cluster) # Equal variances
# T-test
c1 <- main.df %>% 
  filter(cluster == 1) %>% 
  select(precip)
c2 <- main.df %>% 
  filter(cluster == 2) %>% 
  select(precip)
t.test(c1, c2, var.equal = T) # n.s.
```

Mean Temp.
```{r}
# Normal distribution?
tmean.lm <- lm(data = main.df, tmean ~ cluster)
plot(tmean.lm) # not great
# Equal variances?
var.test(data = main.df, tmean ~ cluster) # No, variances not equal
# T-test
c1 <- main.df %>% 
  filter(cluster == 1) %>% 
  select(tmean)
c2 <- main.df %>% 
  filter(cluster == 2) %>% 
  select(tmean)
t.test(c1, c2, var.equal = F) # n.s.
```

Max VPD
```{r}
# Normal distribution?
vpdmax.lm <- lm(data = main.df, vpdmax ~ cluster)
plot(vpdmax.lm) # Not bad
# Equal variances?
var.test(data = main.df, vpdmax ~ cluster) # Yes
# T-test
c1 <- main.df %>% 
  filter(cluster == 1) %>% 
  select(vpdmax)
c2 <- main.df %>% 
  filter(cluster == 2) %>% 
  select(vpdmax)
t.test(c1, c2, var.equal = T) # n.s.
```

CHILI
```{r}
# Normal distribution?
hli.lm <- lm(data = main.df, hli ~ cluster)
plot(hli.lm) # Not bad
# Equal variances?
var.test(data = main.df, hli ~ cluster) # Yes
# T-test
c1 <- main.df %>% 
  filter(cluster == 1) %>% 
  select(hli)
c2 <- main.df %>% 
  filter(cluster == 2) %>% 
  select(hli)
t.test(c1, c2, var.equal = T) # n.s.
```

Unlike the previous iteration, with only our field data, we do not see significant differences between the two clusters in climate variables. If I had to guess, this is due to the serotinous response and the shrub dominant sites being lumped into the same cluster and also likely due to a small sample size.

```{r}
main.df %>% 
  mutate(cluster = as.factor(cluster)) %>% 
  pivot_longer(cols = c(precip, tmean, vpdmax, hli), names_to = 'climate_var', values_to = 'climate_val') %>% 
  ggplot(aes(x = cluster, y = climate_val, color = cluster)) +
    geom_boxplot(outlier.shape = NA, size = 0.8) +
    geom_jitter(width = 0.25, alpha = 0.3) +
    labs(x = 'Spectral Trajectory Cluster') +
    facet_wrap(~climate_var, scales = 'free', labeller = as_labeller(climate_var_names)) +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title.y = element_blank(),
          axis.title.x = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))
```

### Regressions, Scatterplots
Now the question is, what (if anything) *can* our climate variables predict in our dataset?

To figure this out, I think doing simple multivariate models predicting our field data is a good start

Scale variables
```{r}
regressions.df <- main.df %>% 
  mutate(grass.pct = scale(grass.pct), herb.pct = scale(herb.pct), shrub.pct = scale(shrub.pct), seedling.pct = scale(seedling.pct), log.seedling.density = scale(log.seedling.density), precip = scale(precip), tmean = scale(tmean), vpdmax = scale(vpdmax), hli = scale(hli))
```

Colinearity check
```{r}
library(performance)
grass.mod <- lm(grass.pct ~ precip + tmean + vpdmax + hli, data = regressions.df)
multicollinearity(grass.mod) # precip and VPD are collinear (makes sense), so will do models with either/or
```


% Grass
```{r}
grass.mod <- lm(grass.pct ~ precip + tmean + hli, data = regressions.df)
anova(grass.mod) # significant portion of variance explained by precip
summary(grass.mod) # precip is significant
```

% Herb
```{r}
herb.mod <- lm(herb.pct ~ precip + tmean + hli, data = regressions.df)
anova(herb.mod) # precip, tmean, hli significant
summary(herb.mod) # tmean and hli significant
```

% Shrub
```{r}
shrub.mod <- lm(shrub.pct ~ precip + tmean + hli, data = regressions.df)
anova(shrub.mod) # no significance
summary(shrub.mod) # no significance
```

% Seedling
```{r}
seedling.mod <- lm(seedling.pct ~ precip + tmean + hli, data = regressions.df)
anova(seedling.mod) # significant portion of variance explained by precip
summary(seedling.mod) # precip and tmean (marginally significant) are significant predictors
```

Log Seedling Density
```{r}
seedling.density.mod <- lm(log.seedling.density ~ precip + tmean + hli, data = regressions.df)
anova(seedling.density.mod) # significant portion of variance explained by precip and tmean
summary(seedling.density.mod) # tmean and precip are significant predictors
```

Canopy Cover
```{r}
densiometer.mod <- lm(densiometer ~ precip + tmean + hli, data = regressions.df)
anova(densiometer.mod) # significant portion of variance explained by precip
summary(densiometer.mod) # precip is significant predictor
```

Scatterplots
```{r}
main.df %>% 
  pivot_longer(cols = c(precip, tmean, vpdmax, hli), names_to = 'climate_var', values_to = 'climate_val') %>% 
  pivot_longer(cols = c(grass.pct, herb.pct, shrub.pct, seedling.pct, densiometer, log.seedling.density), values_to = 'field_val', names_to = 'field_var') %>%
  ggplot(aes(x = climate_val, y = field_val)) +
    geom_point(alpha = 0.65, color = 'gray30') +
    geom_smooth(method = 'lm', color = 'black', alpha = 0.6) +
    stat_cor(label.y.npc = 'top', label.x.npc = 'middle') +
    stat_regline_equation(label.y.npc = 'top', label.x.npc = 'left') +
    facet_grid(field_var ~ climate_var, scales = 'free', labeller = labeller(climate_var = climate_var_names, field_var = field_var_names)) +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title = element_blank(),
          axis.text = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))
ggsave(here('figures', 'climate.vs.field.regressions.png'), height = 11, width = 16)
```


# -------------------
# Field Cluster Analysis

# K-Means Cluster Analysis
**Using Field Data**

Prepping dataset
```{r}
# Only interested in the field data metrics
field.df <- main.df %>% 
  select(grass.pct, herb.pct, shrub.pct, seedling.pct, green.pct, npv.pct, log.seedling.density, densiometer) %>%  # trying log seedling density first
  drop_na(seedling.pct)

# Scaling, centering all metrics
field.scaled.df <- as.data.frame(scale(field.df))
```

The below chunks are from Madeline's code
```{r}
## 3 ways to determine optimal cluster 
# 1. optimal cluster at the elbow
factoextra::fviz_nbclust(field.scaled.df, kmeans, method = "wss") # 2, 4 or 7 clusters

# 2. optimal cluster from gap statistic: high point!
gap_stat <- clusGap(field.scaled.df,
                    FUN = kmeans,
                    nstart = 25,
                    K.max = 10,
                    B = 50)
# plot number of clusters vs. gap statistic
fviz_gap_stat(gap_stat) # Unclear

# 3. silhouette analysis
fviz_nbclust(field.scaled.df, kmeans, method = "silhouette") # Looks like 2
```


```{r}
#perform k-means clustering with k = 2 clusters
km <- kmeans(field.scaled.df, centers = 2) # Note I removed nstart = 33, what does this mean?; note: I also tried k = 5

#view results
km

#plot results of final k-means model
fviz_cluster(km, data = field.scaled.df)

#find unscaled (real-value) means of each cluster
aggregate(field.df, by=list(cluster=km$cluster), mean)

#add cluster assigment to dataframes
field.scaled.df <- cbind(field.scaled.df, cluster = km$cluster)
field.df <- cbind(field.df, field.cluster = km$cluster)
field.cluster.df <- merge(field.df, main.df, by = c('grass.pct', 'herb.pct', 'shrub.pct', 'seedling.pct', 'log.seedling.density')) %>% 
  distinct(Plot, .keep_all = T) %>% # removing duplicates
  rename(green.pct = green.pct.x, npv.pct = npv.pct.x) %>% 
  select(-green.pct.y, -npv.pct.y)
```

### Visualizations
```{r}
# Lengthening dataframe, adding RdNBR, scaled recovery metric, and delta NBR (deviation from prefire conditions)
long.field.cluster.df <- field.cluster.df %>% 
  pivot_longer(cols = c(`0`, `1`, `2`, `3`, `4`, `5`, `6`, `7`, `8`, `9`, `10`,
                        `11`, `12`, `13`, `14`, `15`, `16`, `17`, `18`, `19`, `20`,
                        `21`, `22`, `23`), names_to = 'relative_year', values_to = 'nbr') %>% 
  mutate(yearly_delta_nbr = nbr - predisturbance_nbr) %>% 
  mutate(scaled_recovery_metric = (nbr - disturbance_nbr)/(predisturbance_nbr - disturbance_nbr)) %>% 
  mutate(RdNBR = (predisturbance_nbr - nbr)/(sqrt(abs(predisturbance_nbr/1000)))) %>% 
  mutate(field.cluster = as.factor(field.cluster)) %>% 
  mutate(relative_year = as.numeric(relative_year))

# Average values
long.field.cluster.avg.df <- long.field.cluster.df %>% 
  group_by(field.cluster, relative_year) %>% 
  summarise(avg_nbr = mean(nbr), avg_delta_nbr = mean(yearly_delta_nbr), avg_srm = mean(scaled_recovery_metric), avg_RdNBR = mean(RdNBR))

# Time series visualizations
long.field.cluster.df %>% 
  ggplot(aes(x = relative_year, y = nbr, color = field.cluster)) +
    geom_point(alpha = 0.3) +
    geom_line(alpha = 0.1) +
    geom_line(data = long.field.cluster.avg.df, aes(x = relative_year, y = avg_nbr, color = field.cluster), alpha = 0.8, linewidth = 2) +
    labs(x = 'Relative Year (Fire = 10)', y = 'NBR', color = 'Field Cluster') +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 16),
          axis.text = element_text(size = 12),
          legend.title = element_text(face = 'bold', size = 16),
          legend.text = element_text(size = 14))
ggsave(here('figures', 'field.cluster.nbr.time.series.png'), height = 9, width = 14)

long.field.cluster.df %>% 
  ggplot(aes(x = relative_year, y = yearly_delta_nbr, color = field.cluster)) +
    geom_point(alpha = 0.3) +
    geom_line(alpha = 0.1) +
    geom_line(data = long.field.cluster.avg.df, aes(x = relative_year, y = avg_delta_nbr, color = field.cluster), alpha = 0.8, linewidth = 2) +
    labs(x = 'Relative Year (Fire = 10)', y = 'Change in NBR (Deviation from Prefire Avg)', color = 'Field Cluster') +
    theme_bw() +
    theme(axis.title = element_text(face = 'bold', size = 16),
          axis.text = element_text(size = 12),
          legend.title = element_text(face = 'bold', size = 16),
          legend.text = element_text(size = 14))
ggsave(here('figures', 'field.cluster.change.in.nbr.time.series.png'), height = 9, width = 14)
```

## Boxplots
Looking at field data cluster vs. field data
```{r}
field.cluster.df <- field.cluster.df %>% 
  rename(densiometer = densiometer.x) 

field.cluster.df %>% 
  mutate(field.cluster = as.factor(field.cluster)) %>% 
  pivot_longer(cols = c(grass.pct, herb.pct, shrub.pct, seedling.pct, green.pct, npv.pct, log.seedling.density, densiometer, slope), values_to = 'field_val', names_to = 'field_var')  %>% 
  ggplot(aes(x = field.cluster, y = field_val, color = field.cluster)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.8) +
    geom_jitter(width = 0.15, alpha = 0.3) +
    labs(x = 'Field Data Cluster', y = ' ') +
    facet_wrap(~field_var, scales = 'free', labeller = as_labeller(field_var_names)) +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))
ggsave(here('figures', 'field.cluster.field.boxplots.png'), height = 8, width = 9)
```

## Cluster vs. Cluster
Comparing the clusters based on the field data to those using the spectral trajectory data
```{r}
field.cluster.df %>% 
  ggplot(aes(x = field.cluster, y = cluster)) +
    geom_jitter(width = 0.1, height = 0.1) +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 16),
          axis.text = element_text(size = 14))
```

# -------------------

# Other Figures/Analyses
## Ridgeline Plots
```{r}
field.rect <- data.frame (xmin=-Inf, xmax=Inf, ymin=0, ymax=6.75)
traj.rect <- data.frame (xmin=-Inf, xmax=Inf, ymin=6.75, ymax=11)

# Using Spectral Trajectory Clusters
field.cluster.df %>% 
  mutate(`% Grass` = scale(grass.pct),
         `% Herb` = scale(herb.pct),
         `% Shrub` = scale(shrub.pct),
         `% Seedling` = scale(seedling.pct),
         `Log-Seedling Density` = scale(log.seedling.density),
         `Canopy Cover` = scale(densiometer),
         `Relative Regrowth` = scale(relative_regrowth),
         `% Recovery` = scale(pct_recovery),
         `Change in NBR` = scale(delta_nbr),
         `Fire Severity (dNBR)` = scale(dnbr)) %>% 
  pivot_longer(cols = c(`% Grass`, `% Herb`, `% Shrub`, `% Seedling`, `Log-Seedling Density`,`Canopy Cover`, `Relative Regrowth`,
                        `% Recovery`, `Change in NBR`, `Fire Severity (dNBR)`), names_to = 'var', values_to = 'val') %>%
  mutate(var=factor(var)) %>% 
  mutate(var=fct_relevel(var,c("% Grass", "% Herb", "% Shrub", "% Seedling", "Log-Seedling Density", "Canopy Cover", "Relative Regrowth", "% Recovery", "Change in NBR", "Fire Severity (dNBR)"))) %>%
  filter(val < 5) %>% 
  arrange(var) %>% 
  ggplot(aes(x = val, y = var, fill = cluster)) +
    geom_density_ridges(alpha = 0.75, size = 1, scale = 0.8, rel_min_height = 0.001) +
    geom_rect(data=field.rect, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill="#00E257", alpha=0.1, inherit.aes = FALSE) +
    geom_rect(data=traj.rect, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill="#50AAFF", alpha=0.1, inherit.aes = FALSE) +
    scale_fill_manual(values = c('black', 'gray70')) +
    theme_bw() +
    labs(fill = 'Spectral Trajectory Cluster') +
    theme(legend.position = 'top',
          axis.title = element_blank(),
          axis.text = element_text(face = 'bold', size = 14),
          axis.text.x = element_blank(),
          legend.title = element_text(face = 'bold', size = 16),
          legend.text = element_text(size = 14))
ggsave(here('figures', 'spectral.cluster.ridgeline.png'), height = 9, width = 14)

# Using Field Data Clusters
field.cluster.df %>% 
  mutate(`% Grass` = scale(grass.pct),
         `% Herb` = scale(herb.pct),
         `% Shrub` = scale(shrub.pct),
         `% Seedling` = scale(seedling.pct),
         `Log-Seedling Density` = scale(log.seedling.density),
         `Canopy Cover` = scale(densiometer),
         `Relative Regrowth` = scale(relative_regrowth),
         `% Recovery` = scale(pct_recovery),
         `Change in NBR` = scale(delta_nbr),
         `Fire Severity (dNBR)` = scale(dnbr),
         field.cluster = as.factor(field.cluster)) %>% 
  pivot_longer(cols = c(`% Grass`, `% Herb`, `% Shrub`, `% Seedling`, `Log-Seedling Density`, `Canopy Cover`, `Relative Regrowth`,`% Recovery`, `Change in NBR`, `Fire Severity (dNBR)`), names_to = 'var', values_to = 'val') %>%
  mutate(var=factor(var)) %>% 
  mutate(var=fct_relevel(var,c("% Grass", "% Herb", "% Shrub", "% Seedling", "Canopy Cover", "Log-Seedling Density", "Relative Regrowth", "% Recovery", "Change in NBR", "Fire Severity (dNBR)"))) %>%
  arrange(var) %>% 
  ggplot(aes(x = val, y = var, fill = field.cluster)) +
    geom_density_ridges(alpha = 0.75, size = 1, scale = 0.8, rel_min_height = 0.003) +
    geom_rect(data=field.rect, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill="#00E257", alpha=0.1, inherit.aes = FALSE) +
    geom_rect(data=traj.rect, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill="#50AAFF", alpha=0.1, inherit.aes = FALSE) +
    scale_fill_manual(values = c('black', 'gray70')) +
    theme_bw() +
    labs(fill = 'Field Data Cluster') +
    theme(legend.position = 'top',
          axis.title = element_blank(),
          axis.text.y = element_text(face = 'bold', size = 14),
          axis.text.x = element_blank(),
          legend.title = element_text(face = 'bold', size = 16),
          legend.text = element_text(size = 14))
ggsave(here('figures', 'field.cluster.ridgeline.png'), height = 9, width = 14)
```

## Map
```{r}
pal <- colorFactor(c("#7A4419", "#246EB9"), domain = c(1,2))
severity.pal <- colorNumeric(c('transparent', "#fdccb8", "#fc8f6f", '#f44d37', '#c5161b', 'darkred'), values(egley.fire),
  na.color = "transparent")

sites.map <- leaflet() %>% 
  setView(lat = 44.7,lng = -119.4, zoom = 7) %>% 
  addProviderTiles(providers$Stamen.TopOSMRelief, group = 'Topographic Map') %>% #Topographic: Stamen.TopOSMRelief, Street: Esri.WorldStreetMap
  addRasterImage(postfire.regen, opacity = 0.65, group = 'Postfire Recovery Prob.') %>% 
  addRasterImage(egley.fire, colors = severity.pal, opacity = 0.5, group = 'Fire Severity') %>% 
  addRasterImage(school.fire, colors = severity.pal, opacity = 0.5, group = 'Fire Severity') %>% 
  addRasterImage(easy.fire, colors = severity.pal, opacity = 0.5, group = 'Fire Severity') %>% 
  #addRasterImage(tower.fire, colors = severity.pal, opacity = 0.5, group = 'Fire Severity') %>% 
  addRasterImage(calamity.fire, colors = severity.pal, opacity = 0.5, group = 'Fire Severity') %>% 
  addRasterImage(BC.fire, colors = severity.pal, opacity = 0.5, group = 'Fire Severity') %>% 
  addRasterImage(HR.fire, colors = severity.pal, opacity = 0.5, group = 'Fire Severity') %>% 
  addRasterImage(flagtail.fire, colors = severity.pal, opacity = 0.5, group = 'Fire Severity') %>% 
  addRasterImage(wheeler.fire, colors = severity.pal, opacity = 0.5, group = 'Fire Severity') %>% 
  addCircleMarkers(data = field.cluster.df, lng = field.cluster.df$Long, lat = field.cluster.df$Lat, radius = 3,
                   color = ~pal(cluster), popup = ~paste(Plot, 'Cluster:', cluster),
                   label = ~paste(Plot, 'Cluster:', cluster),
                   stroke = F, fillOpacity = 1,
                   group = 'Field Sites (Spectral Trajectory)') %>% 
  addCircleMarkers(data = field.cluster.df, lng = field.cluster.df$Long, lat = field.cluster.df$Lat, radius = 3,
                   color = ~pal(field.cluster), popup = ~paste(Plot, 'Cluster:', cluster),
                   label = ~paste(Plot, 'Cluster:', cluster),
                   stroke = F, fillOpacity = 1,
                   group = 'Field Sites (Field Data)') %>% 
  addMeasure() %>% 
  addLayersControl(
    baseGroups = c('Topographic Map'),
    overlayGroups = c('Postfire Recovery Prob.', 'Fire Severity', 'Field Sites (Spectral Trajectory)', 'Field Sites (Field Data)'),
    options = layersControlOptions(collapsed = TRUE) 
  ) %>% 
  hideGroup(c('Postfire Recovery Prob.', 'Field Sites (Field Data)'))
sites.map

library(htmlwidgets)
saveWidget(sites.map, file = here('figures', 'Field.Plot.Map.html'))
```

## Comparing to Postfire Recovery Probability (Davis et. al.)
Maybe look into further, but it feels sort of like reinventing the wheel to a degree
```{r}
field.cluster.df %>% 
  drop_na(regen_prob) %>% 
  ggplot(aes(x = as.factor(field.cluster), y = regen_prob)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.8) +
    geom_jitter(width = 0.15, alpha = 0.3) +
    labs(x = 'Field Data Cluster', y = 'Postfire Recovery Probability') +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12))

field.cluster.df %>% 
  drop_na(regen_prob) %>% 
  ggplot(aes(x = cluster, y = regen_prob)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.8) +
    geom_jitter(width = 0.15, alpha = 0.3) +
    labs(x = 'Spectral Trajectory Cluster', y = 'Postfire Recovery Probability') +
    theme_bw() +
    theme(legend.position = 'none',
          axis.title = element_text(face = 'bold', size = 16),
          axis.text.x = element_text(size = 14),
          axis.text.y = element_text(size = 12))
#ggsave(here('figures', 'field.cluster.field.boxplots.png'), height = 8, width = 9)

# Normal distribution?
regen.lm1 <- lm(data = field.cluster.df, regen_prob ~ cluster)
plot(regen.lm1) # it's good
# Equal variances?
var.test(data = field.cluster.df, regen_prob ~ cluster) # Equal variances
# T-test
c1 <- field.cluster.df %>% 
  filter(cluster == 1) %>% 
  select(regen_prob)
c2 <- field.cluster.df %>% 
  filter(cluster == 2) %>% 
  select(regen_prob)
t.test(c1, c2, var.equal = T) # n.s.

# Normal distribution?
regen.lm2 <- lm(data = field.cluster.df, regen_prob ~ field.cluster)
plot(regen.lm2) # it's decent
# Equal variances?
var.test(data = field.cluster.df, regen_prob ~ field.cluster) # Equal variances
# T-test
c1 <- field.cluster.df %>% 
  filter(field.cluster == 1) %>% 
  select(regen_prob)
c2 <- field.cluster.df %>% 
  filter(field.cluster == 2) %>% 
  select(regen_prob)
t.test(c1, c2, var.equal = T) # significant

# Regressions

## Field Data ##
grass.regen.lm <- lm(data = field.cluster.df, grass.pct ~ regen_prob)
anova(grass.regen.lm)
summary(grass.regen.lm)

herb.regen.lm <- lm(data = field.cluster.df, herb.pct ~ regen_prob)
anova(herb.regen.lm)
summary(herb.regen.lm)

shrub.regen.lm <- lm(data = field.cluster.df, shrub.pct ~ regen_prob)
anova(shrub.regen.lm)
summary(shrub.regen.lm)

seedling.regen.lm <- lm(data = field.cluster.df, seedling.pct ~ regen_prob)
anova(seedling.regen.lm)
summary(seedling.regen.lm)

seedling.density.regen.lm <- lm(data = field.cluster.df, log.seedling.density ~ regen_prob)
anova(seedling.density.regen.lm)
summary(seedling.density.regen.lm)

densiometer.regen.lm <- lm(data = field.cluster.df, densiometer ~ regen_prob)
anova(densiometer.regen.lm)
summary(densiometer.regen.lm)

## Spectral Trajectory ##
relreg.regen.lm <- lm(data = field.cluster.df, relative_regrowth ~ regen_prob)
anova(relreg.regen.lm)
summary(relreg.regen.lm)

pctrec.regen.lm <- lm(data = field.cluster.df, pct_recovery ~ regen_prob)
anova(pctrec.regen.lm)
summary(pctrec.regen.lm)

fitted.slope.regen.lm <- lm(data = field.cluster.df, postfire_fitted_slope ~ regen_prob)
anova(fitted.slope.regen.lm)
summary(fitted.slope.regen.lm)

deltanbr.regen.lm <- lm(data = field.cluster.df, delta_nbr ~ regen_prob)
anova(deltanbr.regen.lm)
summary(deltanbr.regen.lm)

# Scatterplots
main.df %>% 
  pivot_longer(cols = c(grass.pct, herb.pct, shrub.pct, seedling.pct, densiometer, log.seedling.density), names_to = 'var', values_to = 'val') %>% 
  ggplot(aes(x = regen_prob, y = val)) +
    geom_point(alpha = 0.65, color = 'gray30') +
    geom_smooth(method = 'lm', color = 'black', alpha = 0.6) +
    stat_cor(label.y.npc = 'top', label.x.npc = 'middle') +
    stat_regline_equation(label.y.npc = 'top', label.x.npc = 'left') +
    facet_wrap( ~ var, scales = 'free', labeller = labeller(var = field_var_names)) +
    theme_bw() +
    labs(x = 'Postfire Regen. Probability') +
    theme(legend.position = 'none',
          axis.title.y = element_blank(),
          axis.title.x = element_text(face = 'bold', size = 14),
          axis.text = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))
ggsave(here('figures', 'postfire.prob.vs.field.regressions.png'), height = 11, width = 16)

spectral_var_names <- c(relative_regrowth = 'Relative Regrowth',
                     pct_recovery = '% Recovery',
                     delta_nbr = 'Change in NBR (Postfire Avg - Prefire Avg)',
                     postfire_fitted_slope = 'Postfire Fitted Slope')

main.df %>% 
  pivot_longer(cols = c(relative_regrowth, pct_recovery, delta_nbr, postfire_fitted_slope), names_to = 'var', values_to = 'val') %>% 
  ggplot(aes(x = regen_prob, y = val)) +
    geom_point(alpha = 0.65, color = 'gray30') +
    geom_smooth(method = 'lm', color = 'black', alpha = 0.6) +
    stat_cor(label.y.npc = 'top', label.x.npc = 'middle') +
    stat_regline_equation(label.y.npc = 'top', label.x.npc = 'left') +
    facet_wrap( ~ var, scales = 'free', labeller = labeller(var = spectral_var_names)) +
    theme_bw() +
    labs(x = 'Postfire Regen. Probability') +
    theme(legend.position = 'none',
          axis.title.y = element_blank(),
          axis.title.x = element_text(face = 'bold', size = 14),
          axis.text = element_text(size = 12),
          strip.text = element_text(face = 'bold', size = 12))
ggsave(here('figures', 'postfire.prob.vs.spectral.regressions.png'), height = 11, width = 16)
```

## Stepwise Mixed Effects Model Selection
```{r}
# No NAs, scale and center all variables
mem.df <- field.cluster.df %>% 
  drop_na(slope) %>% 
  mutate(grass.pct = scale(grass.pct), herb.pct = scale(herb.pct), shrub.pct = scale(shrub.pct), seedling.pct = scale(seedling.pct), log.seedling.density = scale(log.seedling.density), green.pct = scale(green.pct), npv.pct = scale(npv.pct), densiometer = scale(densiometer), postdisturbance_nbr = scale(postdisturbance_nbr), delta_nbr = scale(delta_nbr), relative_regrowth = scale(relative_regrowth), pct_recovery = scale(pct_recovery), postfire_fitted_rsq = scale(postfire_fitted_rsq), postfire_fitted_slope = scale(postfire_fitted_slope), hli = scale(hli), precip = scale(precip), tmean = scale(tmean), vpdmax = scale(vpdmax), seedling.density = scale(seedling.density), aspect = scale(aspect), slope = scale(slope), dnbr = scale(dnbr))
```

### % Shrub
```{r}
# 'Full Model'
sh_lme_full <- lmer(shrub.pct ~ delta_nbr + relative_regrowth + pct_recovery + postfire_fitted_slope + hli + slope + aspect + precip + tmean + dnbr + (1|fire), data = mem.df)
multicollinearity(sh_lme_full)
summary(sh_lme_full, ddf = 'Kenward-Roger')
# Spectral metrics: relative_regrowth, postfire_fitted_slope, pct_recovery all *statistically significant*; delta_nbr not
# Topography metrics: slope most important (but not hugely significant), followed by aspect and then HLI
# Climate metrics: relatively unimportant

# Stepwise model selection using Kenward-Roger approximation of p-value
sh_step <- step(sh_lme_full, ddf = 'Kenward-Roger')
sh_final <- get_model(sh_step)

# Checking out selected model
summary(sh_final, ddf = 'Kenward-Roger')
```

### % Seedling
```{r}
# 'Full Model'
seed_lme_full <- lmer(seedling.pct ~ delta_nbr + relative_regrowth + pct_recovery + postfire_fitted_slope + hli + slope + aspect + precip + tmean + dnbr + (1|fire), data = mem.df)
multicollinearity(seed_lme_full)
summary(seed_lme_full, ddf = 'Kenward-Roger')
# Spectral metrics: relative_regrowth most important; postfire_fitted_slope, delta_nbr also *statistically significant*; pct_recovery not
# Topography metrics: HLI and aspect both significant; slope not
# Climate metrics: precip and tmean both significant

# Stepwise model selection using Kenward-Roger approximation of p-value
seed_step <- step(seed_lme_full, ddf = 'Kenward-Roger')
seed_final <- get_model(seed_step)

# Checking out selected model
summary(seed_final, ddf = 'Kenward-Roger')
```

### Log Seedling Density
```{r}
# 'Full Model'
dens_lme_full <- lmer(log.seedling.density ~ delta_nbr + relative_regrowth + pct_recovery + postfire_fitted_slope + hli + slope + aspect + precip + tmean + dnbr + (1|fire), data = mem.df)
multicollinearity(dens_lme_full)
summary(dens_lme_full, ddf = 'Kenward-Roger')
# Spectral metrics: none significant; relative_regrowth and postfire_fitted_slope are 'best'
# Topography metrics: aspect significant; HLI good predictor; slope not
# Climate metrics: tmean significant; precip important (p = 0.053)

# Stepwise model selection using Kenward-Roger approximation of p-value
dens_step <- step(dens_lme_full, ddf = 'Kenward-Roger')
dens_final <- get_model(dens_step)

# Checking out selected model
summary(dens_final, ddf = 'Kenward-Roger')
```

### % Herb
```{r}
# 'Full Model'
herb_lme_full <- lmer(herb.pct ~ delta_nbr + relative_regrowth + pct_recovery + postfire_fitted_slope + hli + slope + aspect + precip + tmean + dnbr + (1|fire), data = mem.df)
multicollinearity(herb_lme_full)
summary(herb_lme_full, ddf = 'Kenward-Roger')
# Spectral metrics: postfire_fitted_slope is significant; pct_recovery, relative_regrowth, delta_nbr follows (all not significant)
# Topography metrics: slope is significant; otherwise, not
# Climate metrics: neither significant, but tmean is close

# Stepwise model selection using Kenward-Roger approximation of p-value
herb_step <- step(herb_lme_full, ddf = 'Kenward-Roger')
herb_final <- get_model(herb_step)

# Checking out selected model
summary(herb_final, ddf = 'Kenward-Roger')
```

### % Grass
```{r}
# 'Full Model'
grass_lme_full <- lmer(grass.pct ~ delta_nbr + relative_regrowth + pct_recovery + postfire_fitted_slope + hli + slope + aspect + precip + tmean + dnbr + (1|fire), data = mem.df)
multicollinearity(grass_lme_full)
summary(grass_lme_full, ddf = 'Kenward-Roger')
# Spectral metrics: none significant
# Topography metrics: none significant
# Climate metrics: precip significant

# Stepwise model selection using Kenward-Roger approximation of p-value
grass_step <- step(grass_lme_full, ddf = 'Kenward-Roger')
grass_final <- get_model(grass_step)

# Checking out selected model
summary(grass_final, ddf = 'Kenward-Roger')
```

### % Green
```{r}
# 'Full Model'
green_lme_full <- lmer(green.pct ~ delta_nbr + relative_regrowth + pct_recovery + postfire_fitted_slope + hli + slope + aspect + precip + tmean + dnbr + (1|fire), data = mem.df)
multicollinearity(green_lme_full)
summary(green_lme_full, ddf = 'Kenward-Roger')
# Spectral metrics: postfire_fitted_slope is significant; relative_regrowth, delta_nbr, pct_recovery follows (all not significant)
# Topography metrics: none significant, but aspect is close
# Climate metrics: neither significant

# Stepwise model selection using Kenward-Roger approximation of p-value
green_step <- step(green_lme_full, ddf = 'Kenward-Roger')
green_final <- get_model(green_step)

# Checking out selected model
summary(green_final, ddf = 'Kenward-Roger')
```

### % NPV
```{r}
# 'Full Model'
npv_lme_full <- lmer(npv.pct ~ delta_nbr + relative_regrowth + pct_recovery + postfire_fitted_slope + hli + slope + aspect + precip + tmean + dnbr + (1|fire), data = mem.df)
multicollinearity(npv_lme_full)
summary(npv_lme_full, ddf = 'Kenward-Roger')
# Spectral metrics: postfire_fitted_slope, pct_recovery, and relative_regrowth are all significant
# Topography metrics: none significant
# Climate metrics: neither significant, but tmean is close

# Stepwise model selection using Kenward-Roger approximation of p-value
npv_step <- step(npv_lme_full, ddf = 'Kenward-Roger')
npv_final <- get_model(npv_step)

# Checking out selected model
summary(npv_final, ddf = 'Kenward-Roger')
```

### Canopy Cover
```{r}
# 'Full Model'
cc_lme_full <- lmer(densiometer ~ delta_nbr + relative_regrowth + pct_recovery + postfire_fitted_slope + hli + slope + aspect + precip + tmean + dnbr + (1|fire), data = mem.df)
multicollinearity(cc_lme_full)
summary(cc_lme_full, ddf = 'Kenward-Roger')
# Spectral metrics: postfire_fitted_slope, pct_recovery, and relative_regrowth are all significant
# Topography metrics: none significant
# Climate metrics: neither significant, but tmean is close

# Stepwise model selection using Kenward-Roger approximation of p-value
cc_step <- step(cc_lme_full, ddf = 'Kenward-Roger')
cc_final <- get_model(cc_step)

# Checking out selected model
summary(cc_final, ddf = 'Kenward-Roger')
```

### Model Summary Table
```{r}
tab_model(sh_final, seed_final, dens_final, herb_final, grass_final, green_final, npv_final, cc_final,
          show.reflvl = T,
          digits = 3,
          show.aic = T,
          show.ci = F,
          show.icc = F,
          string.pred = 'Coefficient',
          title = 'Stepwise Model Selection Table',
          string.p = 'P-Value',
          p.style = 'stars')
```

## Information-Based Mixed Effects Model Selection
### Data Wrangling
```{r}
mem.predictors <- mem.df %>% 
  select(delta_nbr, relative_regrowth , pct_recovery , postfire_fitted_slope , hli , slope , aspect , precip , tmean, dnbr)
```

### % Shrub
```{r}
sh.mem.selection <- mem.selection('shrub.pct', mem.predictors, mem.df)
sh.model.df <- sh.mem.selection[[1]]
sh.mod.list <- sh.mem.selection[[2]]
sh.top.mem <- mem.selection.table(sh.model.df, sh.mod.list, 'Shrub_pct_MEM.html') %>% 
  mutate(field.var = 'shrub.pct')
```

### % Seedling
```{r}
seed.mem.selection <- mem.selection('seedling.pct', mem.predictors, mem.df)
seed.model.df <- seed.mem.selection[[1]]
seed.mod.list <- seed.mem.selection[[2]]
seed.top.mem <- mem.selection.table(seed.model.df, seed.mod.list, 'Seedling_pct_MEM.html') %>% 
  mutate(field.var = 'seedling.pct')
```

### Log Seedling Density
```{r}
dens.mem.selection <- mem.selection('log.seedling.density', mem.predictors, mem.df)
dens.model.df <- dens.mem.selection[[1]]
dens.mod.list <- dens.mem.selection[[2]]
dens.top.mem <- mem.selection.table(dens.model.df, dens.mod.list, 'Seedling_density_MEM.html') %>% 
  mutate(field.var = 'log.seedling.density')
```

### % Herb
```{r}
herb.mem.selection <- mem.selection('herb.pct', mem.predictors, mem.df)
herb.model.df <- herb.mem.selection[[1]]
herb.mod.list <- herb.mem.selection[[2]]
herb.top.mem <- mem.selection.table(herb.model.df, herb.mod.list, 'Herb_pct_MEM.html') %>% 
  mutate(field.var = 'herb.pct')
```

### % Grass
```{r}
grass.mem.selection <- mem.selection('grass.pct', mem.predictors, mem.df)
grass.model.df <- grass.mem.selection[[1]]
grass.mod.list <- grass.mem.selection[[2]]
grass.top.mem <- mem.selection.table(grass.model.df, grass.mod.list, 'Grass_pct_MEM.html') %>% 
  mutate(field.var = 'grass.pct')
```

### % Green
```{r}
green.mem.selection <- mem.selection('green.pct', mem.predictors, mem.df)
green.model.df <- green.mem.selection[[1]]
green.mod.list <- green.mem.selection[[2]]
green.top.mem <- mem.selection.table(green.model.df, green.mod.list, 'Green_pct_MEM.html') %>% 
  mutate(field.var = 'green.pct')
```

### % NPV
```{r}
npv.mem.selection <- mem.selection('npv.pct', mem.predictors, mem.df)
npv.model.df <- npv.mem.selection[[1]]
npv.mod.list <- npv.mem.selection[[2]]
npv.top.mem <- mem.selection.table(npv.model.df, npv.mod.list, 'NPV_pct_MEM.html') %>% 
  mutate(field.var = 'npv.pct')
```

### Canopy Cover
```{r}
cc.mem.selection <- mem.selection('densiometer', mem.predictors, mem.df)
cc.model.df <- cc.mem.selection[[1]]
cc.mod.list <- cc.mem.selection[[2]]
cc.top.mem <- mem.selection.table(cc.model.df, cc.mod.list, 'Canopy_cover_MEM.html') %>% 
  mutate(field.var = 'densiometer')
```

### Coefficients Table
```{r}
top.mem <- rbind(sh.top.mem, seed.top.mem, dens.top.mem, herb.top.mem, grass.top.mem, green.top.mem, npv.top.mem, cc.top.mem)
top.mem.list <- list()
for(i in 1:nrow(top.mem)){
  if(top.mem$field.var[i] == 'shrub.pct'){
    top.mem.list[[i]] <- sh.mod.list[[top.mem$model.id[i]]]
  } else if(top.mem$field.var[i] == 'seedling.pct'){
    top.mem.list[[i]] <- seed.mod.list[[top.mem$model.id[i]]]
  } else if(top.mem$field.var[i] == 'log.seedling.density'){
    top.mem.list[[i]] <- dens.mod.list[[top.mem$model.id[i]]]
  } else if(top.mem$field.var[i] == 'herb.pct'){
    top.mem.list[[i]] <- herb.mod.list[[top.mem$model.id[i]]]
  } else if(top.mem$field.var[i] == 'grass.pct'){
    top.mem.list[[i]] <- grass.mod.list[[top.mem$model.id[i]]]
  } else if(top.mem$field.var[i] == 'green.pct'){
    top.mem.list[[i]] <- green.mod.list[[top.mem$model.id[i]]]
  } else if(top.mem$field.var[i] == 'npv.pct'){
    top.mem.list[[i]] <- npv.mod.list[[top.mem$model.id[i]]]
  } else if(top.mem$field.var[i] == 'densiometer'){
    top.mem.list[[i]] <- cc.mod.list[[top.mem$model.id[i]]]
  }
}

tab_model(top.mem.list,
          show.reflvl = TRUE,
          digits = 3,
          show.aic = TRUE,
          show.ci = FALSE,
          show.icc = FALSE,
          string.pred = "Coeffcient",
         title = "MEM Selection: Coefficients, Significance for Top Models",
  string.p = "P-Value",
  p.style = "stars",
  file = here('figures', 'MEM', 'Top_MEM_Coef.html'))
```
