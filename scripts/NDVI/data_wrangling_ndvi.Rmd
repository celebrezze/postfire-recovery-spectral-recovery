---
title: "NDVI Data Wrangling"
author: "Joe Celebrezze"
date: "2024-03-27"
output: html_document
---
# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(here)
here = here::here

source(here("scripts", "source_code.R"))
source(here("scripts", "mem.selection.function.R"))
library(ggpp)
library(ggfortify)
library(leaflet)
library(corrplot)
library(factoextra)
library(cluster)
library(ggpubr)
library(sp)
library(terra)
library(ggridges)
library(av) # to save NDVI animation
library(lme4) # for mixed effects models
library(lmerTest)
library(sjPlot) # for tab_model
library(kableExtra)
library(gtools)
library(performance)
extract = raster::extract
group_by = dplyr::group_by
filter = dplyr::filter

# Buffered random sampling function (from AJM)
source(here("scripts", "sample_random_dist.R"))
```

# Field Data
2023 Field Data
```{r}
understory <- read.csv(here('data', 'field_data', 'field.data.understory.csv'))
colnames(understory)[1] <- 'Plot'
seedlings <- read.csv(here('data', 'field_data', 'field.data.seedlings.csv'))
colnames(seedlings)[1] <- 'Plot'
overview <- read.csv(here('data', 'field_data', 'field.data.overview.csv'))[1:80,2:13]
densiometer <- read.csv(here('data', 'field_data', 'field.data.densiometer.csv'))
trees <- read.csv(here('data', 'field_data', 'field.data.trees.csv'))[,1:9]
```

2022 Field Data (Madeline's)
```{r}
field.data.2022 <- read.csv(here('data', 'field_data', 'Plot_FieldData_AllFires.csv'))[,2:20]
colnames(field.data.2022)[1] <- 'Plot'
seedlings.2022 <- read.csv(here('data', 'field_data', 'MF.field.seedlings.csv'))[,1:9]
trees.2022 <- read.csv(here('data', 'field_data', 'MF.field.trees.csv'))[,1:10]
```

## Understory Cover
```{r}
understory.summary <- understory %>% 
  group_by(Plot) %>% 
  summarise(grass.pct = mean(grass.pct), herb.pct = mean(herb.pct), shrub.pct = mean(shrub.pct), seedling.pct = mean(seedling.pct), green.pct = mean(green.pct), npv.pct = mean(npv.pct), soil.pct = mean(soil.pct), cluster = cluster) %>% 
  drop_na(cluster) %>% 
  distinct()

understory.summary.long <- understory.summary %>% 
  pivot_longer(cols = !c(Plot, cluster), names_to = 'var', values_to = 'value')
```

## Seedlings
```{r}
seedlings.clean.spp <- seedlings %>% 
  mutate(DBH = as.numeric(DBH), Ht = as.numeric(Ht), Plot.Size = as.numeric(Plot.Size), count = 1) %>% 
  group_by(Plot, Spec) %>% 
  add_tally(wt = count) %>% 
  summarise(species = Spec, plot.size = Plot.Size, height = mean(Ht), dbh = mean(DBH), seed.tree = Seed.Tree, cluster = cluster, no.seedlings = ifelse(is.na(DBH), 0, n)) %>% 
  distinct() %>% 
  mutate(seedlings.per.msq = no.seedlings/plot.size,
         seed.tree = ifelse(seed.tree == '>300', '300', seed.tree),
         seed.tree = as.numeric(seed.tree))

# DOMINANT SEEDLING SPECIES
# setting up dataframe
dom.seedling.spp <- data.frame(Plot = overview$Plot, dom.seedling.spp = c(rep(NA, nrow(overview))))
# for each plot, determining which species have the most seedlings
for(i in 1:nrow(overview)){
  df <- seedlings.clean.spp %>% 
    filter(Plot == overview$Plot[i])
  df2 <- df %>% 
    filter(no.seedlings == max(df$no.seedlings))
  ifelse(nrow(df2) == 1,
         dom.seedling.spp$dom.seedling.spp[i] <- df2$species[1],
         dom.seedling.spp$dom.seedling.spp[i] <- paste0(df2$species[1], '-', df2$species[2]))
}
rm(df, df2)
  
seedlings.clean <- seedlings %>% 
  mutate(DBH = as.numeric(DBH), Ht = as.numeric(Ht), Plot.Size = as.numeric(Plot.Size), count = 1) %>% 
  group_by(Plot) %>% 
  add_tally(wt = count) %>% 
  summarise(plot.size = Plot.Size, height = mean(Ht), dbh = mean(DBH), cluster = cluster, no.seedlings = ifelse(is.na(DBH), 0, n)) %>% 
  distinct() %>% 
  mutate(seedlings.per.msq = no.seedlings/plot.size)

seedlings.clean %>% 
  ggplot(aes(x = plot.size/20, y = no.seedlings)) +
    geom_point() +
    labs(x = 'Transect Width', y = 'Number of Juvenile Conifers') +
    theme_bw()
```

## Densiometer
```{r}
densiometer.clean <- densiometer %>% 
  mutate(NESW = (N + E + S + W)/.96) %>%  # % canopy cover (24 squares for each measurement, 96 total)
  group_by(Plot) %>% 
  summarise(densiometer = mean(NESW))
```

## Trees
I really don't know what to do with the trees data, but I think one potential use for them is as another regeneration metric (with the postfire regen. alive young trees indicating regen); I did this below, but still need to think of how to use the rest of the data
```{r}
# number of young trees
# dataset with counts for plots that had young trees
some.young.trees <- trees %>% 
  filter(Status == 'A') %>% 
  group_by(Plot) %>% 
  tally()
# dataset without any counts for plots that had young trees
zero.young.trees <- trees %>% 
  filter(Status %in% c('A', 'DF', 'DB')) %>% 
  group_by(Plot, Status) %>% 
  tally() %>% 
  pivot_wider(names_from = Status, values_from = n) %>% 
  filter(is.na(A)) %>% 
  mutate(n = 0) %>% 
  select(Plot, n)
zero.young.trees <- rbind(zero.young.trees, data.frame(Plot = c('EG-6-3', 'FL-1-X'), n = c(0, NA))) # didn't do trees at FL-1-X, no young trees at EG-6-3
# combining above and adding two plots without tree data as NA
num.young.trees <- rbind(some.young.trees, zero.young.trees) %>% 
  mutate(young.trees.per.msq = ifelse(Plot == 'EA-5-3', n/(pi*25), n/400)) # for EA-5-3, only did tree data for 5m radius; all others 11.3m radius (400 sq. m)
rm(some.young.trees, zero.young.trees)

# dominant tree species
# making dataframe w/ number of trees per species per plot
trees.spp.clean <- trees %>% 
  group_by(Plot, Species) %>% 
  tally()
# setting up dataframe
dom.trees.spp <- data.frame(Plot = overview$Plot, dom.tree.spp = c(rep(NA, nrow(overview))))
# for each plot, determining which species have the most trees
for(i in 1:nrow(overview)){
  df <- trees.spp.clean %>% 
    filter(Plot == overview$Plot[i])
  df2 <- df %>% 
    filter(n == max(df$n))
  ifelse(nrow(df2) == 1,
         dom.trees.spp$dom.tree.spp[i] <- df2$Species[1],
         dom.trees.spp$dom.tree.spp[i] <- paste0(df2$Species[1], '-', df2$Species[2]))
}
rm(df, df2)
# combining dom.seedling.spp and dom.trees.spp dataframes
dom.spp <- merge(dom.trees.spp, dom.seedling.spp, by = 'Plot')

# clean trees dataframe (for now, just with dominant species and young.trees.per.msq)
trees.clean <- merge(dom.spp, num.young.trees) %>% 
  select(-n)
```

## Cleaning 2022 data
```{r}
field.data.2022.clean <- field.data.2022 %>% 
  filter(MTBS_sev > 3) %>% 
  select(Plot, Fire, Long, Lat, grass_cover, herb_cover, shrub_cover, seedling_cover, green_cover_total, npv_cover_total, seedling_density, densiometer, aspect, slope) %>% 
  rename(grass.pct = grass_cover, herb.pct = herb_cover, shrub.pct = shrub_cover, seedling.pct = seedling_cover, seedling.density = seedling_density, green.pct = green_cover_total, npv.pct = npv_cover_total) %>% 
  mutate(year = 2022) %>% 
  mutate(dom.tree.spp = NA, dom.seedling.spp = NA, young.tree.density = NA, regen.density = NA) # until we get data from Madeline
```

### Dominant Species
```{r}
# Seedlings
seedlings.2022.clean.spp <- seedlings.2022 %>% 
  mutate(Ht = as.numeric(Ht), Plot.Size = as.numeric(Plot.Size), count = 1) %>% 
  group_by(Plot, Spec) %>% 
  add_tally(wt = count) %>% 
  summarise(species = Spec, plot.size = Plot.Size, height = mean(Ht), seed.tree = Seed.Tree, no.seedlings = ifelse(is.na(Ht), 0, n)) %>% 
  distinct() %>% 
  mutate(seedlings.per.msq = no.seedlings/plot.size,
         seed.tree = ifelse(seed.tree == '>300', '300', seed.tree),
         seed.tree = as.numeric(seed.tree))

for(i in 1:nrow(field.data.2022.clean)){
  df <- seedlings.2022.clean.spp %>% 
    filter(Plot == field.data.2022.clean$Plot[i])
  df2 <- df %>% 
    filter(no.seedlings == max(df$no.seedlings))
  ifelse(nrow(df2) == 1,
         field.data.2022.clean$dom.seedling.spp[i] <- df2$species[1],
         field.data.2022.clean$dom.seedling.spp[i] <- paste0(df2$species[1], '-', df2$species[2]))
}
rm(df, df2)

# Trees
trees.2022.spp.clean <- trees.2022 %>% 
  group_by(Plot, Species) %>% 
  tally()

for(i in 1:nrow(field.data.2022.clean)){
  df <- trees.2022.spp.clean %>% 
    filter(Plot == field.data.2022.clean$Plot[i])
  df2 <- df %>% 
    filter(n == max(df$n))
  ifelse(nrow(df2) == 1,
         field.data.2022.clean$dom.tree.spp[i] <- df2$Species[1],
         field.data.2022.clean$dom.tree.spp[i] <- paste0(df2$Species[1], '-', df2$Species[2]))
}
rm(df, df2)
```

### Young Trees
```{r}
# dataset with counts for plots that had young trees
some.young.trees <- trees.2022 %>% 
  filter(Status == 'A') %>% 
  group_by(Plot) %>% 
  tally()
# dataset without any counts for plots that had young trees
zero.young.trees <- trees.2022 %>% 
  filter(Status %in% c('A', 'DF', 'DB', 'D')) %>% 
  group_by(Plot, Status) %>% 
  tally() %>% 
  pivot_wider(names_from = Status, values_from = n) %>% 
  filter(is.na(A)) %>% 
  mutate(n = 0) %>% 
  select(Plot, n)
zero.young.trees <- rbind(zero.young.trees, data.frame(Plot = c('HRS8', 'TS1'), n = c(0, NA))) # no young trees at HRS8, Tower data not included in final analysis
# combining above
num.young.trees <- rbind(some.young.trees, zero.young.trees) %>% 
  mutate(young.trees.per.msq = ifelse(is.na(n), NA, n/400)) %>% 
  select(-n)
rm(some.young.trees, zero.young.trees)

field.data.2022.clean <- merge(field.data.2022.clean, num.young.trees, by = 'Plot') %>% 
  mutate(young.tree.density = 10000*young.trees.per.msq) %>% 
  mutate(regen.density = seedling.density + young.tree.density) %>%
  select(Plot, Fire, Long, Lat, grass.pct, herb.pct, shrub.pct, seedling.pct, green.pct, npv.pct, aspect, slope, seedling.density, densiometer, dom.tree.spp, dom.seedling.spp, young.tree.density, regen.density, year)
```

## 2022 + 2023 Data
```{r}
seedlings.merge <- seedlings.clean %>% 
  group_by(Plot) %>% 
  summarise(seedlings.per.msq = max(seedlings.per.msq))

field.data.2023 <- merge(overview, understory.summary, by = 'Plot')
field.data.2023 <- merge(seedlings.merge, field.data.2023, by = 'Plot')
field.data.2023 <- merge(densiometer.clean, field.data.2023, by = 'Plot')
field.data.2023 <- merge(trees.clean, field.data.2023, by = 'Plot')
```

```{r}
field.data.2023.clean <- field.data.2023 %>% 
  mutate(Fire = case_when(str_detect(Plot, 'FL') ~ 'Flagtail',
                                 str_detect(Plot, 'EA') ~ 'Easy',
                                 str_detect(Plot, 'CA') ~ 'Calamity',
                                 str_detect(Plot, 'EG') ~ 'Egley',
                                 str_detect(Plot, 'WH') ~ 'Wheeler')) %>% 
  mutate(seedling.density = 10000*seedlings.per.msq) %>% # converting it to seedlings/hectare
  mutate(young.tree.density = 10000*young.trees.per.msq) %>% 
  mutate(regen.density = seedling.density + young.tree.density) %>% 
  rename(aspect = Azimuth, slope = Slope) %>% 
  select(Plot, Fire, Long, Lat, grass.pct, herb.pct, shrub.pct, seedling.pct, green.pct, npv.pct, aspect, slope, seedling.density, densiometer, dom.tree.spp, dom.seedling.spp, young.tree.density, regen.density) %>% 
  mutate(year = 2023)

field.data.both <- rbind(field.data.2022.clean, field.data.2023.clean) %>% 
  distinct() %>%  # removing duplicates
  unite('x_y', c(Long, Lat), sep = '_', remove = F) %>% 
  filter(x_y != '-118.824737391_44.038454561') # removing duplicate CA-3-2 value
  
field.data.both %>%
  mutate(log.seedling.density = log(seedling.density)) %>% 
  pivot_longer(cols = !c(x_y, Plot, Fire, Lat, Long, aspect, year, dom.tree.spp, dom.seedling.spp), names_to = 'var', values_to = 'val') %>% 
  ggplot(aes(x = val, fill = var)) +
  geom_density() +
  facet_wrap(~var, scales = 'free') +
  theme_bw() +
  labs(x = ' ', y = 'Density') +
  theme(legend.position = "none",
        axis.title = element_text(face = 'bold', size = 14),
        axis.text.x = element_text(size = 12, angle = 20),
        axis.text.y = element_text(size = 12),
        legend.title = element_text(face = 'bold', size = 14),
        legend.text = element_text(size = 12))


field.data.both %>%
  mutate(log.seedling.density = log(seedling.density), log.regen.density = log(regen.density)) %>% 
  pivot_longer(cols = !c(x_y, Plot, Fire, Lat, Long, aspect, year, seedling.density, dom.tree.spp, dom.seedling.spp, regen.density, young.tree.density), names_to = 'var', values_to = 'val') %>% 
  ggplot(aes(x = as.factor(year), y = val, color = as.factor(year))) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = 0.1, height = 0.01, alpha = 0.4, aes(color = as.factor(year))) +
    facet_wrap(~var, scales = 'free') +
    labs(x = "Sampling Year", y = " ") +
    theme_bw() +
    theme(legend.position = 'none',
        axis.title = element_text(face = 'bold', size = 16),
        axis.text = element_text(size = 14),
        axis.text.x = element_text(size = 12))
```

# Rasters
```{r}
# Postfire Regen. Data (Davis et al)
postfire.regen <- raster(here('data', 'regen_prob', 'postfire_regen_prob.tif'))
# Blue Mtns. Raster
blue.mtns.ras <- raster(here('data', 'blue_mtns_misc', 'bluemtnsras.tif'))
blue.mtns.ras <- projectRaster(from = blue.mtns.ras, to = postfire.regen, method = 'ngb')

# LANDSAT Forest Data
# Canopy Cover Data
canopy.cover <- raster(here('data', 'site_selection', 'LANDFIRE_2001_Canopy_Cover', 'us_105cc.tif'))
# Vegetation Height Data
veg.height <- raster(here('data', 'site_selection', 'LANDFIRE_2001_Veg_Height', 'us_105evh.tif'))
# Fuel Veg Height Data
fuel.veg.height <- raster(here('data', 'site_selection', 'LANDFIRE_2022_Fuel_Veg_Height', 'LC22_FVH_230.tif'))
# Fuel Cover Data
fuel.cover <- raster(here('data', 'site_selection', 'LANDFIRE_2022_Fuel_Cover', 'LC22_FVC_230.tif'))

# NDVI Data
ndvi_Easy <- raster::stack(here('data', 'processed_data', 'NDVI', 'NDVI_Easy.tif'))
ndvi_Calamity <- raster::stack(here('data', 'processed_data', 'NDVI', 'NDVI_Calamity.tif'))
ndvi_Flagtail <- raster::stack(here('data', 'processed_data', 'NDVI', 'NDVI_Flagtail.tif'))
ndvi_Wheeler <- raster::stack(here('data', 'processed_data', 'NDVI', 'NDVI_Wheeler.tif'))
ndvi_BC <- raster::stack(here('data', 'processed_data', 'NDVI', 'NDVI_BC.tif'))
ndvi_HR <- raster::stack(here('data', 'processed_data', 'NDVI', 'NDVI_HR.tif'))
ndvi_School <-raster::stack(here('data', 'processed_data', 'NDVI', 'NDVI_School.tif'))

# CHILI Data
chili_Egley <- raster(here('data', 'site_selection', 'CHILI_Egley.tif'))
chili_Easy <- raster(here('data', 'site_selection', 'CHILI_Easy.tif'))
chili_Calamity <- raster(here('data', 'site_selection', 'CHILI_Calamity.tif'))
chili_Flagtail <- raster(here('data', 'site_selection', 'CHILI_Flagtail.tif'))
chili_Wheeler <- raster(here('data', 'site_selection', 'CHILI_WheelerPoint.tif'))
chili_BC <- raster(here('data', 'site_selection', 'CHILI_BridgeCreek.tif'))
chili_HR <- raster(here('data', 'site_selection', 'CHILI_HashRock.tif'))
chili_School <- raster(here('data', 'site_selection', 'CHILI_School.tif'))

# MTBS Data
School_mtbs <- raster(here('data', 'site_selection', 'school_severity.tif'))
BC_mtbs <- raster(here('data', 'site_selection', 'bridge_creek_severity.tif'))
HR_mtbs <- raster(here('data', 'site_selection', 'hash_rock_severity.tif'))
Egley_mtbs <- raster(here('data', 'site_selection', 'egley_severity.tif'))
Easy_mtbs <- raster(here('data', 'site_selection', 'easy_severity.tif'))
Calamity_mtbs <- raster(here('data', 'site_selection', 'calamity_severity.tif'))
Flagtail_mtbs <- raster(here('data', 'site_selection', 'flagtail_severity.tif'))
Wheeler_mtbs <- raster(here('data', 'site_selection', 'wheeler_severity.tif'))

# AdaptWest Climate NA Data
cwd_present <- raster(here('data', 'climate', 'cwd_30yr_normal_present.tif')) # 1981-2010
cwd_future <- raster(here('data', 'climate', 'cwd_30yr_normal_future.tif')) # 2041-2070
```

## Egley
```{r}
ndvi_Egley1984 <- raster::stack(here('data', 'processed_data', 'NDVI', 'NDVI_Egley_1984_GS.tif'))
ndvi_Egley19852003 <- raster::stack(here('data', 'processed_data', 'NDVI', 'NDVI_Egley_1985_2003_GS.tif'))
ndvi_Egley20042021 <- raster::stack(here('data', 'processed_data', 'NDVI', 'NDVI_Egley_2004_2021_GS.tif'))

ndvi_Egley <- raster::stack(ndvi_Egley1984, ndvi_Egley19852003, ndvi_Egley20042021)
```


# NDVI
## Field Sites
Note: crs proj string: '+proj=longlat +datum=WGS84 +no_defs', but w/ updated packages, use of proj string seems like it's deprecated (?)
```{r}
fires <- c('Bridge Creek', 'Hash Rock', 'School', 'Egley', 'Easy', 'Flagtail', 'Calamity', 'Wheeler')
fires.abbrev <- c('BC', 'HR', 'School', 'Egley', 'Easy', 'Flagtail', 'Calamity', 'Wheeler')
# add 'Egley' to above

# 2022 data
for(i in 1:3){
  df <- field.data.2022.clean %>% 
    filter(Fire == fires[i])
  xy <- df[,c(3,4)] # define coordinates
  pts <- df %>% 
    select(Long, Lat, Plot) %>% 
    SpatialPointsDataFrame(coords = xy, proj4string = crs(ndvi_BC)) # transform data to spatial points
  assign(paste0(fires.abbrev[i], '_pts'), pts)
  assign(paste0(fires.abbrev[i], '_df'), df)
}
rm(df, xy, pts)

# 2023 data
for(i in 4:8){
  df <- field.data.2023.clean %>% 
    filter(Fire == fires[i])
  xy <- df[,c(3,4)] # define coordinates
  pts <- df %>% 
    select(Long, Lat, Plot) %>% 
    SpatialPointsDataFrame(coords = xy, proj4string = crs(ndvi_Flagtail)) # transform data to spatial points
  assign(paste0(fires.abbrev[i], '_pts'), pts)
  assign(paste0(fires.abbrev[i], '_df'), df)
}
rm(df, xy, pts)
```

### Extracting NDVI
```{r, warning = FALSE}
# ndvi raster list
fires.ndvi <- list(ndvi_BC, ndvi_HR, ndvi_School, ndvi_Egley, ndvi_Easy, ndvi_Flagtail, ndvi_Calamity, ndvi_Wheeler)

# field data pts list
fires.field.pts <- list(BC_pts, HR_pts, School_pts, Egley_pts, Easy_pts, Flagtail_pts, Calamity_pts, Wheeler_pts)


#change band names
for(i in 1:length(fires)){
  names(fires.ndvi[[i]]) <- as.character(c(1984:2021))
}

#extract ndvi from rasters
for(i in 1:length(fires)){
  vals <- as.data.frame(extract(fires.ndvi[[i]], fires.field.pts[[i]])) %>% 
    mutate(fire = fires.abbrev[i])
  coords <- as.data.frame(fires.field.pts[[i]]) # add x and y coordinates to ndvi values dataframes
  vals <- cbind(coords, vals)
  assign(paste0('vals_', fires.abbrev[i]), vals)
}
rm(vals, coords)

# merge the individual fires into one dataframe
vals_2022 <- rbind(vals_BC, vals_HR, vals_School) %>% 
  select(-Long.1, -Lat.1)
vals_2023 <- rbind(vals_Calamity, vals_Flagtail, vals_Egley, vals_Easy, vals_Wheeler) %>% 
  select(-Long.1, -Lat.1) 
vals_all_fires <- rbind(vals_2022, vals_2023)

fires.field.vals <- list(vals_BC, vals_HR, vals_School, vals_Egley, vals_Easy, vals_Flagtail, vals_Calamity, vals_Wheeler)
```

# Random Sample
Because the 84 datapoints used in the fieldwork may be too limited to run a solid k-means cluster analysis, my thought was to combine the 84 datapoints with a random selection of datapoints from high severity burn in each of the fires and run a k-means cluster analysis on this enhanced dataset before comparing the field data to the clusters

## Random Selection of High Severity Burn Points
For this random selection, I based the # of points on the acres of high severity burn available as shown:
School: 5468 acres high severity
Tower: 17828 acres high severity (note: removed because we only have one point in 'high severity' burn)
Bridge Creek: 238 acres high severity
Hash Rock: 2967 acres high severity
Easy: 1143 acres high severity
Flagtail: 2843 acres high severity
Egley: 20855 acres high severity
Calamity: 304 acres high severity
Wheeler Point: 3098 acres high severity
Total: 51646 acres high severity

Converting to Albers Equal Area
```{r}
blue.mtns.aea.ras <- raster(here('data', 'blue_mtns_misc', 'bluemtnsras.tif'))

fires.mtbs <- list(BC_mtbs, HR_mtbs, School_mtbs, Egley_mtbs, Easy_mtbs, Flagtail_mtbs, Calamity_mtbs, Wheeler_mtbs)
fires.mtbs.aea <- list()

for(i in 1:length(fires.mtbs)){
  fires.mtbs.aea[[i]] <- projectRaster(fires.mtbs[[i]], crs = crs(blue.mtns.aea.ras))
}
```


```{r}
fires.mtbs <- list(BC_mtbs, HR_mtbs, School_mtbs, Egley_mtbs, Easy_mtbs, Flagtail_mtbs, Calamity_mtbs, Wheeler_mtbs)
random.selection.no.pts.fires <- c(38, 72, 103, 296, 49, 71, 39, 74)

for(i in 1:length(fires)){
  index_xy = which(fires.mtbs.aea[[i]][] == 4)
  xy_coord = coordinates(fires.mtbs.aea[[i]])
  x_in_arr = xy_coord[index_xy, 1]
  y_in_arr = xy_coord[index_xy, 2]
  
  df <- sample_random_dist(x_in_arr, y_in_arr, 
                      num_points=random.selection.no.pts.fires[i], 
                      distance=400, seed=16)
  xy <- df[,c(1,2)]
  pts <- df %>% 
    SpatialPointsDataFrame(coords = xy, proj4string = crs(fires.mtbs.aea[[i]])) %>%  # transform data to spatial points
    spTransform(crs(fires.mtbs[[i]]))
  
  assign(paste0(fires.abbrev[i], '_pts_R'), pts)
}
rm(xy, df, pts, index_xy, xy_coord, y_in_arr, x_in_arr)
```

Let's randomly select ~2580 points in addition to our field plots, so each of the # of acres of high severity burn can be divided by 20 when randomly selecting points (OLD VERSION)

fires.mtbs <- list(BC_mtbs, HR_mtbs, School_mtbs, Egley_mtbs, Easy_mtbs, Flagtail_mtbs, Calamity_mtbs, Wheeler_mtbs)
random.selection.no.pts.fires <- c(12, 149, 274, 1043, 58, 143, 16, 155)

for(i in 1:length(fires)){
  index_xy = which(fires.mtbs[[i]][] == 4)
  xy_coord = coordinates(fires.mtbs[[i]])
  x_in_arr = xy_coord[index_xy, 1]
  y_in_arr = xy_coord[index_xy, 2]
  
  df <- sample_random_dist(x_in_arr, y_in_arr, 
                      num_points=random.selection.no.pts.fires[i], 
                      distance=0.003273548, seed=16)
  xy <- df[,c(1,2)]
  pts <- df %>% 
    SpatialPointsDataFrame(coords = xy, proj4string = crs(fires.mtbs[[i]])) # transform data to spatial points
  
  assign(paste0(fires.abbrev[i], '_pts_R'), pts)
}
rm(xy, df, pts, index_xy, xy_coord, y_in_arr, x_in_arr)


## NDVI Data
```{r, warning = FALSE}
fires.rand.pts <- list(BC_pts_R, HR_pts_R, School_pts_R, Egley_pts_R, Easy_pts_R, Flagtail_pts_R, Calamity_pts_R, Wheeler_pts_R)

for(i in 1:length(fires)){
  vals <- as.data.frame(extract(fires.ndvi[[i]], fires.rand.pts[[i]])) %>% 
    mutate(fire = fires.abbrev[i])
  coords <- as.data.frame(fires.rand.pts[[i]]) # add x and y coordinates to ndvi values dataframes
  vals <- cbind(coords, vals)
  assign(paste0('vals_R_', fires.abbrev[i]), vals)
}
rm(vals, coords)

vals_R_all_fires <- rbind(vals_R_BC, vals_R_HR, vals_R_School, vals_R_Egley, vals_R_Easy, vals_R_Flagtail, vals_R_Calamity, vals_R_Wheeler)

fires.r.vals <- list(vals_R_BC, vals_R_HR, vals_R_School, vals_R_Egley, vals_R_Easy, vals_R_Flagtail, vals_R_Calamity, vals_R_Wheeler)
```

## Removal of Non-Forest Pixels
Reprojecting Rasters
```{r}
# Canopy Cover and Existing Vegetation Height
for(i in 1:length(fires)){
  canopy.cover.h <- projectRaster(from = canopy.cover, to = fires.mtbs[[i]], method = 'ngb')
  veg.height.h <- projectRaster(from = veg.height, to = fires.mtbs[[i]], method = 'ngb')
  assign(paste0('cc_', fires.abbrev[i]), canopy.cover.h)
  assign(paste0('evh_', fires.abbrev[i]), veg.height.h)
}
rm(canopy.cover.h, veg.height.h)
# lists
fires.cc <- list(cc_BC, cc_HR, cc_School, cc_Egley, cc_Easy, cc_Flagtail, cc_Calamity, cc_Wheeler)
fires.evh <- list(evh_BC, evh_HR, evh_School, evh_Egley, evh_Easy, evh_Flagtail, evh_Calamity, evh_Wheeler)

# For wheeler point and hash rock fires, the fire was prior to the 2001 LANDFIRE data used above; instead, for these, going to try to use 2022 fuel vegetation height and fuel vegetation cover data which claims to do better at estimating pre-disturbance conditions
fvh_HR <- projectRaster(from = fuel.veg.height, to = HR_mtbs, method = 'ngb')
fvc_HR <- projectRaster(from = fuel.cover, to = HR_mtbs, method = 'ngb')
fvh_Wheeler <- projectRaster(from = fuel.veg.height, to = Wheeler_mtbs, method = 'ngb')
fvc_Wheeler <- projectRaster(from = fuel.cover, to = Wheeler_mtbs, method = 'ngb')
# making other fvh, fvc values as NULL so list works for 'for' loops
fvh_BC <- NULL 
fvh_School <- NULL
fvh_Egley <- NULL
fvh_Easy <- NULL
fvh_Flagtail <- NULL
fvh_Calamity <- NULL
fvc_BC <- NULL 
fvc_School <- NULL
fvc_Egley <- NULL
fvc_Easy <- NULL
fvc_Flagtail <- NULL
fvc_Calamity <- NULL
# lists
fires.fvh <- list(fvh_BC, fvh_HR, fvh_School, fvh_Egley, fvh_Easy, fvh_Flagtail, fvh_Calamity, fvh_Wheeler)
fires.fvc <- list(fvc_BC, fvc_HR, fvc_School, fvc_Egley, fvc_Easy, fvc_Flagtail, fvc_Calamity, fvc_Wheeler)
```

Extracting data, then removing non-forest pixels ('forest' is defined as >= 25% and veg. height >= 5m; but for wheeler point and hash rock, canopy cover for fuels (disturbance-corrected) is only in bins of 10% so used >= 20% in this case)

Random points
```{r}
for(i in 1:length(fires)){
  if(fires[i] %in% c('Wheeler', 'Hash Rock')){
    cc <- as.data.frame(extract(fires.cc[[i]], fires.rand.pts[[i]]))
    evh <- as.data.frame(extract(fires.evh[[i]], fires.rand.pts[[i]]))
    fvh <- as.data.frame(extract(fires.fvh[[i]], fires.rand.pts[[i]]))
    fvc <- as.data.frame(extract(fires.fvc[[i]], fires.rand.pts[[i]]))
    vals <- cbind(fires.r.vals[[i]], cc, evh, fvh, fvc)
    colnames(vals)[44:47] <- c('canopy_cover', 'veg_height', 'fuel_veg_height', 'fuel_cover')
    vals_forest <- vals %>% 
      filter(fuel_veg_height >= 607) %>%  # denoting forest height > 5m
      filter(fuel_cover %in% c(102, 103, 104, 105, 106, 107, 108, 109)) %>%  # canopy cover > 20% (!!)
      select(-fuel_cover, -fuel_veg_height) # so rbind works below
  }
  else{
    cc <- as.data.frame(extract(fires.cc[[i]], fires.rand.pts[[i]]))
    evh <- as.data.frame(extract(fires.evh[[i]], fires.rand.pts[[i]]))
    vals <- cbind(fires.r.vals[[i]], cc, evh)
    colnames(vals)[44:45] <- c('canopy_cover', 'veg_height')
    vals_forest <- vals %>% 
      filter(canopy_cover >= 25) %>% # canopy cover > 20%
      filter(veg_height %in% c(109, 110, 111, 112)) # forest height > 5m
  }
  assign(paste0('vals_R_', fires.abbrev[i]), vals_forest)
}

# merge the individual fires into one dataframe
vals_R_all_fires <- rbind(vals_R_BC, vals_R_HR, vals_R_School, vals_R_Egley, vals_R_Easy, vals_R_Flagtail, vals_R_Calamity, vals_R_Wheeler) %>% 
  select(-x.arr, -y.arr) %>%  # removing AEA coordinates
  mutate(Plot = NA) %>% 
  rename(Long = x.arr.1, Lat = y.arr.1)
```

Field Points
Not filtering, but adding canopy cover and EVH to dataset; note that wheeler point and hash rock fires are expected to have evh, canopy cover that may not align w/ definition of forest due to 2001 landfire data occurring post-fire
```{r}
for(i in 1:length(fires)){
  if(fires[i] %in% c('Wheeler', 'Hash Rock')){
    cc <- as.data.frame(extract(fires.cc[[i]], fires.field.pts[[i]]))
    evh <- as.data.frame(extract(fires.evh[[i]], fires.field.pts[[i]]))
    fvh <- as.data.frame(extract(fires.fvh[[i]], fires.field.pts[[i]]))
    fvc <- as.data.frame(extract(fires.fvc[[i]], fires.field.pts[[i]]))
    vals <- cbind(fires.field.vals[[i]], cc, evh, fvh, fvc)
    colnames(vals)[45:48] <- c('canopy_cover', 'veg_height', 'fuel_veg_height', 'fuel_cover')
    vals_forest <- vals %>% 
      select(-fuel_cover, -fuel_veg_height) # so rbind works below
  }
  else{
    cc <- as.data.frame(extract(fires.cc[[i]], fires.field.pts[[i]]))
    evh <- as.data.frame(extract(fires.evh[[i]], fires.field.pts[[i]]))
    vals <- cbind(fires.field.vals[[i]], cc, evh)
    colnames(vals)[45:46] <- c('canopy_cover', 'veg_height')
    vals_forest <- vals
  }
  assign(paste0('vals_', fires.abbrev[i]), vals_forest)
}
rm(cc, evh, vals, vals_forest, fvh, fvc)

vals_all_fires <- rbind(vals_BC, vals_HR, vals_School, vals_Egley, vals_Easy, vals_Flagtail,
                        vals_Calamity, vals_Wheeler) %>% 
  select(-Long.1, -Lat.1)
```

## Full Dataset
```{r}
# folding in the field data points
vals_enhanced_all_fires <- rbind(vals_all_fires, vals_R_all_fires)
```

Now, we'll follow the exact same protocol as above, but with the significantly larger dataset

# Climate and Topography Data
```{r}
fires.chili <- list(chili_BC, chili_HR, chili_School, chili_Egley, chili_Easy, chili_Flagtail, chili_Calamity, chili_Wheeler) # list of chili data

# Converting points from vals_enhanced_all_fires to spatial points dataframe to extract from rasters
xy <- vals_enhanced_all_fires[,c(1,2)] # define coordinates
all_pts <- vals_enhanced_all_fires %>%
  SpatialPointsDataFrame(coords = xy, proj4string = crs(ndvi_Egley)) # transform data to spatial points

for(i in 1:length(fires)){
  # chili
  chili <- projectRaster(from = fires.chili[[i]], to = fires.mtbs[[i]], method = 'ngb')
  chili_vals <- as.data.frame(extract(fires.chili[[i]], all_pts)) %>% # extracting chili data
    na.omit()
  colnames(chili_vals)[1] <- 'hli' # renaming column
  # cwd (present)
  cwd_pres <- projectRaster(from = cwd_present, to = fires.mtbs[[i]], method = 'ngb')
  cwd_pres_vals <- as.data.frame(extract(cwd_pres, all_pts)) %>% 
    na.omit()
  colnames(cwd_pres_vals)[1] <- 'cwd_present' # renaming column
  # cwd (future)
  cwd_fut <- projectRaster(from = cwd_future, to = fires.mtbs[[i]], method = 'ngb')
  cwd_fut_vals <- as.data.frame(extract(cwd_fut, all_pts)) %>% 
    na.omit()
  colnames(cwd_fut_vals)[1] <- 'cwd_future' # renaming column
  # elevation
  elev <- projectRaster(from = dem_clip2, to = fires.mtbs[[i]], method = 'ngb')
  elev_vals <- as.data.frame(extract(elev, all_pts)) %>% 
    na.omit()
  colnames(elev_vals)[1] <- 'elevation' # renaming column
  # combining w/ main df
  df <- vals_enhanced_all_fires %>% 
    filter(fire == fires.abbrev[i])
  df_clim <- cbind(df, chili_vals, cwd_pres_vals, cwd_fut_vals, elev_vals)
  assign(paste0('vals_clim_', fires.abbrev[i]), df_clim)
}
rm(df_clim, df, cwd_fut, cwd_fut_vals, cwd_pres, cwd_pres_vals, elev, elev_vals)

# merge the individual fires into one dataframe
vals_enhanced_all_fires <- rbind(vals_clim_BC, vals_clim_HR, vals_clim_School, vals_clim_Egley, vals_clim_Calamity, vals_clim_Flagtail, vals_clim_Easy, vals_clim_Wheeler)
```

## Defining Trailing Edge
According to Meigs et. al. 2023, use cwd to define trailing edge by doing the following
- calculating trailing edge of forest for a region
    - Region: Blue Mtns raster
    - Forest: using FVH, FVC so that it is robust to disturbances
- >95% current cwd is 'current trailing edge' and 'trailing edge threshold'
- looking at future cwd, >'trailing edge threshold' is 'future trailing edge'
```{r}
# Random buffered sample of points in blue mountains
index_xy = which(postfire.regen[] > 0)
xy_coord = coordinates(postfire.regen)
x_in_arr = xy_coord[index_xy, 1]
y_in_arr = xy_coord[index_xy, 2]
  
df <- sample_random_dist(x_in_arr, y_in_arr, 
                    num_points=50000, 
                    distance=0.003273548, seed=16)
xy <- df[,c(1,2)]
pts <- df %>% 
  SpatialPointsDataFrame(coords = xy, proj4string = crs(postfire.regen)) # transform data to spatial points

# Extract FVH, FVC data (2021 LANDFIRE)
fvh_blues <- projectRaster(from = fuel.veg.height, to = postfire.regen, method = 'ngb')
fvc_blues <- projectRaster(from = fuel.cover, to = postfire.regen, method = 'ngb')

fvh_blues_vals <- as.data.frame(extract(fvh_blues, pts))
colnames(fvh_blues_vals)[1] <- 'fvh'
fvc_blues_vals <- as.data.frame(extract(fvc_blues, pts))
colnames(fvc_blues_vals)[1] <- 'fvc'

# Extract cwd data (AdaptWest Climate NA)
cwd_pres_blues <- projectRaster(from = cwd_present, to = postfire.regen, method = 'ngb')
cwd_fut_blues <- projectRaster(from = cwd_future, to = postfire.regen, method = 'ngb')

cwd_pres_blues_vals <- as.data.frame(extract(cwd_pres_blues, pts))
colnames(cwd_pres_blues_vals)[1] <- 'cwd_pres'
cwd_fut_blues_vals <- as.data.frame(extract(cwd_fut_blues, pts))
colnames(cwd_fut_blues_vals)[1] <- 'cwd_fut'

# Combine dataset
TE_blues_df <- cbind(fvh_blues_vals, fvc_blues_vals, cwd_pres_blues_vals, cwd_fut_blues_vals, xy) %>% 
  na.omit()

# Calculate 95th percentile of cwd
TE_threshold <- quantile(TE_blues_df$cwd_pres, 0.95)
```

## Adding Trailing Edge to Dataset
```{r}
vals_enhanced_all_fires$TE_future <- ifelse(vals_enhanced_all_fires$cwd_future > TE_threshold, 'Y', 'N') # if cwd (future) is greater than TE threshold identified above, then 'Y' it is in the trailing edge

vals_enhanced_all_fires$TE_present <- ifelse(vals_enhanced_all_fires$cwd_present > TE_threshold, 'Y', 'N') # if cwd (future) is greater than TE threshold identified above, then 'Y' it is in the trailing edge
```

# Relative Year
```{r}
long.ndvi.df <- vals_enhanced_all_fires %>% 
  unite('x_y', c(Long, Lat), sep = '_', remove = F) %>% 
  pivot_longer(cols = !c(x_y, Long, Lat, Plot, fire, hli, canopy_cover, veg_height, cwd_present, cwd_future, TE_present, TE_future, elevation), names_to = 'year', values_to = 'ndvi') %>% 
  mutate(year = str_sub(year, 2)) %>% 
  mutate(year = as.numeric(year)) %>% 
  mutate(ndvi = as.numeric(ndvi)) %>% 
  mutate(relative_year = case_when( # Making column so that year = 10 is the year following the major dip in NDVI for every fire (note: changed from previously having year = 10 as year of fire; may change back...)
    fire == 'BC' ~ year - 1992, # BC complex fire occurred in 2001, dip in year after fire
    fire == 'HR' ~ year - 1991, # HR fire: 2000, dip in year after fire
    fire == 'School' ~ year - 1996, # School fire: 2005, dip in year after fire
    fire == 'Egley' ~ year - 1997, # Egley complex fire occurred in 2007, dip in year of fire
    fire == 'Easy' ~ year - 1993, # Easy fire: 2002, dip in year after fire
    fire == 'Calamity' ~ year - 1997, # Calamity complex fire: 2007, dip in year of fire
    fire == 'Flagtail' ~ year - 1992, # Flagtail fire: 2002, dip in year of fire
    fire == 'Wheeler' ~ year - 1987 # Wheeler Point fire: 1996, dip in year after fire
  )) %>% 
  drop_na(ndvi) # since there must be some issues w/ NDVI datasets (hopefully this isn't issue of coordinate system)
```

# Yearly Climate Data (PRISM)
To downloading PRISM climate data
(unhash everything if need to download on local drive)
```{r}
yrs <- c(1984:2021)
prism_clim_vars <- c('ppt', 'tmin', 'tmax', 'vpdmin', 'vpdmax')

#for(i in 1:length(prism_clim_vars)){
#prism_set_dl_dir(paste0("/Volumes/Meddens/GitHub Repo/nwcasc-postfire-recovery/data/climate/PRISM/", prism_clim_vars[i]))
#get_prism_annual(type = prism_clim_vars[i], years = yrs, keepZip = FALSE) # unhash when need to get the data (if deleted off of local env.)
#}
```

```{r}
# holding lists for rasters
ppt_prism_list <- list()
tmin_prism_list <- list()
tmax_prism_list <- list()
vpdmin_prism_list <- list()
vpdmax_prism_list <- list()
prism_list <- list(ppt_prism_list, tmin_prism_list, tmax_prism_list, vpdmin_prism_list, vpdmax_prism_list)

# holding lists for dataframes
ppt_prism_df_list <- list()
tmin_prism_df_list <- list()
tmax_prism_df_list <- list()
vpdmin_prism_df_list <- list()
vpdmax_prism_df_list <- list()
prism_df_list <- list(ppt_prism_df_list, tmin_prism_df_list, tmax_prism_df_list, vpdmin_prism_df_list, vpdmax_prism_df_list)

for(i in 1:length(prism_clim_vars)){
# first, setting the directory to the climate variable (and reiterating for all climate variables)
prism_set_dl_dir(paste0("/Volumes/Meddens/GitHub Repo/nwcasc-postfire-recovery/data/climate/PRISM/", prism_clim_vars[i]))
prism.files <- prism_archive_ls()
for(j in 1:length(yrs)){
# next, saving raster w/ correct crs into prism_list
 RS <- pd_stack(prism_archive_ls()[j]) 
 RS <- projectRaster(RS, crs = crs(Egley_mtbs))
 prism_list[[i]][[j]] <- RS
# now, extracting data from rasters from appropriate years and saving into a dataframe  
  df <- long.ndvi.df %>% 
    filter(year == yrs[j])
  xy <- df[,c(2,3)] # define coordinates
  pts <- df %>% 
    select(Long, Lat) %>% 
    SpatialPointsDataFrame(coords = xy, proj4string = crs(ndvi_Egley)) # transform data to spatial points
  vals <- as.data.frame(extract(prism_list[[i]][[j]], pts))
  colnames(vals)[1] <- prism_clim_vars[i]
  coords <- as.data.frame(pts) # add x and y coordinates to ndvi values dataframes
  vals <- cbind(coords, vals) %>% 
    select(-Long.1, -Lat.1) %>% 
    mutate(year = yrs[j])
  prism_df_list[[i]][[j]] <- vals
}}
rm(coords, vals, pts, xy, df, RS)

# Adding PRISM data to main dataset
ppt_df_yearly <- do.call('rbind', prism_df_list[[1]]) %>% 
  unite(x_y, Long, Lat, remove = T)
tmin_df_yearly <- do.call('rbind', prism_df_list[[2]]) %>% 
  select(tmin)
tmax_df_yearly <- do.call('rbind', prism_df_list[[3]]) %>% 
  select(tmax)
vpdmin_df_yearly <- do.call('rbind', prism_df_list[[4]]) %>% 
  select(vpdmin)
vpdmax_df_yearly <- do.call('rbind', prism_df_list[[5]]) %>% 
  select(vpdmax)
prism_df_yearly <- do.call('cbind', list(ppt_df_yearly, tmin_df_yearly, tmax_df_yearly,
                                         vpdmin_df_yearly, vpdmax_df_yearly)) # will add this data to long.df at the very end of the script!
```

# Combining Datasets
```{r}
wide.df <- long.ndvi.df %>% 
  filter(relative_year >= 0 & relative_year <= 23) %>% 
  select(-year) %>%
  distinct(x_y, Long, Lat, Plot, fire, hli, canopy_cover, veg_height, relative_year, cwd_present, cwd_future, TE_present, TE_future, elevation, .keep_all = T) %>% # getting rid of any duplicates
  pivot_wider(names_from = relative_year, values_from = ndvi)
# Hmmmmmm, the NDVI NA's dropped ~775 datapoints! That is not trivial...

wide.df <- wide.df %>% 
  mutate(predisturbance_ndvi = (`0` + `1` + `2` + `3` + `4` + `5` + `6` + `7` + `8` + `9`)/10) %>%  # Average ndvi for ten years pre-fire
  mutate(postdisturbance_ndvi = (`11` + `12` + `13` + `14` + `15` + `16` + `17` + `18` + `19` + `20`)/10) %>%  # Average ndvi for ten years post-fire
  mutate(disturbance_ndvi = (`10`+`11`)/2) %>% 
  mutate(delta_ndvi = postdisturbance_ndvi - predisturbance_ndvi) # Avg postdisturbance ndvi minus avg predisturbance ndvi
```

# Burn Severity (dNDVI)
For fire severity, we calculated difference in NDVI and then used 0.66 times the predisturbance NDVI average to calculate 'high severity burn'. We need to decide what threshold makes sense for us to use. This also coincides with how we calculated relative year above, as some of the fires had some points that were split between having the major dip in NDVI during the year of fire and the year after fire; this major dip is what we're interested in and I suspect is the reason why a lot of the ~100 points removed from the below step were removed
```{r}
wide.df <- wide.df %>% 
  mutate(dndvi = `9`-`10`) %>% 
  filter(dndvi > ifelse(is.na(Plot), 0.66*predisturbance_ndvi, -9999)) # Checked field data already, so not running this test on field data
```

# Eliminating Duplicate Points
For some reason CA-3-2 has two points in the wide.df. Fixing that here.
```{r}
wide.df.elimNA <- wide.df %>% 
  filter(is.na(Plot))

wide.df.elim1 <- wide.df %>% 
  filter(Plot != 'CA-3-2')

wide.df.elim2 <- wide.df %>% 
  filter(Plot == 'CA-3-2')
wide.df.elim2 <- wide.df.elim2[1,] # only selecting first row

wide.df <- rbind(wide.df.elimNA, wide.df.elim1, wide.df.elim2)
rm(wide.df.elimNA, wide.df.elim1, wide.df.elim2)
```

Lengthening dataset
```{r}
long.df <- wide.df %>% 
  pivot_longer(cols = !c(x_y, Long, Lat, Plot, hli, canopy_cover, veg_height, fire, predisturbance_ndvi, postdisturbance_ndvi, disturbance_ndvi, delta_ndvi, dndvi, cwd_present, cwd_future, TE_present, TE_future, elevation), names_to = 'relative_year', values_to = 'ndvi') %>% 
  mutate(relative_year = as.numeric(relative_year)) %>% 
  unite('x_y', c(Long, Lat), sep = '_', remove = F)
```

# Recovery Metrics
## Absolute, Relative Regrowth (Fitted)
```{r}
summary(long.df)
# Getting fitted values for ndvi, using Loess model with smoothing span of 0.5
models <- long.df %>%  
        tidyr::nest(-x_y) %>%
        mutate(m = purrr::map(data, loess,
                           formula = ndvi ~ relative_year, span = .5),  # Perform loess calculation on each sample
              ndvi_fitted = purrr::map(m, `[[`, "fitted")) # Retrieve the fitted values from each model

# Apply fitted y's as a new column
long.df <- models %>%
        select(-m) %>%
        tidyr::unnest()

# Getting correctly calculated absolute regrowth and relative regrowth metrics calculated
wide.fitted.df <- long.df %>% 
  select(x_y, Long, Lat, relative_year, ndvi_fitted) %>% 
  pivot_wider(names_from = relative_year, values_from = ndvi_fitted)
wide.fitted.df <- wide.fitted.df %>% 
  mutate(absolute_regrowth = `15` - `10`) %>%  # From White et al 2017
  mutate(relative_regrowth = absolute_regrowth/(`9`-`10`))  # From White et al 2017
wide.df$absolute_regrowth <- wide.fitted.df$absolute_regrowth
wide.df$relative_regrowth <- wide.fitted.df$relative_regrowth
```

## Time to Recovery
```{r}
wide.df$max.postfire.ndvi <- wide.df %>% 
  select(`11`, `12`, `13`, `14`, `15`, `16`, `17`, `18`, `19`, `20`, `21`, `22`, `23`) %>% 
  apply(1, max, na.rm=TRUE)

wide.df <- wide.df %>% 
  mutate(pct_recovery = max.postfire.ndvi/predisturbance_ndvi) %>% 
  mutate(time_to_0.8recovery = NA) %>% 
  mutate(time_to_0.8recovery = case_when(`11` >= 0.8*predisturbance_ndvi ~ 1,
         `12` >= 0.8*predisturbance_ndvi & is.na(time_to_0.8recovery) ~ 2,
         `13` >= 0.8*predisturbance_ndvi & is.na(time_to_0.8recovery) ~ 3,
         `14` >= 0.8*predisturbance_ndvi & is.na(time_to_0.8recovery) ~ 4,
         `15` >= 0.8*predisturbance_ndvi & is.na(time_to_0.8recovery) ~ 5,
         `16` >= 0.8*predisturbance_ndvi & is.na(time_to_0.8recovery) ~ 6,
         `17` >= 0.8*predisturbance_ndvi & is.na(time_to_0.8recovery) ~ 7,
         `18` >= 0.8*predisturbance_ndvi & is.na(time_to_0.8recovery) ~ 8,
         `19` >= 0.8*predisturbance_ndvi & is.na(time_to_0.8recovery) ~ 9,
         `20` >= 0.8*predisturbance_ndvi & is.na(time_to_0.8recovery) ~ 10,
         `21` >= 0.8*predisturbance_ndvi & is.na(time_to_0.8recovery) ~ 11,
         `22` >= 0.8*predisturbance_ndvi & is.na(time_to_0.8recovery) ~ 12,
         `23` >= 0.8*predisturbance_ndvi & is.na(time_to_0.8recovery) ~ 13)) %>% 
  mutate(time_to_0.6recovery = NA) %>% 
  mutate(time_to_0.6recovery = case_when(`11` >= 0.6*predisturbance_ndvi ~ 1,
         `12` >= 0.6*predisturbance_ndvi & is.na(time_to_0.6recovery) ~ 2,
         `13` >= 0.6*predisturbance_ndvi & is.na(time_to_0.6recovery) ~ 3,
         `14` >= 0.6*predisturbance_ndvi & is.na(time_to_0.6recovery) ~ 4,
         `15` >= 0.6*predisturbance_ndvi & is.na(time_to_0.6recovery) ~ 5,
         `16` >= 0.6*predisturbance_ndvi & is.na(time_to_0.6recovery) ~ 6,
         `17` >= 0.6*predisturbance_ndvi & is.na(time_to_0.6recovery) ~ 7,
         `18` >= 0.6*predisturbance_ndvi & is.na(time_to_0.6recovery) ~ 8,
         `19` >= 0.6*predisturbance_ndvi & is.na(time_to_0.6recovery) ~ 9,
         `20` >= 0.6*predisturbance_ndvi & is.na(time_to_0.6recovery) ~ 10,
         `21` >= 0.6*predisturbance_ndvi & is.na(time_to_0.6recovery) ~ 11,
         `22` >= 0.6*predisturbance_ndvi & is.na(time_to_0.6recovery) ~ 12,
         `23` >= 0.6*predisturbance_ndvi & is.na(time_to_0.6recovery) ~ 13))
```

## Using Fitted Lines
```{r}
postfire.long.df <- long.df %>% 
  filter(relative_year > 10)
prefire.long.df <- long.df %>% 
  filter(relative_year < 11) %>% 
  mutate(postfire_fitted_slope = NA) %>% 
  mutate(postfire_fitted_rsq = NA) %>% 
  select(postfire_fitted_rsq, postfire_fitted_slope, x_y, relative_year)

fitted_postfire_model <- postfire.long.df %>%
  group_by(x_y) %>%
  do(model = lm(ndvi ~ relative_year, data = .))

fitted_postfire_model <- fitted_postfire_model %>% 
  mutate(postfire_fitted_slope = NA) %>% 
  mutate(postfire_fitted_rsq = NA) # Holding columns

for(i in 1:nrow(fitted_postfire_model)){
fitted_postfire_model$postfire_fitted_slope[i] <- fitted_postfire_model[[2]][[i]]$coefficients[2]
fitted_postfire_model$postfire_fitted_rsq[i] <- summary(fitted_postfire_model[[2]][[i]])$r.squared
}

fitted_postfire_model <- fitted_postfire_model %>% 
  select(-model)

postfire.long.df <- merge(fitted_postfire_model, postfire.long.df, by = 'x_y')

# Folding in new variables into long.df 
postfire.long.df <- postfire.long.df %>% 
  select(postfire_fitted_rsq, postfire_fitted_slope, x_y, relative_year)
long.df.fitted.vals <- rbind(prefire.long.df, postfire.long.df)
long.df <- merge(long.df, long.df.fitted.vals, by = c('x_y', 'relative_year'))

# Decluttering environment
rm(long.df.fitted.vals, fitted_postfire_model)
```

## Delta NDVI
```{r}
long.df <- long.df %>% 
  mutate(yearly_delta_ndvi = ndvi - predisturbance_ndvi)

long.df.avg <- long.df %>% 
  group_by(relative_year) %>% 
  summarise(avg_ndvi = mean(ndvi), avg_delta_ndvi = mean(yearly_delta_ndvi))

# averages by fire
long.df.fires.avg <- long.df %>% 
  group_by(relative_year, fire) %>% 
  summarise(avg_ndvi = mean(ndvi), avg_delta_ndvi = mean(yearly_delta_ndvi))

# AREA UNDER CURVE
auc <- function(y){
  n <- length(y)
  0.5*(y[1]+y[n]+2*sum(y[-c(1,n)]))
}
long.df <- long.df %>% 
  group_by(x_y) %>% 
  mutate(auc_delta_ndvi = auc(yearly_delta_ndvi))
```

## Scaled Recovery Metric, RdNDVI
```{r}
long.df <- long.df %>% 
  mutate(scaled_recovery_metric = (ndvi - disturbance_ndvi)/(predisturbance_ndvi - disturbance_ndvi)) %>% 
  mutate(RdNDVI = (predisturbance_ndvi - ndvi)/(sqrt(abs(predisturbance_ndvi/1000))))
```

# Data Cleaning: Yearly Climate Data
```{r}
# adding yearly PRISM climate data to long.df
prism.merge.df <- merge(long.ndvi.df, prism_df_yearly, by = c('x_y', 'year')) %>% 
  select(relative_year, x_y, ppt, tmin, tmax, vpdmin, vpdmax) %>% 
  mutate(tmean = (tmin + tmax)/2)
long.df.prism <- merge(long.df, prism.merge.df, by = c('x_y', 'relative_year'))

# adding 0-5 year post-fire climate variables to wide dataset
wide.df.prism <- long.df.prism %>% 
  filter(relative_year > 10 & relative_year < 16) %>% 
  group_by(x_y) %>% 
  summarise(postfire_ppt = mean(ppt), postfire_tmin = mean(tmin), postfire_tmax = mean(tmax),
            postfire_vpdmin = mean(vpdmin), postfire_vpdmax = mean(vpdmax), postfire_tmean = mean(tmean))
wide.df <- merge(wide.df, wide.df.prism, by = 'x_y')
```

# Final Data Cleaning
Some plots have missing data (FL-1-X), while others have outliers in spectral recovery metrics (EG-9-2 has outlier in pct_recovery and WH-3-3 has outlier in relative regrowth)
```{r}
field.data.both <- field.data.both %>% 
  filter(Fire != 'Tower') %>% 
  filter(Plot != 'FL-1-X') %>% 
  filter(Plot != 'EG-9-2') %>% 
  filter(Plot != 'WH-3-3') %>% 
  mutate(aspect = (0.0174533-cos(0.0174533*(aspect-45)))/2) # converting aspect into radians and then cosine transform equation to convert into more of a heat load index equation

# removing duplicated CA-3-2 values
long.df.prism.elimNA <- long.df.prism %>% 
  filter(is.na(Plot))

long.df.prism.elim1 <- long.df.prism %>% 
  filter(Plot != 'CA-3-2')

long.df.prism.elim2 <- long.df.prism %>% 
  filter(Plot == 'CA-3-2') %>% 
  distinct() # removing duplicates

long.df.prism <- rbind(long.df.prism.elimNA, long.df.prism.elim1, long.df.prism.elim2)
rm(long.df.prism.elimNA, long.df.prism.elim1, long.df.prism.elim2)

wide.df.plots <- wide.df %>% 
  filter(Plot != 'FL-1-X') %>% 
  filter(Plot != 'EG-9-2') %>% 
  filter(Plot != 'WH-3-3')
wide.df.noplots <- wide.df %>% 
  filter(is.na(Plot))
wide.df <- rbind(wide.df.plots, wide.df.noplots)


long.df.prism.plots <- long.df.prism %>% 
  filter(Plot != 'FL-1-X') %>% 
  filter(Plot != 'EG-9-2') %>% 
  filter(Plot != 'WH-3-3')
long.df.prism.noplots <- long.df.prism %>% 
  filter(is.na(Plot))
long.df.prism <- rbind(long.df.prism.plots, long.df.prism.noplots)
```

# Saving Datasets
```{r}
write.csv(wide.df, file = here('data', 'processed_data', 'NDVI', 'wide.df.csv'))
write.csv(long.df.prism, file = here('data', 'processed_data', 'NDVI', 'long.df.csv'))
write.csv(field.data.both, file = here('data', 'processed_data', 'NDVI', 'field.data.both.csv'))
```
